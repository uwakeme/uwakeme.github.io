---
title: ã€å­¦ä¹ ã€‘å®¹å™¨ç¼–æ’è¯¦è§£ï¼šä»åŸºç¡€æ¦‚å¿µåˆ°å·¥å…·å¯¹æ¯”çš„å®Œæ•´æŒ‡å—
categories: å­¦ä¹ 
date: 2025-08-14
tags:
  - å®¹å™¨ç¼–æ’
  - Kubernetes
  - Docker Swarm
  - å¾®æœåŠ¡
  - äº‘åŸç”Ÿ
series: å®¹å™¨æŠ€æœ¯ç³»åˆ—
---

{% series å®¹å™¨æŠ€æœ¯ç³»åˆ— %}

> **æ‘˜è¦**ï¼šæœ¬æ–‡æ·±å…¥æ¢è®¨å®¹å™¨ç¼–æ’æŠ€æœ¯ï¼Œä»åŸºç¡€æ¦‚å¿µåˆ°ä¸»æµå·¥å…·å¯¹æ¯”ï¼Œæ¶µç›–Kubernetesã€Docker Swarmã€Apache Mesosç­‰å¹³å°çš„ç‰¹æ€§åˆ†æå’Œå®æˆ˜æ¡ˆä¾‹ã€‚é€šè¿‡è¯¦ç»†çš„æŠ€æœ¯è§£æå’Œå®ç”¨çš„éƒ¨ç½²ç¤ºä¾‹ï¼Œå¸®åŠ©è¯»è€…å…¨é¢ç†è§£å®¹å™¨ç¼–æ’çš„æ ¸å¿ƒä»·å€¼å’Œåº”ç”¨åœºæ™¯ï¼Œä¸ºæŠ€æœ¯é€‰å‹æä¾›ç§‘å­¦ä¾æ®ã€‚



## ğŸ“‹ æ–‡ç« å¯¼è§ˆ

- **åŸºç¡€ç¯‡**ï¼šå®¹å™¨ç¼–æ’æ¦‚å¿µã€æ ¸å¿ƒåŠŸèƒ½ã€æŠ€æœ¯åŸç†
- **å·¥å…·ç¯‡**ï¼šKubernetesã€Docker Swarmã€Apache Mesosç­‰ä¸»æµå·¥å…·è¯¦è§£
- **å¯¹æ¯”ç¯‡**ï¼šå¤šç»´åº¦å·¥å…·å¯¹æ¯”åˆ†æï¼Œé€‰å‹æŒ‡å—
- **å®æˆ˜ç¯‡**ï¼šå¾®æœåŠ¡åº”ç”¨éƒ¨ç½²æ¡ˆä¾‹ï¼Œæœ€ä½³å®è·µ
- **è¿›é˜¶ç¯‡**ï¼šæ€§èƒ½ä¼˜åŒ–ã€å®‰å…¨é…ç½®ã€ç›‘æ§æ–¹æ¡ˆ

# ä¸€ã€å®¹å™¨ç¼–æ’åŸºç¡€æ¦‚å¿µ

## ï¼ˆä¸€ï¼‰ä»€ä¹ˆæ˜¯å®¹å™¨ç¼–æ’

å®¹å™¨ç¼–æ’ï¼ˆContainer Orchestrationï¼‰æ˜¯ä¸€ç§è‡ªåŠ¨åŒ–ç®¡ç†å®¹å™¨åŒ–åº”ç”¨ç¨‹åºçš„æŠ€æœ¯ï¼Œå®ƒæ¶‰åŠåœ¨å¤§è§„æ¨¡çš„åˆ†å¸ƒå¼ç³»ç»Ÿä¸­éƒ¨ç½²ã€ç®¡ç†ã€æ‰©å±•å’Œåè°ƒå®¹å™¨çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸã€‚ç®€å•æ¥è¯´ï¼Œå®¹å™¨ç¼–æ’å°±æ˜¯è®©å¤šä¸ªå®¹å™¨ååŒå·¥ä½œï¼Œå°±åƒæŒ‡æŒ¥å®¶æŒ‡æŒ¥ä¹å›¢æ¼”å¥ä¸€æ ·ã€‚

> ğŸ’¡ **æŠ€æœ¯èƒŒæ™¯**ï¼šæ ¹æ®CNCFçš„è°ƒæŸ¥æŠ¥å‘Š[^1]ï¼Œè¶…è¿‡90%çš„ç»„ç»‡åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨å®¹å™¨æŠ€æœ¯ï¼Œå…¶ä¸­84%çš„ç»„ç»‡ä½¿ç”¨å®¹å™¨ç¼–æ’å·¥å…·æ¥ç®¡ç†å®¹å™¨åŒ–åº”ç”¨ã€‚

åœ¨ç°ä»£å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œä¸€ä¸ªåº”ç”¨å¯èƒ½ç”±æ•°åç”šè‡³æ•°ç™¾ä¸ªå®¹å™¨ç»„æˆï¼Œæ‰‹åŠ¨ç®¡ç†è¿™äº›å®¹å™¨æ˜¾ç„¶æ˜¯ä¸ç°å®çš„ã€‚å®¹å™¨ç¼–æ’å·¥å…·åº”è¿è€Œç”Ÿï¼Œå®ƒä»¬èƒ½å¤Ÿè‡ªåŠ¨åŒ–å¤„ç†å®¹å™¨çš„éƒ¨ç½²ã€æ‰©å±•ã€ç½‘ç»œé…ç½®ã€è´Ÿè½½å‡è¡¡ã€æ•…éšœæ¢å¤ç­‰å¤æ‚ä»»åŠ¡ã€‚

## ï¼ˆäºŒï¼‰ä¸ºä»€ä¹ˆéœ€è¦å®¹å™¨ç¼–æ’

éšç€å®¹å™¨æŠ€æœ¯çš„æ™®åŠå’Œå¾®æœåŠ¡æ¶æ„çš„å…´èµ·ï¼Œä¼ ç»Ÿçš„å•ä½“åº”ç”¨è¢«æ‹†åˆ†æˆå¤šä¸ªç‹¬ç«‹çš„æœåŠ¡ï¼Œæ¯ä¸ªæœåŠ¡è¿è¡Œåœ¨è‡ªå·±çš„å®¹å™¨ä¸­ã€‚è¿™ç§æ¶æ„å¸¦æ¥äº†è¯¸å¤šå¥½å¤„ï¼Œä½†ä¹Ÿå¼•å…¥äº†æ–°çš„æŒ‘æˆ˜ï¼š

1. **æœåŠ¡å‘ç°ä¸é€šä¿¡**ï¼šå®¹å™¨ä¹‹é—´éœ€è¦ç›¸äº’å‘ç°å’Œé€šä¿¡ï¼ŒIPåœ°å€å¯èƒ½åŠ¨æ€å˜åŒ–
2. **è´Ÿè½½å‡è¡¡**ï¼šéœ€è¦å°†è¯·æ±‚åˆç†åˆ†å‘åˆ°å¤šä¸ªå®¹å™¨å®ä¾‹
3. **è‡ªåŠ¨æ‰©ç¼©å®¹**ï¼šæ ¹æ®è´Ÿè½½æƒ…å†µè‡ªåŠ¨å¢å‡å®¹å™¨æ•°é‡
4. **æ•…éšœæ¢å¤**ï¼šå½“å®¹å™¨å‡ºç°æ•…éšœæ—¶è‡ªåŠ¨é‡å¯æˆ–æ›¿æ¢
5. **é…ç½®ç®¡ç†**ï¼šç»Ÿä¸€ç®¡ç†å®¹å™¨çš„é…ç½®ä¿¡æ¯
6. **èµ„æºè°ƒåº¦**ï¼šåœ¨é›†ç¾¤ä¸­åˆç†åˆ†é…è®¡ç®—èµ„æº

## ï¼ˆä¸‰ï¼‰å®¹å™¨ç¼–æ’çš„æ ¸å¿ƒåŠŸèƒ½

å®¹å™¨ç¼–æ’ç³»ç»Ÿé€šå¸¸æä¾›ä»¥ä¸‹æ ¸å¿ƒåŠŸèƒ½ï¼š

### 1. è‡ªåŠ¨åŒ–éƒ¨ç½²
- **å£°æ˜å¼é…ç½®**ï¼šé€šè¿‡é…ç½®æ–‡ä»¶æè¿°æœŸæœ›çŠ¶æ€ï¼Œç³»ç»Ÿè‡ªåŠ¨å®ç°
- **æ»šåŠ¨æ›´æ–°**ï¼šæ— åœæœºæ—¶é—´åœ°æ›´æ–°åº”ç”¨ç‰ˆæœ¬
- **å›æ»šæœºåˆ¶**ï¼šå¿«é€Ÿå›é€€åˆ°ä¹‹å‰çš„ç¨³å®šç‰ˆæœ¬

### 2. æœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡
- **DNSæœåŠ¡å‘ç°**ï¼šä¸ºæœåŠ¡æä¾›ç¨³å®šçš„åŸŸåè§£æ
- **å¥åº·æ£€æŸ¥**ï¼šç›‘æ§æœåŠ¡å¥åº·çŠ¶æ€ï¼Œè‡ªåŠ¨å‰”é™¤æ•…éšœå®ä¾‹
- **æµé‡åˆ†å‘**ï¼šæ™ºèƒ½åˆ†å‘è¯·æ±‚åˆ°å¥åº·çš„æœåŠ¡å®ä¾‹

### 3. è‡ªåŠ¨æ‰©ç¼©å®¹
- **æ°´å¹³æ‰©å±•**ï¼šæ ¹æ®CPUã€å†…å­˜ä½¿ç”¨ç‡è‡ªåŠ¨å¢å‡å®ä¾‹
- **å‚ç›´æ‰©å±•**ï¼šåŠ¨æ€è°ƒæ•´å•ä¸ªå®¹å™¨çš„èµ„æºé…é¢
- **é¢„æµ‹æ€§æ‰©å±•**ï¼šåŸºäºå†å²æ•°æ®é¢„æµ‹è´Ÿè½½å˜åŒ–

### 4. å­˜å‚¨ç¼–æ’
- **æŒä¹…åŒ–å­˜å‚¨**ï¼šä¸ºæœ‰çŠ¶æ€åº”ç”¨æä¾›æ•°æ®æŒä¹…åŒ–
- **å­˜å‚¨ç±»**ï¼šå®šä¹‰ä¸åŒæ€§èƒ½ç­‰çº§çš„å­˜å‚¨èµ„æº
- **åŠ¨æ€ä¾›åº”**ï¼šæŒ‰éœ€åˆ›å»ºå­˜å‚¨å·

### 5. ç½‘ç»œç®¡ç†
- **è™šæ‹Ÿç½‘ç»œ**ï¼šä¸ºå®¹å™¨æä¾›éš”ç¦»çš„ç½‘ç»œç¯å¢ƒ
- **ç½‘ç»œç­–ç•¥**ï¼šå®šä¹‰å®¹å™¨é—´çš„é€šä¿¡è§„åˆ™
- **æœåŠ¡ç½‘æ ¼**ï¼šæä¾›é«˜çº§çš„æµé‡ç®¡ç†å’Œå®‰å…¨åŠŸèƒ½

# äºŒã€ä¸»æµå®¹å™¨ç¼–æ’å·¥å…·è¯¦è§£

## ï¼ˆä¸€ï¼‰Kubernetesï¼šå®¹å™¨ç¼–æ’çš„ç‹è€…

### åŸºæœ¬ä»‹ç»

Kubernetesï¼ˆç®€ç§°K8sï¼‰æ˜¯ç”±Googleå¼€æºçš„å®¹å™¨ç¼–æ’å¹³å°ï¼Œç°åœ¨ç”±äº‘åŸç”Ÿè®¡ç®—åŸºé‡‘ä¼šï¼ˆCNCFï¼‰ç»´æŠ¤ã€‚å®ƒå·²ç»æˆä¸ºå®¹å™¨ç¼–æ’é¢†åŸŸçš„äº‹å®æ ‡å‡†ï¼Œè¢«å¹¿æ³›åº”ç”¨äºç”Ÿäº§ç¯å¢ƒã€‚

### æ ¸å¿ƒæ¶æ„

Kubernetesé‡‡ç”¨ä¸»ä»æ¶æ„ï¼ˆMaster-Workerï¼‰ï¼Œä¸»è¦ç»„ä»¶åŒ…æ‹¬ï¼š

```yaml
# Kubernetesé›†ç¾¤æ¶æ„ç¤ºä¾‹
apiVersion: v1
kind: Namespace
metadata:
  name: production
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: web-app
  namespace: production
spec:
  replicas: 3  # è¿è¡Œ3ä¸ªå‰¯æœ¬
  selector:
    matchLabels:
      app: web-app
  template:
    metadata:
      labels:
        app: web-app
    spec:
      containers:
      - name: nginx
        image: nginx:1.21
        ports:
        - containerPort: 80
        resources:
          requests:
            memory: "64Mi"
            cpu: "250m"
          limits:
            memory: "128Mi"
            cpu: "500m"
```

### ä¸»è¦ä¼˜åŠ¿

1. **å¼ºå¤§çš„ç”Ÿæ€ç³»ç»Ÿ**ï¼šæ‹¥æœ‰åºå¤§çš„ç¤¾åŒºå’Œä¸°å¯Œçš„æ’ä»¶
2. **é«˜åº¦å¯æ‰©å±•**ï¼šæ”¯æŒæ•°åƒèŠ‚ç‚¹çš„å¤§è§„æ¨¡é›†ç¾¤
3. **å£°æ˜å¼API**ï¼šé€šè¿‡YAMLæ–‡ä»¶æè¿°æœŸæœ›çŠ¶æ€
4. **è‡ªæ„ˆèƒ½åŠ›**ï¼šè‡ªåŠ¨æ£€æµ‹å’Œä¿®å¤æ•…éšœ
5. **å¤šäº‘æ”¯æŒ**ï¼šå¯åœ¨å„ç§äº‘å¹³å°å’Œæœ¬åœ°ç¯å¢ƒè¿è¡Œ

### é€‚ç”¨åœºæ™¯

- å¤§è§„æ¨¡å¾®æœåŠ¡åº”ç”¨
- éœ€è¦é«˜å¯ç”¨æ€§çš„ä¼ä¸šçº§åº”ç”¨
- å¤šäº‘æˆ–æ··åˆäº‘ç¯å¢ƒ
- å¤æ‚çš„CI/CDæµæ°´çº¿

## ï¼ˆäºŒï¼‰Docker Swarmï¼šç®€å•æ˜“ç”¨çš„åŸç”Ÿæ–¹æ¡ˆ

### åŸºæœ¬ä»‹ç»

Docker Swarmæ˜¯Dockerå…¬å¸å¼€å‘çš„åŸç”Ÿå®¹å™¨ç¼–æ’å·¥å…·ï¼Œå®ƒå°†å¤šä¸ªDockerä¸»æœºç»„åˆæˆä¸€ä¸ªè™šæ‹Ÿçš„Dockerä¸»æœºã€‚Swarmçš„è®¾è®¡ç†å¿µæ˜¯ç®€å•æ˜“ç”¨ï¼Œç‰¹åˆ«é€‚åˆå·²ç»ç†Ÿæ‚‰Dockerçš„å›¢é˜Ÿã€‚

### æ ¸å¿ƒç‰¹æ€§

```yaml
# Docker Composeæ–‡ä»¶ç¤ºä¾‹ï¼ˆç”¨äºSwarméƒ¨ç½²ï¼‰
version: '3.8'
services:
  web:
    image: nginx:latest
    ports:
      - "80:80"
    deploy:
      replicas: 3  # éƒ¨ç½²3ä¸ªå‰¯æœ¬
      update_config:
        parallelism: 1  # æ¯æ¬¡æ›´æ–°1ä¸ªå®ä¾‹
        delay: 10s      # æ›´æ–°é—´éš”10ç§’
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
    networks:
      - webnet

  redis:
    image: redis:alpine
    deploy:
      replicas: 1
    networks:
      - webnet

networks:
  webnet:
    driver: overlay  # ä½¿ç”¨overlayç½‘ç»œé©±åŠ¨
```

### ä¸»è¦ä¼˜åŠ¿

1. **å­¦ä¹ æˆæœ¬ä½**ï¼šåŸºäºç†Ÿæ‚‰çš„Dockerå‘½ä»¤å’Œæ¦‚å¿µ
2. **éƒ¨ç½²ç®€å•**ï¼šå‡ æ¡å‘½ä»¤å³å¯æ­å»ºé›†ç¾¤
3. **åŸç”Ÿé›†æˆ**ï¼šä¸Dockerç”Ÿæ€ç³»ç»Ÿæ— ç¼é›†æˆ
4. **å†…ç½®å®‰å…¨**ï¼šé»˜è®¤å¯ç”¨TLSåŠ å¯†
5. **è½»é‡çº§**ï¼šèµ„æºæ¶ˆè€—ç›¸å¯¹è¾ƒå°‘

### é€‚ç”¨åœºæ™¯

- ä¸­å°å‹åº”ç”¨éƒ¨ç½²
- DockeræŠ€æœ¯æ ˆå›¢é˜Ÿ
- å¿«é€ŸåŸå‹å¼€å‘
- è¾¹ç¼˜è®¡ç®—åœºæ™¯

## ï¼ˆä¸‰ï¼‰Apache Mesosï¼šåˆ†å¸ƒå¼ç³»ç»Ÿå†…æ ¸

### åŸºæœ¬ä»‹ç»

Apache Mesosæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿå†…æ ¸ï¼Œå®ƒæŠ½è±¡äº†CPUã€å†…å­˜ã€å­˜å‚¨ç­‰è®¡ç®—èµ„æºï¼Œä½¿åˆ†å¸ƒå¼åº”ç”¨èƒ½å¤Ÿé«˜æ•ˆåœ°å…±äº«é›†ç¾¤èµ„æºã€‚Mesosæœ¬èº«ä¸æ˜¯ä¸“é—¨çš„å®¹å™¨ç¼–æ’å·¥å…·ï¼Œä½†å¯ä»¥é€šè¿‡Marathonç­‰æ¡†æ¶æ¥ç®¡ç†å®¹å™¨ã€‚

### æ¶æ„ç‰¹ç‚¹

```bash
# Mesosé›†ç¾¤å¯åŠ¨ç¤ºä¾‹
# å¯åŠ¨Mesos Master
mesos-master --ip=192.168.1.100 --work_dir=/var/lib/mesos

# å¯åŠ¨Mesos Agent
mesos-agent --master=192.168.1.100:5050 --work_dir=/var/lib/mesos

# ä½¿ç”¨Marathonéƒ¨ç½²åº”ç”¨
curl -X POST http://marathon.mesos:8080/v2/apps \
  -H "Content-Type: application/json" \
  -d '{
    "id": "web-app",
    "cmd": "python3 -m http.server 8080",
    "cpus": 0.5,
    "mem": 512,
    "instances": 3,
    "healthChecks": [{
      "protocol": "HTTP",
      "path": "/",
      "portIndex": 0,
      "timeoutSeconds": 10,
      "gracePeriodSeconds": 10,
      "intervalSeconds": 2,
      "maxConsecutiveFailures": 10
    }]
  }'
```

### ä¸»è¦ä¼˜åŠ¿

1. **èµ„æºåˆ©ç”¨ç‡é«˜**ï¼šç»†ç²’åº¦çš„èµ„æºåˆ†é…
2. **å¤šæ¡†æ¶æ”¯æŒ**ï¼šå¯åŒæ—¶è¿è¡Œä¸åŒç±»å‹çš„å·¥ä½œè´Ÿè½½
3. **é«˜å¯ç”¨æ€§**ï¼šæ”¯æŒå¤šä¸»èŠ‚ç‚¹çš„å®¹é”™æœºåˆ¶
4. **å¤§è§„æ¨¡æ‰©å±•**ï¼šå¯ç®¡ç†æ•°ä¸‡ä¸ªèŠ‚ç‚¹
5. **çµæ´»æ€§å¼º**ï¼šæ”¯æŒè‡ªå®šä¹‰è°ƒåº¦ç­–ç•¥

### é€‚ç”¨åœºæ™¯

- å¤§æ•°æ®å¤„ç†å¹³å°
- æ··åˆå·¥ä½œè´Ÿè½½ç¯å¢ƒ
- éœ€è¦é«˜èµ„æºåˆ©ç”¨ç‡çš„åœºæ™¯
- å¤§è§„æ¨¡é›†ç¾¤ç®¡ç†

## ï¼ˆå››ï¼‰å…¶ä»–ç¼–æ’å·¥å…·

### 1. HashiCorp Nomad

Nomadæ˜¯HashiCorpå¼€å‘çš„è½»é‡çº§ç¼–æ’å·¥å…·ï¼Œæ”¯æŒå®¹å™¨å’Œéå®¹å™¨åŒ–åº”ç”¨ã€‚

```hcl
# Nomadä½œä¸šå®šä¹‰ç¤ºä¾‹
job "web-app" {
  datacenters = ["dc1"]
  type = "service"

  group "web" {
    count = 3

    task "nginx" {
      driver = "docker"
      
      config {
        image = "nginx:latest"
        port_map {
          http = 80
        }
      }

      resources {
        cpu    = 500
        memory = 256
        network {
          mbits = 10
          port "http" {}
        }
      }

      service {
        name = "web-app"
        port = "http"
        check {
          type     = "http"
          path     = "/"
          interval = "10s"
          timeout  = "2s"
        }
      }
    }
  }
}
```

### 2. Red Hat OpenShift

OpenShiftæ˜¯åŸºäºKubernetesçš„ä¼ä¸šçº§å®¹å™¨å¹³å°ï¼Œæä¾›äº†é¢å¤–çš„å¼€å‘è€…å·¥å…·å’Œä¼ä¸šåŠŸèƒ½ã€‚

```yaml
# OpenShift DeploymentConfigç¤ºä¾‹
apiVersion: apps.openshift.io/v1
kind: DeploymentConfig
metadata:
  name: web-app
spec:
  replicas: 3
  selector:
    app: web-app
  template:
    metadata:
      labels:
        app: web-app
    spec:
      containers:
      - name: web-app
        image: nginx:latest
        ports:
        - containerPort: 8080
  triggers:
  - type: ConfigChange
  - type: ImageChange
    imageChangeParams:
      automatic: true
      containerNames:
      - web-app
      from:
        kind: ImageStreamTag
        name: nginx:latest
```

# ä¸‰ã€å®¹å™¨ç¼–æ’å·¥å…·å¯¹æ¯”åˆ†æ

## ï¼ˆä¸€ï¼‰åŠŸèƒ½ç‰¹æ€§å¯¹æ¯”

| ç‰¹æ€§ | Kubernetes | Docker Swarm | Apache Mesos | Nomad | OpenShift |
|------|------------|--------------|--------------|-------|-----------|
| å­¦ä¹ æ›²çº¿ | é™¡å³­ | å¹³ç¼“ | é™¡å³­ | ä¸­ç­‰ | ä¸­ç­‰ |
| éƒ¨ç½²å¤æ‚åº¦ | é«˜ | ä½ | é«˜ | ä¸­ç­‰ | ä¸­ç­‰ |
| æ‰©å±•æ€§ | æå¼º | ä¸­ç­‰ | æå¼º | å¼º | å¼º |
| ç¤¾åŒºæ´»è·ƒåº¦ | æé«˜ | ä¸­ç­‰ | ä¸­ç­‰ | ä¸­ç­‰ | é«˜ |
| ä¼ä¸šæ”¯æŒ | å¹¿æ³› | æœ‰é™ | æœ‰é™ | å•†ä¸šæ”¯æŒ | å•†ä¸šæ”¯æŒ |
| å¤šäº‘æ”¯æŒ | ä¼˜ç§€ | è‰¯å¥½ | è‰¯å¥½ | ä¼˜ç§€ | ä¼˜ç§€ |

## ï¼ˆäºŒï¼‰æ€§èƒ½å¯¹æ¯”

### 1. èµ„æºæ¶ˆè€—

```mermaid
graph TB
    A[èµ„æºæ¶ˆè€—å¯¹æ¯”] --> B[Kubernetes]
    A --> C[Docker Swarm]
    A --> D[Apache Mesos]
    A --> E[Nomad]
    
    B --> B1[æ§åˆ¶å¹³é¢: é«˜]
    B --> B2[å·¥ä½œèŠ‚ç‚¹: ä¸­ç­‰]
    
    C --> C1[ç®¡ç†èŠ‚ç‚¹: ä½]
    C --> C2[å·¥ä½œèŠ‚ç‚¹: ä½]
    
    D --> D1[Master: ä¸­ç­‰]
    D --> D2[Agent: ä½]
    
    E --> E1[Server: ä½]
    E --> E2[Client: æä½]
```

### 2. å¯åŠ¨æ—¶é—´

- **Docker Swarm**ï¼šç§’çº§å¯åŠ¨ï¼Œæœ€å¿«
- **Nomad**ï¼šç§’çº§å¯åŠ¨ï¼Œæ¥è¿‘Swarm
- **Kubernetes**ï¼šåˆ†é’Ÿçº§å¯åŠ¨ï¼Œè¾ƒæ…¢
- **Apache Mesos**ï¼šåˆ†é’Ÿçº§å¯åŠ¨ï¼Œå–å†³äºæ¡†æ¶

### 3. é›†ç¾¤è§„æ¨¡æ”¯æŒ

- **Kubernetes**ï¼šæ”¯æŒ5000+èŠ‚ç‚¹
- **Apache Mesos**ï¼šæ”¯æŒ10000+èŠ‚ç‚¹
- **Docker Swarm**ï¼šæ”¯æŒ1000+èŠ‚ç‚¹
- **Nomad**ï¼šæ”¯æŒ5000+èŠ‚ç‚¹

## ï¼ˆä¸‰ï¼‰é€‚ç”¨åœºæ™¯åˆ†æ

### 1. å°å‹é¡¹ç›®ï¼ˆ< 10ä¸ªæœåŠ¡ï¼‰
**æ¨èï¼šDocker Swarm**
- éƒ¨ç½²ç®€å•ï¼Œå­¦ä¹ æˆæœ¬ä½
- èµ„æºæ¶ˆè€—å°‘
- æ»¡è¶³åŸºæœ¬ç¼–æ’éœ€æ±‚

### 2. ä¸­å‹é¡¹ç›®ï¼ˆ10-100ä¸ªæœåŠ¡ï¼‰
**æ¨èï¼šKubernetes æˆ– Nomad**
- Kubernetesï¼šåŠŸèƒ½ä¸°å¯Œï¼Œç”Ÿæ€å®Œå–„
- Nomadï¼šè½»é‡çº§ï¼Œæ˜“äºç®¡ç†

### 3. å¤§å‹ä¼ä¸šé¡¹ç›®ï¼ˆ100+ä¸ªæœåŠ¡ï¼‰
**æ¨èï¼šKubernetes æˆ– OpenShift**
- å¼ºå¤§çš„æ‰©å±•èƒ½åŠ›
- ä¸°å¯Œçš„ä¼ä¸šçº§åŠŸèƒ½
- å®Œå–„çš„ç›‘æ§å’Œæ—¥å¿—ç³»ç»Ÿ

### 4. æ··åˆå·¥ä½œè´Ÿè½½
**æ¨èï¼šApache Mesos**
- æ”¯æŒå®¹å™¨å’Œéå®¹å™¨åŒ–åº”ç”¨
- é«˜æ•ˆçš„èµ„æºåˆ©ç”¨
- çµæ´»çš„è°ƒåº¦ç­–ç•¥

# å››ã€å®¹å™¨ç¼–æ’æœ€ä½³å®è·µ

## ï¼ˆä¸€ï¼‰è®¾è®¡åŸåˆ™

### 1. æ— çŠ¶æ€è®¾è®¡
åº”ç”¨åº”è¯¥è®¾è®¡ä¸ºæ— çŠ¶æ€çš„ï¼Œæ‰€æœ‰çŠ¶æ€ä¿¡æ¯å­˜å‚¨åœ¨å¤–éƒ¨æ•°æ®åº“æˆ–ç¼“å­˜ä¸­ã€‚

```yaml
# æ— çŠ¶æ€åº”ç”¨ç¤ºä¾‹
apiVersion: apps/v1
kind: Deployment
metadata:
  name: stateless-app
spec:
  replicas: 5
  selector:
    matchLabels:
      app: stateless-app
  template:
    metadata:
      labels:
        app: stateless-app
    spec:
      containers:
      - name: app
        image: myapp:latest
        env:
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: db-secret
              key: url
        - name: REDIS_URL
          valueFrom:
            configMapKeyRef:
              name: cache-config
              key: redis-url
```

### 2. å¥åº·æ£€æŸ¥
ä¸ºæ¯ä¸ªå®¹å™¨é…ç½®é€‚å½“çš„å¥åº·æ£€æŸ¥ï¼Œç¡®ä¿ç³»ç»Ÿèƒ½å¤ŸåŠæ—¶å‘ç°å’Œå¤„ç†æ•…éšœã€‚

```yaml
# å¥åº·æ£€æŸ¥é…ç½®ç¤ºä¾‹
spec:
  containers:
  - name: web-app
    image: nginx:latest
    livenessProbe:
      httpGet:
        path: /health
        port: 8080
      initialDelaySeconds: 30
      periodSeconds: 10
    readinessProbe:
      httpGet:
        path: /ready
        port: 8080
      initialDelaySeconds: 5
      periodSeconds: 5
```

### 3. èµ„æºé™åˆ¶
ä¸ºå®¹å™¨è®¾ç½®åˆé€‚çš„èµ„æºè¯·æ±‚å’Œé™åˆ¶ï¼Œé¿å…èµ„æºäº‰ç”¨ã€‚

```yaml
# èµ„æºé™åˆ¶ç¤ºä¾‹
spec:
  containers:
  - name: app
    image: myapp:latest
    resources:
      requests:
        memory: "256Mi"
        cpu: "250m"
      limits:
        memory: "512Mi"
        cpu: "500m"
```

## ï¼ˆäºŒï¼‰å®‰å…¨æœ€ä½³å®è·µ

### 1. æœ€å°æƒé™åŸåˆ™
ä½¿ç”¨RBACï¼ˆåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼‰é™åˆ¶å®¹å™¨å’Œç”¨æˆ·çš„æƒé™ã€‚

```yaml
# RBACé…ç½®ç¤ºä¾‹
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  namespace: production
  name: pod-reader
rules:
- apiGroups: [""]
  resources: ["pods"]
  verbs: ["get", "watch", "list"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: read-pods
  namespace: production
subjects:
- kind: User
  name: jane
  apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: Role
  name: pod-reader
  apiGroup: rbac.authorization.k8s.io
```

### 2. ç½‘ç»œç­–ç•¥
ä½¿ç”¨ç½‘ç»œç­–ç•¥é™åˆ¶å®¹å™¨é—´çš„é€šä¿¡ï¼Œå®ç°ç½‘ç»œéš”ç¦»ã€‚

```yaml
# ç½‘ç»œç­–ç•¥ç¤ºä¾‹
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: deny-all
  namespace: production
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-web-to-db
  namespace: production
spec:
  podSelector:
    matchLabels:
      app: database
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: web-app
    ports:
    - protocol: TCP
      port: 5432
```

### 3. é•œåƒå®‰å…¨
ä½¿ç”¨å¯ä¿¡çš„é•œåƒä»“åº“ï¼Œå®šæœŸæ‰«æé•œåƒæ¼æ´ï¼Œä½¿ç”¨æœ€å°åŒ–çš„åŸºç¡€é•œåƒã€‚

```dockerfile
# å®‰å…¨çš„Dockerfileç¤ºä¾‹
FROM alpine:3.14
RUN addgroup -g 1001 -S appgroup && \
    adduser -u 1001 -S appuser -G appgroup
COPY --chown=appuser:appgroup app /app
USER appuser
EXPOSE 8080
CMD ["/app"]
```

## ï¼ˆä¸‰ï¼‰ç›‘æ§ä¸æ—¥å¿—

### 1. ç›‘æ§æŒ‡æ ‡
å»ºç«‹å®Œå–„çš„ç›‘æ§ä½“ç³»ï¼Œç›‘æ§å…³é”®æŒ‡æ ‡ã€‚

```yaml
# Prometheusç›‘æ§é…ç½®ç¤ºä¾‹
apiVersion: v1
kind: ServiceMonitor
metadata:
  name: app-monitor
spec:
  selector:
    matchLabels:
      app: web-app
  endpoints:
  - port: metrics
    interval: 30s
    path: /metrics
```

### 2. æ—¥å¿—æ”¶é›†
é›†ä¸­æ”¶é›†å’Œåˆ†æå®¹å™¨æ—¥å¿—ã€‚

```yaml
# Fluentdæ—¥å¿—æ”¶é›†é…ç½®ç¤ºä¾‹
apiVersion: v1
kind: ConfigMap
metadata:
  name: fluentd-config
data:
  fluent.conf: |
    <source>
      @type tail
      path /var/log/containers/*.log
      pos_file /var/log/fluentd-containers.log.pos
      tag kubernetes.*
      format json
    </source>
    
    <match kubernetes.**>
      @type elasticsearch
      host elasticsearch.logging.svc.cluster.local
      port 9200
      index_name kubernetes
    </match>
```

# äº”ã€æ€»ç»“ä¸å±•æœ›

## ï¼ˆä¸€ï¼‰é€‰æ‹©å»ºè®®

é€‰æ‹©åˆé€‚çš„å®¹å™¨ç¼–æ’å·¥å…·éœ€è¦è€ƒè™‘ä»¥ä¸‹å› ç´ ï¼š

1. **å›¢é˜ŸæŠ€èƒ½æ°´å¹³**ï¼šé€‰æ‹©å›¢é˜Ÿèƒ½å¤ŸæŒæ¡çš„å·¥å…·
2. **é¡¹ç›®è§„æ¨¡**ï¼šæ ¹æ®åº”ç”¨å¤æ‚åº¦é€‰æ‹©åˆé€‚çš„å·¥å…·
3. **æ€§èƒ½è¦æ±‚**ï¼šè€ƒè™‘å»¶è¿Ÿã€ååé‡ç­‰æ€§èƒ½æŒ‡æ ‡
4. **é¢„ç®—é™åˆ¶**ï¼šè¯„ä¼°å­¦ä¹ æˆæœ¬å’Œè¿ç»´æˆæœ¬
5. **ç”Ÿæ€ç³»ç»Ÿ**ï¼šè€ƒè™‘å·¥å…·çš„ç”Ÿæ€å®Œæ•´æ€§

## ï¼ˆäºŒï¼‰å‘å±•è¶‹åŠ¿

å®¹å™¨ç¼–æ’æŠ€æœ¯æ­£æœç€ä»¥ä¸‹æ–¹å‘å‘å±•ï¼š

1. **Serverlesså®¹å™¨**ï¼šå¦‚AWS Fargateã€Google Cloud Run
2. **è¾¹ç¼˜è®¡ç®—**ï¼šæ”¯æŒè¾¹ç¼˜è®¾å¤‡çš„è½»é‡çº§ç¼–æ’
3. **AI/MLå·¥ä½œè´Ÿè½½**ï¼šé’ˆå¯¹æœºå™¨å­¦ä¹ ä¼˜åŒ–çš„ç¼–æ’èƒ½åŠ›
4. **å¤šäº‘ç®¡ç†**ï¼šè·¨äº‘å¹³å°çš„ç»Ÿä¸€ç¼–æ’
5. **å®‰å…¨å¢å¼º**ï¼šé›¶ä¿¡ä»»ç½‘ç»œã€è¿è¡Œæ—¶å®‰å…¨ç­‰

## ï¼ˆä¸‰ï¼‰å­¦ä¹ è·¯å¾„

å¯¹äºæƒ³è¦å­¦ä¹ å®¹å™¨ç¼–æ’çš„å¼€å‘è€…ï¼Œå»ºè®®æŒ‰ä»¥ä¸‹è·¯å¾„å­¦ä¹ ï¼š

1. **åŸºç¡€çŸ¥è¯†**ï¼šå®¹å™¨æŠ€æœ¯ã€DockeråŸºç¡€
2. **é€‰æ‹©å·¥å…·**ï¼šæ ¹æ®éœ€æ±‚é€‰æ‹©Kubernetesæˆ–å…¶ä»–å·¥å…·
3. **å®è·µé¡¹ç›®**ï¼šé€šè¿‡å®é™…é¡¹ç›®åŠ æ·±ç†è§£
4. **è¿›é˜¶å­¦ä¹ **ï¼šç›‘æ§ã€å®‰å…¨ã€æ€§èƒ½ä¼˜åŒ–ç­‰é«˜çº§ä¸»é¢˜
5. **æŒç»­è·Ÿè¿›**ï¼šå…³æ³¨æŠ€æœ¯å‘å±•è¶‹åŠ¿

å®¹å™¨ç¼–æ’æŠ€æœ¯å·²ç»æˆä¸ºç°ä»£åº”ç”¨éƒ¨ç½²çš„æ ‡å‡†å®è·µï¼ŒæŒæ¡è¿™äº›æŠ€æœ¯å¯¹äºå¼€å‘è€…å’Œè¿ç»´å·¥ç¨‹å¸ˆæ¥è¯´éƒ½æ˜¯å¿…ä¸å¯å°‘çš„æŠ€èƒ½ã€‚å¸Œæœ›æœ¬æ–‡èƒ½å¤Ÿå¸®åŠ©è¯»è€…æ›´å¥½åœ°ç†è§£å’Œé€‰æ‹©é€‚åˆçš„å®¹å™¨ç¼–æ’å·¥å…·ã€‚

{% note info %}
**ç›¸å…³æ–‡ç« æ¨è**
- [Dockerè¯¦è§£ï¼šå®¹å™¨æŠ€æœ¯çš„åŸç†ä¸å®è·µ](/posts/å­¦ä¹ /Dockerè¯¦è§£ï¼šå®¹å™¨æŠ€æœ¯çš„åŸç†ä¸å®è·µ/)
- [Kubernetes (K8s) åŸºç¡€å…¥é—¨ç¬”è®°](/posts/å­¦ä¹ /Kubernetes-K8s-åŸºç¡€å…¥é—¨ç¬”è®°/)
- [äº‘è®¡ç®—æœåŠ¡æ¨¡å¼è¯¦è§£ï¼šIaaSã€PaaSã€SaaSå…¨é¢è§£æ](/posts/å­¦ä¹ /äº‘è®¡ç®—æœåŠ¡æ¨¡å¼è¯¦è§£ï¼šIaaSã€PaaSã€SaaSå…¨é¢è§£æ/)
- [å¾®æœåŠ¡æ¶æ„è®¾è®¡ä¸å®è·µ](/posts/åç«¯/å¾®æœåŠ¡æ¶æ„è®¾è®¡ä¸å®è·µ/)
{% endnote %}

{% btn 'https://kubernetes.io/docs/', Kuberneteså®˜æ–¹æ–‡æ¡£, far fa-hand-point-right, blue %}
{% btn 'https://docs.docker.com/engine/swarm/', Docker Swarmæ–‡æ¡£, far fa-hand-point-right, green %}
{% btn 'http://mesos.apache.org/', Apache Mesos, far fa-hand-point-right, orange %}

# å…­ã€å®æˆ˜æ¡ˆä¾‹ï¼šéƒ¨ç½²å¾®æœåŠ¡åº”ç”¨

## ï¼ˆä¸€ï¼‰åœºæ™¯æè¿°

å‡è®¾æˆ‘ä»¬è¦éƒ¨ç½²ä¸€ä¸ªç”µå•†ç³»ç»Ÿï¼ŒåŒ…å«ä»¥ä¸‹å¾®æœåŠ¡ï¼š
- **å‰ç«¯æœåŠ¡**ï¼šReactåº”ç”¨ï¼Œæä¾›ç”¨æˆ·ç•Œé¢
- **APIç½‘å…³**ï¼šè·¯ç”±å’Œè®¤è¯æœåŠ¡
- **ç”¨æˆ·æœåŠ¡**ï¼šç”¨æˆ·ç®¡ç†å’Œè®¤è¯
- **å•†å“æœåŠ¡**ï¼šå•†å“ä¿¡æ¯ç®¡ç†
- **è®¢å•æœåŠ¡**ï¼šè®¢å•å¤„ç†
- **æ•°æ®åº“**ï¼šMySQLå’ŒRedis

## ï¼ˆäºŒï¼‰Kuberneteséƒ¨ç½²æ–¹æ¡ˆ

### 1. å‘½åç©ºé—´å’Œèµ„æºé…é¢

```yaml
# namespace.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: ecommerce
  labels:
    name: ecommerce
---
apiVersion: v1
kind: ResourceQuota
metadata:
  name: ecommerce-quota
  namespace: ecommerce
spec:
  hard:
    requests.cpu: "4"
    requests.memory: 8Gi
    limits.cpu: "8"
    limits.memory: 16Gi
    persistentvolumeclaims: "4"
```

### 2. é…ç½®ç®¡ç†

```yaml
# configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: app-config
  namespace: ecommerce
data:
  database.properties: |
    db.host=mysql-service
    db.port=3306
    db.name=ecommerce
  redis.properties: |
    redis.host=redis-service
    redis.port=6379
---
apiVersion: v1
kind: Secret
metadata:
  name: db-secret
  namespace: ecommerce
type: Opaque
data:
  username: cm9vdA==  # base64ç¼–ç çš„"root"
  password: cGFzc3dvcmQ=  # base64ç¼–ç çš„"password"
```

### 3. æ•°æ®åº“éƒ¨ç½²

```yaml
# mysql-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mysql
  namespace: ecommerce
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mysql
  template:
    metadata:
      labels:
        app: mysql
    spec:
      containers:
      - name: mysql
        image: mysql:8.0
        env:
        - name: MYSQL_ROOT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: db-secret
              key: password
        - name: MYSQL_DATABASE
          value: ecommerce
        ports:
        - containerPort: 3306
        volumeMounts:
        - name: mysql-storage
          mountPath: /var/lib/mysql
        resources:
          requests:
            memory: "1Gi"
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "1000m"
      volumes:
      - name: mysql-storage
        persistentVolumeClaim:
          claimName: mysql-pvc
---
apiVersion: v1
kind: Service
metadata:
  name: mysql-service
  namespace: ecommerce
spec:
  selector:
    app: mysql
  ports:
  - port: 3306
    targetPort: 3306
  type: ClusterIP
```

### 4. å¾®æœåŠ¡éƒ¨ç½²

```yaml
# user-service.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: user-service
  namespace: ecommerce
spec:
  replicas: 3
  selector:
    matchLabels:
      app: user-service
  template:
    metadata:
      labels:
        app: user-service
    spec:
      containers:
      - name: user-service
        image: ecommerce/user-service:v1.0
        ports:
        - containerPort: 8080
        env:
        - name: DB_HOST
          valueFrom:
            configMapKeyRef:
              name: app-config
              key: database.properties
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: db-secret
              key: password
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 5
        resources:
          requests:
            memory: "256Mi"
            cpu: "250m"
          limits:
            memory: "512Mi"
            cpu: "500m"
---
apiVersion: v1
kind: Service
metadata:
  name: user-service
  namespace: ecommerce
spec:
  selector:
    app: user-service
  ports:
  - port: 80
    targetPort: 8080
  type: ClusterIP
```

### 5. APIç½‘å…³å’Œè´Ÿè½½å‡è¡¡

```yaml
# api-gateway.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: api-gateway
  namespace: ecommerce
spec:
  replicas: 2
  selector:
    matchLabels:
      app: api-gateway
  template:
    metadata:
      labels:
        app: api-gateway
    spec:
      containers:
      - name: nginx
        image: nginx:1.21
        ports:
        - containerPort: 80
        volumeMounts:
        - name: nginx-config
          mountPath: /etc/nginx/conf.d
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"
      volumes:
      - name: nginx-config
        configMap:
          name: nginx-config
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-config
  namespace: ecommerce
data:
  default.conf: |
    upstream user-service {
        server user-service:80;
    }
    upstream product-service {
        server product-service:80;
    }
    upstream order-service {
        server order-service:80;
    }

    server {
        listen 80;

        location /api/users/ {
            proxy_pass http://user-service/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        location /api/products/ {
            proxy_pass http://product-service/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        location /api/orders/ {
            proxy_pass http://order-service/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
    }
---
apiVersion: v1
kind: Service
metadata:
  name: api-gateway
  namespace: ecommerce
spec:
  selector:
    app: api-gateway
  ports:
  - port: 80
    targetPort: 80
  type: LoadBalancer
```

## ï¼ˆä¸‰ï¼‰Docker Swarméƒ¨ç½²æ–¹æ¡ˆ

### 1. åˆå§‹åŒ–Swarmé›†ç¾¤

```bash
# åœ¨ç®¡ç†èŠ‚ç‚¹ä¸Šåˆå§‹åŒ–Swarm
docker swarm init --advertise-addr 192.168.1.100

# åœ¨å·¥ä½œèŠ‚ç‚¹ä¸ŠåŠ å…¥é›†ç¾¤
docker swarm join --token SWMTKN-1-xxx 192.168.1.100:2377

# æŸ¥çœ‹é›†ç¾¤çŠ¶æ€
docker node ls
```

### 2. åˆ›å»ºç½‘ç»œå’Œå­˜å‚¨

```bash
# åˆ›å»ºoverlayç½‘ç»œ
docker network create --driver overlay ecommerce-network

# åˆ›å»ºå­˜å‚¨å·
docker volume create mysql-data
docker volume create redis-data
```

### 3. Docker Composeæ–‡ä»¶

```yaml
# docker-compose.yml
version: '3.8'

services:
  mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: password
      MYSQL_DATABASE: ecommerce
    volumes:
      - mysql-data:/var/lib/mysql
    networks:
      - ecommerce-network
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          memory: 2G
          cpus: '1.0'
        reservations:
          memory: 1G
          cpus: '0.5'

  redis:
    image: redis:alpine
    volumes:
      - redis-data:/data
    networks:
      - ecommerce-network
    deploy:
      replicas: 1
      resources:
        limits:
          memory: 512M
          cpus: '0.5'

  user-service:
    image: ecommerce/user-service:v1.0
    environment:
      DB_HOST: mysql
      DB_PASSWORD: password
      REDIS_HOST: redis
    networks:
      - ecommerce-network
    deploy:
      replicas: 3
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  product-service:
    image: ecommerce/product-service:v1.0
    environment:
      DB_HOST: mysql
      DB_PASSWORD: password
      REDIS_HOST: redis
    networks:
      - ecommerce-network
    deploy:
      replicas: 3
      update_config:
        parallelism: 1
        delay: 10s
      restart_policy:
        condition: on-failure
      resources:
        limits:
          memory: 512M
          cpus: '0.5'

  order-service:
    image: ecommerce/order-service:v1.0
    environment:
      DB_HOST: mysql
      DB_PASSWORD: password
      REDIS_HOST: redis
      USER_SERVICE_URL: http://user-service:8080
      PRODUCT_SERVICE_URL: http://product-service:8080
    networks:
      - ecommerce-network
    deploy:
      replicas: 2
      update_config:
        parallelism: 1
        delay: 10s
      restart_policy:
        condition: on-failure

  api-gateway:
    image: nginx:1.21
    ports:
      - "80:80"
      - "443:443"
    configs:
      - source: nginx_config
        target: /etc/nginx/conf.d/default.conf
    networks:
      - ecommerce-network
    deploy:
      replicas: 2
      update_config:
        parallelism: 1
        delay: 10s
      placement:
        constraints:
          - node.role == manager

  frontend:
    image: ecommerce/frontend:v1.0
    environment:
      API_URL: http://api-gateway
    networks:
      - ecommerce-network
    deploy:
      replicas: 3
      update_config:
        parallelism: 1
        delay: 10s

networks:
  ecommerce-network:
    driver: overlay
    attachable: true

volumes:
  mysql-data:
    driver: local
  redis-data:
    driver: local

configs:
  nginx_config:
    external: true
```

### 4. éƒ¨ç½²å’Œç®¡ç†

```bash
# åˆ›å»ºnginxé…ç½®
docker config create nginx_config nginx.conf

# éƒ¨ç½²åº”ç”¨æ ˆ
docker stack deploy -c docker-compose.yml ecommerce

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker service ls
docker stack services ecommerce

# æ‰©å±•æœåŠ¡
docker service scale ecommerce_user-service=5

# æ›´æ–°æœåŠ¡
docker service update --image ecommerce/user-service:v1.1 ecommerce_user-service

# æŸ¥çœ‹æœåŠ¡æ—¥å¿—
docker service logs ecommerce_user-service

# åˆ é™¤åº”ç”¨æ ˆ
docker stack rm ecommerce
```

## ï¼ˆå››ï¼‰æ€§èƒ½ä¼˜åŒ–å’Œç›‘æ§

### 1. èµ„æºç›‘æ§

```yaml
# prometheus-config.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
  namespace: monitoring
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s

    scrape_configs:
    - job_name: 'kubernetes-pods'
      kubernetes_sd_configs:
      - role: pod
      relabel_configs:
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
        action: keep
        regex: true
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
        action: replace
        target_label: __metrics_path__
        regex: (.+)
```

### 2. è‡ªåŠ¨æ‰©ç¼©å®¹

```yaml
# hpa.yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: user-service-hpa
  namespace: ecommerce
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: user-service
  minReplicas: 2
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
      - type: Percent
        value: 10
        periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 0
      policies:
      - type: Percent
        value: 100
        periodSeconds: 15
      - type: Pods
        value: 4
        periodSeconds: 15
      selectPolicy: Max
```

### 3. æœåŠ¡ç½‘æ ¼é›†æˆ

```yaml
# istio-gateway.yaml
apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: ecommerce-gateway
  namespace: ecommerce
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - ecommerce.example.com
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: ecommerce-vs
  namespace: ecommerce
spec:
  hosts:
  - ecommerce.example.com
  gateways:
  - ecommerce-gateway
  http:
  - match:
    - uri:
        prefix: /api/users
    route:
    - destination:
        host: user-service
        port:
          number: 80
    fault:
      delay:
        percentage:
          value: 0.1
        fixedDelay: 5s
  - match:
    - uri:
        prefix: /api/products
    route:
    - destination:
        host: product-service
        port:
          number: 80
    retries:
      attempts: 3
      perTryTimeout: 2s
```

## å‚è€ƒèµ„æ–™

1. [Kuberneteså®˜æ–¹æ–‡æ¡£](https://kubernetes.io/docs/)
2. [Docker Swarmå®˜æ–¹æ–‡æ¡£](https://docs.docker.com/engine/swarm/)
3. [Apache Mesoså®˜æ–¹æ–‡æ¡£](http://mesos.apache.org/documentation/)
4. [HashiCorp Nomadå®˜æ–¹æ–‡æ¡£](https://www.nomadproject.io/docs)
5. [Red Hat OpenShiftå®˜æ–¹æ–‡æ¡£](https://docs.openshift.com/)
6. [CNCFäº‘åŸç”ŸæŠ€æœ¯æ ˆ](https://landscape.cncf.io/)
7. [ã€ŠKubernetesæƒå¨æŒ‡å—ã€‹](https://book.douban.com/subject/26902153/)
8. [ã€ŠDockeræ·±å…¥æµ…å‡ºã€‹](https://book.douban.com/subject/26894736/)
9. [IstioæœåŠ¡ç½‘æ ¼å®˜æ–¹æ–‡æ¡£](https://istio.io/latest/docs/)
10. [Prometheusç›‘æ§ç³»ç»Ÿæ–‡æ¡£](https://prometheus.io/docs/)

---

## æ³¨è„š

[^1]: CNCF Annual Survey 2023: https://www.cncf.io/reports/cncf-annual-survey-2023/
