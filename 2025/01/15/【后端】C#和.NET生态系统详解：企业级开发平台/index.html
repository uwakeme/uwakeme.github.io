

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="https://cdn.jsdelivr.net/gh/uwakeme/cdn@main/img/favicon.png">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Wake">
  <meta name="keywords" content="C#,.NET Core,ASP.NET Core,微服务,企业级开发,跨平台">
  
    <meta name="description" content="全面解析C#和.NET生态系统，包括.NET Core、ASP.NET Core、微服务架构、企业级开发最佳实践，为开发者提供完整的.NET技术栈指南">
<meta property="og:type" content="article">
<meta property="og:title" content="【后端】C#和.NET生态系统详解：企业级开发平台">
<meta property="og:url" content="https://uwakeme.top/2025/01/15/%E3%80%90%E5%90%8E%E7%AB%AF%E3%80%91C#%E5%92%8C.NET%E7%94%9F%E6%80%81%E7%B3%BB%E7%BB%9F%E8%AF%A6%E8%A7%A3%EF%BC%9A%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%BC%80%E5%8F%91%E5%B9%B3%E5%8F%B0/index.html">
<meta property="og:site_name" content="Uwakeme">
<meta property="og:description" content="全面解析C#和.NET生态系统，包括.NET Core、ASP.NET Core、微服务架构、企业级开发最佳实践，为开发者提供完整的.NET技术栈指南">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2025-01-14T16:00:00.000Z">
<meta property="article:modified_time" content="2025-07-15T06:38:35.058Z">
<meta property="article:author" content="Wake">
<meta property="article:tag" content="后端">
<meta property="article:tag" content="微服务">
<meta property="article:tag" content="C#">
<meta property="article:tag" content=".NET">
<meta property="article:tag" content="ASP.NET Core">
<meta property="article:tag" content="企业级开发">
<meta name="twitter:card" content="summary_large_image">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>【后端】C#和.NET生态系统详解：企业级开发平台 - Uwakeme</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  



  
<link rel="stylesheet" href="//at.alicdn.com/t/c/font_3846514_kabxni94auf.css">
<link rel="stylesheet" href="/css/custom.css">
<link rel="stylesheet" href="/css/ai-assistant.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"uwakeme.top","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"|","loop":false,"scope":[],"backSpeed":40,"showCursor":true},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":"#"},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100},"position_indicator":{"enable":true,"color":"#33a3dc"}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""],"img_max_width":"80%","img_max_height":"80%"},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0,"level":3,"collapse":false,"follow":true,"number":true,"heading_list":true,"expand_all":true},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2,"element_loading_img":true},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":"41fc030db57d5570dd22f78997dc4a7e","google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null},"busuanzi":{"enable":true,"script_url":"//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js","site_uv":true,"site_pv":true,"page_pv":true}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  
    <!-- Baidu Analytics -->
    <script async>
      if (!Fluid.ctx.dnt) {
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?41fc030db57d5570dd22f78997dc4a7e";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
      }
    </script>
  

  

  

  

  



  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Wake 的博客</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives" target="_self">
                <i class="iconfont icon-books"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories" target="_self">
                <i class="iconfont icon-th-large"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/" target="_self">
                <i class="iconfont icon-link-fill"></i>
                <span>友链</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" target="_self" href="javascript:;" role="button"
                 data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <i class="iconfont icon-book"></i>
                <span>文档</span>
              </a>
              <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                
                  
                  
                  
                  <a class="dropdown-item" href="https://hexo.fluid-dev.com/" target="_self">
                    
                    <span>主题博客</span>
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="https://hexo.fluid-dev.com/docs/guide/" target="_self">
                    
                    <span>配置指南</span>
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="https://hexo.fluid-dev.com/docs/icon/" target="_self">
                    
                    <span>图标用法</span>
                  </a>
                
              </div>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="【后端】C#和.NET生态系统详解：企业级开发平台"></span>
          
        </div>

        
          
  <div class="mt-3">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-author" aria-hidden="true"></i>
        Wake
      </span>
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-01-15 00:00" pubdate>
          2025-01-15 00:00
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          <!-- compatible with older versions-->
          5.9k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          <!-- compatible with older versions-->
          50 分钟
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> 次
        </span>
        

      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">【后端】C#和.NET生态系统详解：企业级开发平台</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>C#和.NET生态系统作为微软公司推出的企业级开发平台，经历了从传统的Windows专属框架到现代跨平台开源框架的重大转变。随着.NET Core的推出和.NET 5&#x2F;6&#x2F;7&#x2F;8的持续演进，.NET已经成为构建现代云原生应用、微服务架构和高性能Web应用的重要选择。</p>
<p>本文将全面解析C#和.NET生态系统的核心特性、技术架构、开发实践和应用场景，帮助开发者深入理解这个强大的企业级开发平台。</p>
<blockquote>
<p><strong>相关文章导航</strong>：</p>
<ul>
<li><a href="./%E3%80%90%E5%90%8E%E7%AB%AF%E3%80%91%E5%90%8E%E7%AB%AF%E6%A1%86%E6%9E%B6%E5%85%A8%E6%99%AF%E5%9B%BE%EF%BC%9A%E7%8E%B0%E4%BB%A3%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%BC%80%E5%8F%91%E6%8A%80%E6%9C%AF%E6%A0%88%E8%AF%A6%E8%A7%A3.md">后端框架全景图：现代服务端开发技术栈详解</a></li>
<li><a href="./%E3%80%90%E5%90%8E%E7%AB%AF%E3%80%91Spring%20Boot%E8%AF%A6%E8%A7%A3%EF%BC%9A%E4%BC%81%E4%B8%9A%E7%BA%A7Java%E5%BC%80%E5%8F%91%E6%A1%86%E6%9E%B6.md">Spring Boot详解：企业级Java开发框架</a></li>
<li><a href="./%E3%80%90%E5%90%8E%E7%AB%AF%E3%80%91Node.js%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90%EF%BC%9A%E6%9E%84%E5%BB%BA%E9%AB%98%E6%80%A7%E8%83%BD%E7%9A%84%E5%90%8E%E7%AB%AF%E6%9C%8D%E5%8A%A1.md">Node.js深度解析：构建高性能的后端服务</a></li>
</ul>
</blockquote>
<h1 id="本文内容概览"><a href="#本文内容概览" class="headerlink" title="本文内容概览"></a>本文内容概览</h1><ul>
<li><strong>.NET平台发展历程</strong>：从.NET Framework到.NET Core的演进</li>
<li><strong>核心技术架构</strong>：CLR、BCL、语言特性深度解析</li>
<li><strong>ASP.NET Core详解</strong>：现代Web开发框架</li>
<li><strong>微服务架构实践</strong>：.NET微服务生态系统</li>
<li><strong>企业级开发特性</strong>：安全、性能、可扩展性</li>
<li><strong>开发工具生态</strong>：Visual Studio、开发体验</li>
<li><strong>实际应用案例</strong>：企业级项目实战</li>
</ul>
<h1 id="一、-NET平台发展历程"><a href="#一、-NET平台发展历程" class="headerlink" title="一、.NET平台发展历程"></a>一、.NET平台发展历程</h1><h2 id="（一）技术演进阶段"><a href="#（一）技术演进阶段" class="headerlink" title="（一）技术演进阶段"></a>（一）技术演进阶段</h2><h3 id="1-NET-Framework时代（2002-2016）"><a href="#1-NET-Framework时代（2002-2016）" class="headerlink" title="1. .NET Framework时代（2002-2016）"></a>1. .NET Framework时代（2002-2016）</h3><ul>
<li><strong>特点</strong>：Windows专属，企业级应用首选 <mcreference link="https://blog.csdn.net/weixin_55959870/article/details/122474430" index="1">1</mcreference></li>
<li><strong>核心组件</strong>：CLR、BCL、ASP.NET、WinForms、WPF</li>
<li><strong>优势</strong>：成熟稳定，企业级特性完善</li>
<li><strong>局限</strong>：平台绑定，部署复杂</li>
</ul>
<h3 id="2-NET-Core时代（2016-2020）"><a href="#2-NET-Core时代（2016-2020）" class="headerlink" title="2. .NET Core时代（2016-2020）"></a>2. .NET Core时代（2016-2020）</h3><ul>
<li><strong>特点</strong>：跨平台、开源、高性能 <mcreference link="https://blog.csdn.net/weixin_55959870/article/details/122474430" index="1">1</mcreference></li>
<li><strong>核心特性</strong>：<ul>
<li>跨平台支持（Windows、macOS、Linux）</li>
<li>模块化架构</li>
<li>容器化友好</li>
<li>云原生设计</li>
</ul>
</li>
</ul>
<h3 id="3-NET-5-统一时代（2020-至今）"><a href="#3-NET-5-统一时代（2020-至今）" class="headerlink" title="3. .NET 5+统一时代（2020-至今）"></a>3. .NET 5+统一时代（2020-至今）</h3><ul>
<li><strong>特点</strong>：统一的.NET平台，一个框架支持所有应用类型</li>
<li><strong>版本演进</strong>：.NET 5 → .NET 6 → .NET 7 → .NET 8</li>
<li><strong>核心改进</strong>：性能提升、新语言特性、云原生优化</li>
</ul>
<h2 id="（二）平台特性对比"><a href="#（二）平台特性对比" class="headerlink" title="（二）平台特性对比"></a>（二）平台特性对比</h2><table>
<thead>
<tr>
<th>特性</th>
<th>.NET Framework</th>
<th>.NET Core&#x2F;.NET 5+</th>
</tr>
</thead>
<tbody><tr>
<td>平台支持</td>
<td>Windows Only</td>
<td>跨平台</td>
</tr>
<tr>
<td>开源</td>
<td>部分开源</td>
<td>完全开源</td>
</tr>
<tr>
<td>部署方式</td>
<td>依赖系统安装</td>
<td>自包含部署</td>
</tr>
<tr>
<td>性能</td>
<td>良好</td>
<td>优秀</td>
</tr>
<tr>
<td>容器支持</td>
<td>有限</td>
<td>原生支持</td>
</tr>
<tr>
<td>微服务</td>
<td>支持</td>
<td>优化支持</td>
</tr>
</tbody></table>
<h1 id="二、-NET-Core平台深度解析"><a href="#二、-NET-Core平台深度解析" class="headerlink" title="二、.NET Core平台深度解析"></a>二、.NET Core平台深度解析</h1><h2 id="（一）核心架构组件"><a href="#（一）核心架构组件" class="headerlink" title="（一）核心架构组件"></a>（一）核心架构组件</h2><h3 id="1-NET-Core运行时"><a href="#1-NET-Core运行时" class="headerlink" title="1. .NET Core运行时"></a>1. .NET Core运行时</h3><figure><div class="code-wrapper"><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token comment">// .NET Core运行时提供的核心服务</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RuntimeServices</span>
<span class="token punctuation">&#123;</span>
    <span class="token comment">// 类型系统</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Type</span> <span class="token function">GetType</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> typeName<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span>
    
    <span class="token comment">// 程序集加载</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Assembly</span> <span class="token function">LoadAssembly</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> assemblyPath<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span>
    
    <span class="token comment">// 垃圾回收器</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ForceGarbageCollection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    <span class="token punctuation">&#123;</span>
        GC<span class="token punctuation">.</span><span class="token function">Collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        GC<span class="token punctuation">.</span><span class="token function">WaitForPendingFinalizers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">// 本机互操作</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">DllImport</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">"kernel32.dll"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">extern</span> <span class="token return-type class-name">IntPtr</span> <span class="token function">GetCurrentProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h3 id="2-基础类库（BCL）"><a href="#2-基础类库（BCL）" class="headerlink" title="2. 基础类库（BCL）"></a>2. 基础类库（BCL）</h3><figure><div class="code-wrapper"><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token comment">// 基础类库示例</span>
<span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Threading<span class="token punctuation">.</span>Tasks</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>IO</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BCLExample</span>
<span class="token punctuation">&#123;</span>
    <span class="token comment">// 集合操作</span>
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token generic-method"><span class="token function">ProcessDataAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token class-name">IEnumerable<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> data<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">await</span> <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> item <span class="token keyword">in</span> data<span class="token punctuation">.</span><span class="token function">ToAsyncEnumerable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token comment">// 异步处理逻辑</span>
            result<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">// 文件I/O操作</span>
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">></span></span> <span class="token function">ReadFileAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> filePath<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">using</span> <span class="token class-name"><span class="token keyword">var</span></span> reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">StreamReader</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">await</span> reader<span class="token punctuation">.</span><span class="token function">ReadToEndAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h2 id="（二）平台特性详解"><a href="#（二）平台特性详解" class="headerlink" title="（二）平台特性详解"></a>（二）平台特性详解</h2><h3 id="1-跨平台能力-1"><a href="#1-跨平台能力-1" class="headerlink" title="1. 跨平台能力 1"></a>1. 跨平台能力 <mcreference link="https://blog.csdn.net/weixin_55959870/article/details/122474430" index="1">1</mcreference></h3><figure><div class="code-wrapper"><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token comment">// 跨平台文件路径处理</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CrossPlatformHelper</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">GetConfigPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>RuntimeInformation<span class="token punctuation">.</span><span class="token function">IsOSPlatform</span><span class="token punctuation">(</span>OSPlatform<span class="token punctuation">.</span>Windows<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> Path<span class="token punctuation">.</span><span class="token function">Combine</span><span class="token punctuation">(</span>Environment<span class="token punctuation">.</span><span class="token function">GetFolderPath</span><span class="token punctuation">(</span>
                Environment<span class="token punctuation">.</span>SpecialFolder<span class="token punctuation">.</span>ApplicationData<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"MyApp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>RuntimeInformation<span class="token punctuation">.</span><span class="token function">IsOSPlatform</span><span class="token punctuation">(</span>OSPlatform<span class="token punctuation">.</span>Linux<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> Path<span class="token punctuation">.</span><span class="token function">Combine</span><span class="token punctuation">(</span>Environment<span class="token punctuation">.</span><span class="token function">GetEnvironmentVariable</span><span class="token punctuation">(</span><span class="token string">"HOME"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
                <span class="token string">".config"</span><span class="token punctuation">,</span> <span class="token string">"myapp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>RuntimeInformation<span class="token punctuation">.</span><span class="token function">IsOSPlatform</span><span class="token punctuation">(</span>OSPlatform<span class="token punctuation">.</span>OSX<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> Path<span class="token punctuation">.</span><span class="token function">Combine</span><span class="token punctuation">(</span>Environment<span class="token punctuation">.</span><span class="token function">GetEnvironmentVariable</span><span class="token punctuation">(</span><span class="token string">"HOME"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
                <span class="token string">"Library"</span><span class="token punctuation">,</span> <span class="token string">"Application Support"</span><span class="token punctuation">,</span> <span class="token string">"MyApp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">PlatformNotSupportedException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h3 id="2-高性能特性"><a href="#2-高性能特性" class="headerlink" title="2. 高性能特性"></a>2. 高性能特性</h3><figure><div class="code-wrapper"><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token comment">// Span&lt;T>和Memory&lt;T>高性能操作</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HighPerformanceOperations</span>
<span class="token punctuation">&#123;</span>
    <span class="token comment">// 零拷贝字符串操作</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">ReadOnlySpan<span class="token punctuation">&lt;</span><span class="token keyword">char</span><span class="token punctuation">></span></span> <span class="token function">ExtractDomain</span><span class="token punctuation">(</span><span class="token class-name">ReadOnlySpan<span class="token punctuation">&lt;</span><span class="token keyword">char</span><span class="token punctuation">></span></span> email<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> atIndex <span class="token operator">=</span> email<span class="token punctuation">.</span><span class="token function">IndexOf</span><span class="token punctuation">(</span><span class="token char">'@'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> atIndex <span class="token operator">>=</span> <span class="token number">0</span> <span class="token punctuation">?</span> email<span class="token punctuation">.</span><span class="token function">Slice</span><span class="token punctuation">(</span>atIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> ReadOnlySpan<span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">></span><span class="token punctuation">.</span>Empty<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">// 高性能数组操作</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ProcessLargeArray</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> data<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> span <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">AsSpan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 并行处理</span>
        Parallel<span class="token punctuation">.</span><span class="token function">For</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> span<span class="token punctuation">.</span>Length<span class="token punctuation">,</span> i <span class="token operator">=></span>
        <span class="token punctuation">&#123;</span>
            span<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> span<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h3 id="3-依赖注入容器"><a href="#3-依赖注入容器" class="headerlink" title="3. 依赖注入容器"></a>3. 依赖注入容器</h3><figure><div class="code-wrapper"><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token comment">// 内置依赖注入</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DIExample</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ConfigureServices</span><span class="token punctuation">(</span><span class="token class-name">IServiceCollection</span> services<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token comment">// 注册服务</span>
        services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddScoped</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IUserService<span class="token punctuation">,</span> UserService<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddSingleton</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IConfiguration<span class="token punctuation">,</span> Configuration<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddTransient</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IEmailService<span class="token punctuation">,</span> EmailService<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 注册泛型服务</span>
        services<span class="token punctuation">.</span><span class="token function">AddScoped</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">IRepository<span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">Repository<span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IUserService</span>
<span class="token punctuation">&#123;</span>
    <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>User<span class="token punctuation">></span></span> <span class="token function">GetUserAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IUserService</span></span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IRepository<span class="token punctuation">&lt;</span>User<span class="token punctuation">></span></span> _userRepository<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">ILogger<span class="token punctuation">&lt;</span>UserService<span class="token punctuation">></span></span> _logger<span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token function">UserService</span><span class="token punctuation">(</span><span class="token class-name">IRepository<span class="token punctuation">&lt;</span>User<span class="token punctuation">></span></span> userRepository<span class="token punctuation">,</span> 
                      <span class="token class-name">ILogger<span class="token punctuation">&lt;</span>UserService<span class="token punctuation">></span></span> logger<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        _userRepository <span class="token operator">=</span> userRepository<span class="token punctuation">;</span>
        _logger <span class="token operator">=</span> logger<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>User<span class="token punctuation">></span></span> <span class="token function">GetUserAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> id<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        _logger<span class="token punctuation">.</span><span class="token function">LogInformation</span><span class="token punctuation">(</span><span class="token string">"Getting user with ID: &#123;UserId&#125;"</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">await</span> _userRepository<span class="token punctuation">.</span><span class="token function">GetByIdAsync</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h1 id="三、ASP-NET-Core-Web框架"><a href="#三、ASP-NET-Core-Web框架" class="headerlink" title="三、ASP.NET Core Web框架"></a>三、ASP.NET Core Web框架</h1><h2 id="（一）核心特性"><a href="#（一）核心特性" class="headerlink" title="（一）核心特性"></a>（一）核心特性</h2><h3 id="1-中间件管道-2"><a href="#1-中间件管道-2" class="headerlink" title="1. 中间件管道 2"></a>1. 中间件管道 <mcreference link="https://www.cnblogs.com/vipyoumay/p/7735750.html" index="2">2</mcreference></h3><figure><div class="code-wrapper"><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token comment">// Startup.cs 中间件配置</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Startup</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Configure</span><span class="token punctuation">(</span><span class="token class-name">IApplicationBuilder</span> app<span class="token punctuation">,</span> <span class="token class-name">IWebHostEnvironment</span> env<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>env<span class="token punctuation">.</span><span class="token function">IsDevelopment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            app<span class="token punctuation">.</span><span class="token function">UseDeveloperExceptionPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">&#123;</span>
            app<span class="token punctuation">.</span><span class="token function">UseExceptionHandler</span><span class="token punctuation">(</span><span class="token string">"/Error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            app<span class="token punctuation">.</span><span class="token function">UseHsts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        
        app<span class="token punctuation">.</span><span class="token function">UseHttpsRedirection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        app<span class="token punctuation">.</span><span class="token function">UseStaticFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        app<span class="token punctuation">.</span><span class="token function">UseRouting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 自定义中间件</span>
        app<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">UseMiddleware</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>RequestLoggingMiddleware<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        app<span class="token punctuation">.</span><span class="token function">UseAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        app<span class="token punctuation">.</span><span class="token function">UseAuthorization</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        app<span class="token punctuation">.</span><span class="token function">UseEndpoints</span><span class="token punctuation">(</span>endpoints <span class="token operator">=></span>
        <span class="token punctuation">&#123;</span>
            endpoints<span class="token punctuation">.</span><span class="token function">MapControllers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            endpoints<span class="token punctuation">.</span><span class="token function">MapRazorPages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 自定义中间件</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RequestLoggingMiddleware</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">RequestDelegate</span> _next<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">ILogger<span class="token punctuation">&lt;</span>RequestLoggingMiddleware<span class="token punctuation">></span></span> _logger<span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token function">RequestLoggingMiddleware</span><span class="token punctuation">(</span><span class="token class-name">RequestDelegate</span> next<span class="token punctuation">,</span> 
                                   <span class="token class-name">ILogger<span class="token punctuation">&lt;</span>RequestLoggingMiddleware<span class="token punctuation">></span></span> logger<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        _next <span class="token operator">=</span> next<span class="token punctuation">;</span>
        _logger <span class="token operator">=</span> logger<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">InvokeAsync</span><span class="token punctuation">(</span><span class="token class-name">HttpContext</span> context<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> stopwatch <span class="token operator">=</span> Stopwatch<span class="token punctuation">.</span><span class="token function">StartNew</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        _logger<span class="token punctuation">.</span><span class="token function">LogInformation</span><span class="token punctuation">(</span><span class="token string">"Request started: &#123;Method&#125; &#123;Path&#125;"</span><span class="token punctuation">,</span> 
                              context<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Method<span class="token punctuation">,</span> 
                              context<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Path<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">await</span> <span class="token function">_next</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        stopwatch<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        _logger<span class="token punctuation">.</span><span class="token function">LogInformation</span><span class="token punctuation">(</span><span class="token string">"Request completed in &#123;ElapsedMs&#125;ms"</span><span class="token punctuation">,</span> 
                              stopwatch<span class="token punctuation">.</span>ElapsedMilliseconds<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h3 id="2-Web-API开发"><a href="#2-Web-API开发" class="headerlink" title="2. Web API开发"></a>2. Web API开发</h3><figure><div class="code-wrapper"><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token comment">// 现代Web API控制器</span>
<span class="token punctuation">[</span>ApiController<span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Route</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">"api/[controller]"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UsersController</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ControllerBase</span></span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IUserService</span> _userService<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IMapper</span> _mapper<span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token function">UsersController</span><span class="token punctuation">(</span><span class="token class-name">IUserService</span> userService<span class="token punctuation">,</span> <span class="token class-name">IMapper</span> mapper<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        _userService <span class="token operator">=</span> userService<span class="token punctuation">;</span>
        _mapper <span class="token operator">=</span> mapper<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">/// &lt;summary></span>
    <span class="token comment">/// 获取用户列表</span>
    <span class="token comment">/// &lt;/summary></span>
    <span class="token comment">/// &lt;param name="pageIndex">页码&lt;/param></span>
    <span class="token comment">/// &lt;param name="pageSize">页大小&lt;/param></span>
    <span class="token comment">/// &lt;returns>用户列表&lt;/returns></span>
    <span class="token punctuation">[</span>HttpGet<span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ProducesResponseType</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">PagedResult<span class="token punctuation">&lt;</span>UserDto<span class="token punctuation">></span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>ActionResult<span class="token punctuation">&lt;</span>PagedResult<span class="token punctuation">&lt;</span>UserDto<span class="token punctuation">></span><span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token function">GetUsers</span><span class="token punctuation">(</span>
        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">FromQuery</span></span><span class="token punctuation">]</span> <span class="token class-name"><span class="token keyword">int</span></span> pageIndex <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> 
        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">FromQuery</span></span><span class="token punctuation">]</span> <span class="token class-name"><span class="token keyword">int</span></span> pageSize <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> users <span class="token operator">=</span> <span class="token keyword">await</span> _userService<span class="token punctuation">.</span><span class="token function">GetUsersAsync</span><span class="token punctuation">(</span>pageIndex<span class="token punctuation">,</span> pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> userDtos <span class="token operator">=</span> _mapper<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Map</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>PagedResult<span class="token punctuation">&lt;</span>UserDto<span class="token punctuation">></span><span class="token punctuation">></span></span></span><span class="token punctuation">(</span>users<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">return</span> <span class="token function">Ok</span><span class="token punctuation">(</span>userDtos<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">/// &lt;summary></span>
    <span class="token comment">/// 根据ID获取用户</span>
    <span class="token comment">/// &lt;/summary></span>
    <span class="token comment">/// &lt;param name="id">用户ID&lt;/param></span>
    <span class="token comment">/// &lt;returns>用户信息&lt;/returns></span>
    <span class="token punctuation">[</span><span class="token function">HttpGet</span><span class="token punctuation">(</span><span class="token string">"&#123;id:int&#125;"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ProducesResponseType</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">UserDto</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ProducesResponseType</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>ActionResult<span class="token punctuation">&lt;</span>UserDto<span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token function">GetUser</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> id<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> user <span class="token operator">=</span> <span class="token keyword">await</span> _userService<span class="token punctuation">.</span><span class="token function">GetUserAsync</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token function">NotFound</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        
        <span class="token class-name"><span class="token keyword">var</span></span> userDto <span class="token operator">=</span> _mapper<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Map</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>UserDto<span class="token punctuation">></span></span></span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">Ok</span><span class="token punctuation">(</span>userDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">/// &lt;summary></span>
    <span class="token comment">/// 创建新用户</span>
    <span class="token comment">/// &lt;/summary></span>
    <span class="token comment">/// &lt;param name="createUserDto">用户创建信息&lt;/param></span>
    <span class="token comment">/// &lt;returns>创建的用户信息&lt;/returns></span>
    <span class="token punctuation">[</span>HttpPost<span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ProducesResponseType</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">UserDto</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">201</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ProducesResponseType</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>ActionResult<span class="token punctuation">&lt;</span>UserDto<span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token function">CreateUser</span><span class="token punctuation">(</span>
        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">FromBody</span></span><span class="token punctuation">]</span> <span class="token class-name">CreateUserDto</span> createUserDto<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ModelState<span class="token punctuation">.</span>IsValid<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token function">BadRequest</span><span class="token punctuation">(</span>ModelState<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        
        <span class="token class-name"><span class="token keyword">var</span></span> user <span class="token operator">=</span> _mapper<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Map</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>User<span class="token punctuation">></span></span></span><span class="token punctuation">(</span>createUserDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> createdUser <span class="token operator">=</span> <span class="token keyword">await</span> _userService<span class="token punctuation">.</span><span class="token function">CreateUserAsync</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> userDto <span class="token operator">=</span> _mapper<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Map</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>UserDto<span class="token punctuation">></span></span></span><span class="token punctuation">(</span>createdUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">return</span> <span class="token function">CreatedAtAction</span><span class="token punctuation">(</span><span class="token keyword">nameof</span><span class="token punctuation">(</span>GetUser<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                              <span class="token keyword">new</span> <span class="token punctuation">&#123;</span> id <span class="token operator">=</span> userDto<span class="token punctuation">.</span>Id <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> 
                              userDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// DTO类定义</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserDto</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> Id <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Username <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Email <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">DateTime</span> CreatedAt <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CreateUserDto</span>
<span class="token punctuation">&#123;</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Required</span></span><span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">StringLength</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">,</span> MinimumLength <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Username <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Required</span></span><span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">EmailAddress</span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Email <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Required</span></span><span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">StringLength</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> MinimumLength <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Password <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h3 id="3-实时通信（SignalR）"><a href="#3-实时通信（SignalR）" class="headerlink" title="3. 实时通信（SignalR）"></a>3. 实时通信（SignalR）</h3><figure><div class="code-wrapper"><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token comment">// SignalR Hub</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ChatHub</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Hub</span></span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IUserService</span> _userService<span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token function">ChatHub</span><span class="token punctuation">(</span><span class="token class-name">IUserService</span> userService<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        _userService <span class="token operator">=</span> userService<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">JoinGroup</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> groupName<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">await</span> Groups<span class="token punctuation">.</span><span class="token function">AddToGroupAsync</span><span class="token punctuation">(</span>Context<span class="token punctuation">.</span>ConnectionId<span class="token punctuation">,</span> groupName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">await</span> Clients<span class="token punctuation">.</span><span class="token function">Group</span><span class="token punctuation">(</span>groupName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">SendAsync</span><span class="token punctuation">(</span><span class="token string">"UserJoined"</span><span class="token punctuation">,</span> 
                                                Context<span class="token punctuation">.</span>User<span class="token punctuation">.</span>Identity<span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">SendMessageToGroup</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> groupName<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> message<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> user <span class="token operator">=</span> <span class="token keyword">await</span> _userService<span class="token punctuation">.</span><span class="token function">GetUserAsync</span><span class="token punctuation">(</span>Context<span class="token punctuation">.</span>User<span class="token punctuation">.</span>Identity<span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">await</span> Clients<span class="token punctuation">.</span><span class="token function">Group</span><span class="token punctuation">(</span>groupName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">SendAsync</span><span class="token punctuation">(</span><span class="token string">"ReceiveMessage"</span><span class="token punctuation">,</span> 
                                                 user<span class="token punctuation">.</span>Username<span class="token punctuation">,</span> 
                                                 message<span class="token punctuation">,</span> 
                                                 DateTime<span class="token punctuation">.</span>UtcNow<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">OnDisconnectedAsync</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> exception<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token comment">// 处理断开连接逻辑</span>
        <span class="token keyword">await</span> <span class="token keyword">base</span><span class="token punctuation">.</span><span class="token function">OnDisconnectedAsync</span><span class="token punctuation">(</span>exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 客户端JavaScript代码</span>
<span class="token comment">/*
const connection = new signalR.HubConnectionBuilder()
    .withUrl("/chathub")
    .build();

connection.start().then(function () &#123;
    console.log("Connected to SignalR hub");
&#125;).catch(function (err) &#123;
    console.error(err.toString());
&#125;);

connection.on("ReceiveMessage", function (username, message, timestamp) &#123;
    const messageElement = document.createElement("div");
    messageElement.innerHTML = `&lt;strong>$&#123;username&#125;&lt;/strong>: $&#123;message&#125; &lt;small>$&#123;timestamp&#125;&lt;/small>`;
    document.getElementById("messagesList").appendChild(messageElement);
&#125;);
*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h2 id="（二）企业级特性"><a href="#（二）企业级特性" class="headerlink" title="（二）企业级特性"></a>（二）企业级特性</h2><h3 id="1-身份认证与授权"><a href="#1-身份认证与授权" class="headerlink" title="1. 身份认证与授权"></a>1. 身份认证与授权</h3><figure><div class="code-wrapper"><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token comment">// JWT身份认证配置</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JwtAuthenticationService</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IConfiguration</span> _configuration<span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token function">JwtAuthenticationService</span><span class="token punctuation">(</span><span class="token class-name">IConfiguration</span> configuration<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        _configuration <span class="token operator">=</span> configuration<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ConfigureJwtAuthentication</span><span class="token punctuation">(</span><span class="token class-name">IServiceCollection</span> services<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> jwtSettings <span class="token operator">=</span> _configuration<span class="token punctuation">.</span><span class="token function">GetSection</span><span class="token punctuation">(</span><span class="token string">"JwtSettings"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> secretKey <span class="token operator">=</span> Encoding<span class="token punctuation">.</span>ASCII<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>jwtSettings<span class="token punctuation">[</span><span class="token string">"SecretKey"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        services<span class="token punctuation">.</span><span class="token function">AddAuthentication</span><span class="token punctuation">(</span>options <span class="token operator">=></span>
        <span class="token punctuation">&#123;</span>
            options<span class="token punctuation">.</span>DefaultAuthenticateScheme <span class="token operator">=</span> JwtBearerDefaults<span class="token punctuation">.</span>AuthenticationScheme<span class="token punctuation">;</span>
            options<span class="token punctuation">.</span>DefaultChallengeScheme <span class="token operator">=</span> JwtBearerDefaults<span class="token punctuation">.</span>AuthenticationScheme<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">AddJwtBearer</span><span class="token punctuation">(</span>options <span class="token operator">=></span>
        <span class="token punctuation">&#123;</span>
            options<span class="token punctuation">.</span>RequireHttpsMetadata <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            options<span class="token punctuation">.</span>SaveToken <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            options<span class="token punctuation">.</span>TokenValidationParameters <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">TokenValidationParameters</span>
            <span class="token punctuation">&#123;</span>
                ValidateIssuerSigningKey <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                IssuerSigningKey <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SymmetricSecurityKey</span><span class="token punctuation">(</span>secretKey<span class="token punctuation">)</span><span class="token punctuation">,</span>
                ValidateIssuer <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                ValidIssuer <span class="token operator">=</span> jwtSettings<span class="token punctuation">[</span><span class="token string">"Issuer"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                ValidateAudience <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                ValidAudience <span class="token operator">=</span> jwtSettings<span class="token punctuation">[</span><span class="token string">"Audience"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                ValidateLifetime <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                ClockSkew <span class="token operator">=</span> TimeSpan<span class="token punctuation">.</span>Zero
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">GenerateJwtToken</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> jwtSettings <span class="token operator">=</span> _configuration<span class="token punctuation">.</span><span class="token function">GetSection</span><span class="token punctuation">(</span><span class="token string">"JwtSettings"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> secretKey <span class="token operator">=</span> Encoding<span class="token punctuation">.</span>ASCII<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>jwtSettings<span class="token punctuation">[</span><span class="token string">"SecretKey"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token class-name"><span class="token keyword">var</span></span> claims <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Claim</span><span class="token punctuation">(</span>ClaimTypes<span class="token punctuation">.</span>NameIdentifier<span class="token punctuation">,</span> user<span class="token punctuation">.</span>Id<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Claim</span><span class="token punctuation">(</span>ClaimTypes<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> user<span class="token punctuation">.</span>Username<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Claim</span><span class="token punctuation">(</span>ClaimTypes<span class="token punctuation">.</span>Email<span class="token punctuation">,</span> user<span class="token punctuation">.</span>Email<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Claim</span><span class="token punctuation">(</span><span class="token string">"role"</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span>Role<span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        
        <span class="token class-name"><span class="token keyword">var</span></span> tokenDescriptor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SecurityTokenDescriptor</span>
        <span class="token punctuation">&#123;</span>
            Subject <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ClaimsIdentity</span><span class="token punctuation">(</span>claims<span class="token punctuation">)</span><span class="token punctuation">,</span>
            Expires <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>UtcNow<span class="token punctuation">.</span><span class="token function">AddHours</span><span class="token punctuation">(</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            Issuer <span class="token operator">=</span> jwtSettings<span class="token punctuation">[</span><span class="token string">"Issuer"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            Audience <span class="token operator">=</span> jwtSettings<span class="token punctuation">[</span><span class="token string">"Audience"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            SigningCredentials <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SigningCredentials</span><span class="token punctuation">(</span>
                <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SymmetricSecurityKey</span><span class="token punctuation">(</span>secretKey<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                SecurityAlgorithms<span class="token punctuation">.</span>HmacSha256Signature<span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        
        <span class="token class-name"><span class="token keyword">var</span></span> tokenHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JwtSecurityTokenHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> token <span class="token operator">=</span> tokenHandler<span class="token punctuation">.</span><span class="token function">CreateToken</span><span class="token punctuation">(</span>tokenDescriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">return</span> tokenHandler<span class="token punctuation">.</span><span class="token function">WriteToken</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 基于策略的授权</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthorizationPolicies</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ConfigurePolicies</span><span class="token punctuation">(</span><span class="token class-name">IServiceCollection</span> services<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        services<span class="token punctuation">.</span><span class="token function">AddAuthorization</span><span class="token punctuation">(</span>options <span class="token operator">=></span>
        <span class="token punctuation">&#123;</span>
            <span class="token comment">// 管理员策略</span>
            options<span class="token punctuation">.</span><span class="token function">AddPolicy</span><span class="token punctuation">(</span><span class="token string">"AdminOnly"</span><span class="token punctuation">,</span> policy <span class="token operator">=></span>
                policy<span class="token punctuation">.</span><span class="token function">RequireRole</span><span class="token punctuation">(</span><span class="token string">"Admin"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token comment">// 年龄要求策略</span>
            options<span class="token punctuation">.</span><span class="token function">AddPolicy</span><span class="token punctuation">(</span><span class="token string">"MinimumAge"</span><span class="token punctuation">,</span> policy <span class="token operator">=></span>
                policy<span class="token punctuation">.</span>Requirements<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">MinimumAgeRequirement</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token comment">// 复合策略</span>
            options<span class="token punctuation">.</span><span class="token function">AddPolicy</span><span class="token punctuation">(</span><span class="token string">"AdminOrOwner"</span><span class="token punctuation">,</span> policy <span class="token operator">=></span>
                policy<span class="token punctuation">.</span><span class="token function">RequireAssertion</span><span class="token punctuation">(</span>context <span class="token operator">=></span>
                    context<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">IsInRole</span><span class="token punctuation">(</span><span class="token string">"Admin"</span><span class="token punctuation">)</span> <span class="token operator">||</span>
                    context<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">HasClaim</span><span class="token punctuation">(</span><span class="token string">"UserId"</span><span class="token punctuation">,</span> 
                        context<span class="token punctuation">.</span>Resource<span class="token punctuation">?.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddScoped</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IAuthorizationHandler<span class="token punctuation">,</span> MinimumAgeHandler<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 自定义授权要求</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MinimumAgeRequirement</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IAuthorizationRequirement</span></span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> MinimumAge <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">public</span> <span class="token function">MinimumAgeRequirement</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> minimumAge<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        MinimumAge <span class="token operator">=</span> minimumAge<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MinimumAgeHandler</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">AuthorizationHandler<span class="token punctuation">&lt;</span>MinimumAgeRequirement<span class="token punctuation">></span></span></span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token return-type class-name">Task</span> <span class="token function">HandleRequirementAsync</span><span class="token punctuation">(</span>
        <span class="token class-name">AuthorizationHandlerContext</span> context<span class="token punctuation">,</span>
        <span class="token class-name">MinimumAgeRequirement</span> requirement<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> birthDateClaim <span class="token operator">=</span> context<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">FindFirst</span><span class="token punctuation">(</span><span class="token string">"birthdate"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span>birthDateClaim <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> 
            DateTime<span class="token punctuation">.</span><span class="token function">TryParse</span><span class="token punctuation">(</span>birthDateClaim<span class="token punctuation">.</span>Value<span class="token punctuation">,</span> <span class="token keyword">out</span> <span class="token class-name"><span class="token keyword">var</span></span> birthDate<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> age <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>Today<span class="token punctuation">.</span>Year <span class="token operator">-</span> birthDate<span class="token punctuation">.</span>Year<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>birthDate<span class="token punctuation">.</span>Date <span class="token operator">></span> DateTime<span class="token punctuation">.</span>Today<span class="token punctuation">.</span><span class="token function">AddYears</span><span class="token punctuation">(</span><span class="token operator">-</span>age<span class="token punctuation">)</span><span class="token punctuation">)</span>
                age<span class="token operator">--</span><span class="token punctuation">;</span>
            
            <span class="token keyword">if</span> <span class="token punctuation">(</span>age <span class="token operator">>=</span> requirement<span class="token punctuation">.</span>MinimumAge<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                context<span class="token punctuation">.</span><span class="token function">Succeed</span><span class="token punctuation">(</span>requirement<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        
        <span class="token keyword">return</span> Task<span class="token punctuation">.</span>CompletedTask<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h3 id="2-数据访问（Entity-Framework-Core）"><a href="#2-数据访问（Entity-Framework-Core）" class="headerlink" title="2. 数据访问（Entity Framework Core）"></a>2. 数据访问（Entity Framework Core）</h3><figure><div class="code-wrapper"><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token comment">// Entity Framework Core配置</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ApplicationDbContext</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">DbContext</span></span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token function">ApplicationDbContext</span><span class="token punctuation">(</span><span class="token class-name">DbContextOptions<span class="token punctuation">&lt;</span>ApplicationDbContext<span class="token punctuation">></span></span> options<span class="token punctuation">)</span>
        <span class="token punctuation">:</span> <span class="token keyword">base</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">public</span> <span class="token return-type class-name">DbSet<span class="token punctuation">&lt;</span>User<span class="token punctuation">></span></span> Users <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">DbSet<span class="token punctuation">&lt;</span>Order<span class="token punctuation">></span></span> Orders <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">DbSet<span class="token punctuation">&lt;</span>Product<span class="token punctuation">></span></span> Products <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnModelCreating</span><span class="token punctuation">(</span><span class="token class-name">ModelBuilder</span> modelBuilder<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token comment">// 用户实体配置</span>
        modelBuilder<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Entity</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>User<span class="token punctuation">></span></span></span><span class="token punctuation">(</span>entity <span class="token operator">=></span>
        <span class="token punctuation">&#123;</span>
            entity<span class="token punctuation">.</span><span class="token function">HasKey</span><span class="token punctuation">(</span>e <span class="token operator">=></span> e<span class="token punctuation">.</span>Id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            entity<span class="token punctuation">.</span><span class="token function">Property</span><span class="token punctuation">(</span>e <span class="token operator">=></span> e<span class="token punctuation">.</span>Username<span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">IsRequired</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">HasMaxLength</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            entity<span class="token punctuation">.</span><span class="token function">Property</span><span class="token punctuation">(</span>e <span class="token operator">=></span> e<span class="token punctuation">.</span>Email<span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">IsRequired</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">HasMaxLength</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            entity<span class="token punctuation">.</span><span class="token function">HasIndex</span><span class="token punctuation">(</span>e <span class="token operator">=></span> e<span class="token punctuation">.</span>Email<span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">IsUnique</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 订单实体配置</span>
        modelBuilder<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Entity</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Order<span class="token punctuation">></span></span></span><span class="token punctuation">(</span>entity <span class="token operator">=></span>
        <span class="token punctuation">&#123;</span>
            entity<span class="token punctuation">.</span><span class="token function">HasKey</span><span class="token punctuation">(</span>e <span class="token operator">=></span> e<span class="token punctuation">.</span>Id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            entity<span class="token punctuation">.</span><span class="token function">Property</span><span class="token punctuation">(</span>e <span class="token operator">=></span> e<span class="token punctuation">.</span>TotalAmount<span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">HasColumnType</span><span class="token punctuation">(</span><span class="token string">"decimal(18,2)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            entity<span class="token punctuation">.</span><span class="token function">HasOne</span><span class="token punctuation">(</span>e <span class="token operator">=></span> e<span class="token punctuation">.</span>User<span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">WithMany</span><span class="token punctuation">(</span>e <span class="token operator">=></span> e<span class="token punctuation">.</span>Orders<span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">HasForeignKey</span><span class="token punctuation">(</span>e <span class="token operator">=></span> e<span class="token punctuation">.</span>UserId<span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">OnDelete</span><span class="token punctuation">(</span>DeleteBehavior<span class="token punctuation">.</span>Restrict<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 种子数据</span>
        modelBuilder<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Entity</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>User<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">HasData</span><span class="token punctuation">(</span>
            <span class="token keyword">new</span> <span class="token constructor-invocation class-name">User</span> <span class="token punctuation">&#123;</span> Id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> Username <span class="token operator">=</span> <span class="token string">"admin"</span><span class="token punctuation">,</span> Email <span class="token operator">=</span> <span class="token string">"admin@example.com"</span> <span class="token punctuation">&#125;</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 仓储模式实现</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IRepository<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> <span class="token keyword">where</span> <span class="token class-name">T</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token keyword">class</span></span>
<span class="token punctuation">&#123;</span>
    <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> <span class="token function">GetByIdAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>IEnumerable<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token function">GetAllAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> <span class="token function">AddAsync</span><span class="token punctuation">(</span><span class="token class-name">T</span> entity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token return-type class-name">Task</span> <span class="token function">UpdateAsync</span><span class="token punctuation">(</span><span class="token class-name">T</span> entity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token return-type class-name">Task</span> <span class="token function">DeleteAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Repository<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IRepository<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span></span> <span class="token keyword">where</span> <span class="token class-name">T</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token keyword">class</span></span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">ApplicationDbContext</span> _context<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">DbSet<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> _dbSet<span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token function">Repository</span><span class="token punctuation">(</span><span class="token class-name">ApplicationDbContext</span> context<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        _context <span class="token operator">=</span> context<span class="token punctuation">;</span>
        _dbSet <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Set</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> <span class="token function">GetByIdAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> id<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">await</span> _dbSet<span class="token punctuation">.</span><span class="token function">FindAsync</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>IEnumerable<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token function">GetAllAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">await</span> _dbSet<span class="token punctuation">.</span><span class="token function">ToListAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> <span class="token function">AddAsync</span><span class="token punctuation">(</span><span class="token class-name">T</span> entity<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">await</span> _dbSet<span class="token punctuation">.</span><span class="token function">AddAsync</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">await</span> _context<span class="token punctuation">.</span><span class="token function">SaveChangesAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> entity<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">UpdateAsync</span><span class="token punctuation">(</span><span class="token class-name">T</span> entity<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        _dbSet<span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">await</span> _context<span class="token punctuation">.</span><span class="token function">SaveChangesAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">DeleteAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> id<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> entity <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">GetByIdAsync</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>entity <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            _dbSet<span class="token punctuation">.</span><span class="token function">Remove</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">await</span> _context<span class="token punctuation">.</span><span class="token function">SaveChangesAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h1 id="四、-NET微服务架构"><a href="#四、-NET微服务架构" class="headerlink" title="四、.NET微服务架构"></a>四、.NET微服务架构</h1><h2 id="（一）微服务架构概述-1"><a href="#（一）微服务架构概述-1" class="headerlink" title="（一）微服务架构概述 1"></a>（一）微服务架构概述 <mcreference link="https://blog.csdn.net/weixin_55959870/article/details/122474430" index="1">1</mcreference></h2><h3 id="1-微服务设计原则-1"><a href="#1-微服务设计原则-1" class="headerlink" title="1. 微服务设计原则 1"></a>1. 微服务设计原则 <mcreference link="https://blog.csdn.net/weixin_55959870/article/details/122474430" index="1">1</mcreference></h3><ul>
<li><strong>垂直划分优先原则</strong>：根据业务领域对服务进行垂直划分</li>
<li><strong>持续演进原则</strong>：逐步划分和持续演进，避免服务数量爆炸性增长</li>
<li><strong>服务自治、接口隔离原则</strong>：通过标准接口隔离，隐藏内部实现细节</li>
<li><strong>自动化驱动原则</strong>：构建自动化工具及环境</li>
</ul>
<h3 id="2-微服务核心组件"><a href="#2-微服务核心组件" class="headerlink" title="2. 微服务核心组件"></a>2. 微服务核心组件</h3><figure><div class="code-wrapper"><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token comment">// 服务注册与发现</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ServiceDiscovery</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IConsulClient</span> _consulClient<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">ILogger<span class="token punctuation">&lt;</span>ServiceDiscovery<span class="token punctuation">></span></span> _logger<span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token function">ServiceDiscovery</span><span class="token punctuation">(</span><span class="token class-name">IConsulClient</span> consulClient<span class="token punctuation">,</span> 
                           <span class="token class-name">ILogger<span class="token punctuation">&lt;</span>ServiceDiscovery<span class="token punctuation">></span></span> logger<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        _consulClient <span class="token operator">=</span> consulClient<span class="token punctuation">;</span>
        _logger <span class="token operator">=</span> logger<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">// 注册服务</span>
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">RegisterServiceAsync</span><span class="token punctuation">(</span><span class="token class-name">ServiceRegistration</span> registration<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> consulRegistration <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">AgentServiceRegistration</span>
        <span class="token punctuation">&#123;</span>
            ID <span class="token operator">=</span> registration<span class="token punctuation">.</span>Id<span class="token punctuation">,</span>
            Name <span class="token operator">=</span> registration<span class="token punctuation">.</span>Name<span class="token punctuation">,</span>
            Address <span class="token operator">=</span> registration<span class="token punctuation">.</span>Address<span class="token punctuation">,</span>
            Port <span class="token operator">=</span> registration<span class="token punctuation">.</span>Port<span class="token punctuation">,</span>
            Tags <span class="token operator">=</span> registration<span class="token punctuation">.</span>Tags<span class="token punctuation">,</span>
            Check <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">AgentServiceCheck</span>
            <span class="token punctuation">&#123;</span>
                HTTP <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">$"http://</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">registration<span class="token punctuation">.</span>Address</span><span class="token punctuation">&#125;</span></span><span class="token string">:</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">registration<span class="token punctuation">.</span>Port</span><span class="token punctuation">&#125;</span></span><span class="token string">/health"</span></span><span class="token punctuation">,</span>
                Interval <span class="token operator">=</span> TimeSpan<span class="token punctuation">.</span><span class="token function">FromSeconds</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                Timeout <span class="token operator">=</span> TimeSpan<span class="token punctuation">.</span><span class="token function">FromSeconds</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        
        <span class="token keyword">await</span> _consulClient<span class="token punctuation">.</span>Agent<span class="token punctuation">.</span><span class="token function">ServiceRegister</span><span class="token punctuation">(</span>consulRegistration<span class="token punctuation">)</span><span class="token punctuation">;</span>
        _logger<span class="token punctuation">.</span><span class="token function">LogInformation</span><span class="token punctuation">(</span><span class="token string">"Service &#123;ServiceName&#125; registered with ID &#123;ServiceId&#125;"</span><span class="token punctuation">,</span> 
                              registration<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> registration<span class="token punctuation">.</span>Id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">// 发现服务</span>
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span>ServiceInstance<span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token function">DiscoverServicesAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> serviceName<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> services <span class="token operator">=</span> <span class="token keyword">await</span> _consulClient<span class="token punctuation">.</span>Health<span class="token punctuation">.</span><span class="token function">Service</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> 
                                                          <span class="token keyword">string</span><span class="token punctuation">.</span>Empty<span class="token punctuation">,</span> 
                                                          <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">return</span> services<span class="token punctuation">.</span>Response<span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>s <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ServiceInstance</span>
        <span class="token punctuation">&#123;</span>
            Id <span class="token operator">=</span> s<span class="token punctuation">.</span>Service<span class="token punctuation">.</span>ID<span class="token punctuation">,</span>
            Name <span class="token operator">=</span> s<span class="token punctuation">.</span>Service<span class="token punctuation">.</span>Service<span class="token punctuation">,</span>
            Address <span class="token operator">=</span> s<span class="token punctuation">.</span>Service<span class="token punctuation">.</span>Address<span class="token punctuation">,</span>
            Port <span class="token operator">=</span> s<span class="token punctuation">.</span>Service<span class="token punctuation">.</span>Port
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 服务实例模型</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ServiceInstance</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Id <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Name <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Address <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> Port <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ServiceRegistration</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Id <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Name <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Address <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> Port <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> Tags <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h3 id="3-API网关实现"><a href="#3-API网关实现" class="headerlink" title="3. API网关实现"></a>3. API网关实现</h3><figure><div class="code-wrapper"><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token comment">// Ocelot API网关配置</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ApiGatewayConfiguration</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ConfigureOcelot</span><span class="token punctuation">(</span><span class="token class-name">IServiceCollection</span> services<span class="token punctuation">,</span> 
                               <span class="token class-name">IConfiguration</span> configuration<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        services<span class="token punctuation">.</span><span class="token function">AddOcelot</span><span class="token punctuation">(</span>configuration<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">AddConsul</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">AddPolly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 添加认证</span>
        services<span class="token punctuation">.</span><span class="token function">AddAuthentication</span><span class="token punctuation">(</span><span class="token string">"Bearer"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">AddJwtBearer</span><span class="token punctuation">(</span><span class="token string">"Bearer"</span><span class="token punctuation">,</span> options <span class="token operator">=></span>
                <span class="token punctuation">&#123;</span>
                    options<span class="token punctuation">.</span>Authority <span class="token operator">=</span> configuration<span class="token punctuation">[</span><span class="token string">"IdentityServer:Authority"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                    options<span class="token punctuation">.</span>RequireHttpsMetadata <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    options<span class="token punctuation">.</span>Audience <span class="token operator">=</span> <span class="token string">"api1"</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ConfigureOcelotPipeline</span><span class="token punctuation">(</span><span class="token class-name">IApplicationBuilder</span> app<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        app<span class="token punctuation">.</span><span class="token function">UseOcelot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// ocelot.json配置示例</span>
<span class="token comment">/*
&#123;
  "Routes": [
    &#123;
      "DownstreamPathTemplate": "/api/users/&#123;everything&#125;",
      "DownstreamScheme": "http",
      "ServiceName": "user-service",
      "LoadBalancerOptions": &#123;
        "Type": "RoundRobin"
      &#125;,
      "UpstreamPathTemplate": "/api/users/&#123;everything&#125;",
      "UpstreamHttpMethod": [ "GET", "POST", "PUT", "DELETE" ],
      "AuthenticationOptions": &#123;
        "AuthenticationProviderKey": "Bearer",
        "AllowedScopes": []
      &#125;,
      "RateLimitOptions": &#123;
        "ClientWhitelist": [],
        "EnableRateLimiting": true,
        "Period": "1m",
        "PeriodTimespan": 60,
        "Limit": 100
      &#125;
    &#125;
  ],
  "GlobalConfiguration": &#123;
    "ServiceDiscoveryProvider": &#123;
      "Host": "localhost",
      "Port": 8500,
      "Type": "Consul"
    &#125;
  &#125;
&#125;
*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h2 id="（二）微服务通信模式-3"><a href="#（二）微服务通信模式-3" class="headerlink" title="（二）微服务通信模式 3"></a>（二）微服务通信模式 <mcreference link="https://www.cnblogs.com/edisonchou/p/dotnetcore_microservice_foundation_blogs_index_final.html" index="3">3</mcreference></h2><h3 id="1-HTTP-REST通信"><a href="#1-HTTP-REST通信" class="headerlink" title="1. HTTP REST通信"></a>1. HTTP REST通信</h3><figure><div class="code-wrapper"><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token comment">// HTTP客户端服务</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserServiceClient</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">HttpClient</span> _httpClient<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">ILogger<span class="token punctuation">&lt;</span>UserServiceClient<span class="token punctuation">></span></span> _logger<span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token function">UserServiceClient</span><span class="token punctuation">(</span><span class="token class-name">HttpClient</span> httpClient<span class="token punctuation">,</span> 
                            <span class="token class-name">ILogger<span class="token punctuation">&lt;</span>UserServiceClient<span class="token punctuation">></span></span> logger<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        _httpClient <span class="token operator">=</span> httpClient<span class="token punctuation">;</span>
        _logger <span class="token operator">=</span> logger<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>UserDto<span class="token punctuation">></span></span> <span class="token function">GetUserAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> userId<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span>
        <span class="token punctuation">&#123;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> response <span class="token operator">=</span> <span class="token keyword">await</span> _httpClient<span class="token punctuation">.</span><span class="token function">GetAsync</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"/api/users/</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">userId</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            response<span class="token punctuation">.</span><span class="token function">EnsureSuccessStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token class-name"><span class="token keyword">var</span></span> content <span class="token operator">=</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span>Content<span class="token punctuation">.</span><span class="token function">ReadAsStringAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> JsonSerializer<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Deserialize</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>UserDto<span class="token punctuation">></span></span></span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> 
                <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JsonSerializerOptions</span> <span class="token punctuation">&#123;</span> PropertyNameCaseInsensitive <span class="token operator">=</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">HttpRequestException</span> ex<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            _logger<span class="token punctuation">.</span><span class="token function">LogError</span><span class="token punctuation">(</span>ex<span class="token punctuation">,</span> <span class="token string">"Error calling user service for user &#123;UserId&#125;"</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 服务注册</span>
<span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ConfigureHttpClients</span><span class="token punctuation">(</span><span class="token class-name">IServiceCollection</span> services<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddHttpClient</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>UserServiceClient<span class="token punctuation">></span></span></span><span class="token punctuation">(</span>client <span class="token operator">=></span>
    <span class="token punctuation">&#123;</span>
        client<span class="token punctuation">.</span>BaseAddress <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Uri</span><span class="token punctuation">(</span><span class="token string">"http://user-service"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        client<span class="token punctuation">.</span>Timeout <span class="token operator">=</span> TimeSpan<span class="token punctuation">.</span><span class="token function">FromSeconds</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">AddPolicyHandler</span><span class="token punctuation">(</span><span class="token function">GetRetryPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">AddPolicyHandler</span><span class="token punctuation">(</span><span class="token function">GetCircuitBreakerPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 重试策略</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name">IAsyncPolicy<span class="token punctuation">&lt;</span>HttpResponseMessage<span class="token punctuation">></span></span> <span class="token function">GetRetryPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> HttpPolicyExtensions
        <span class="token punctuation">.</span><span class="token function">HandleTransientHttpError</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">WaitAndRetryAsync</span><span class="token punctuation">(</span>
            <span class="token named-parameter punctuation">retryCount</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
            <span class="token named-parameter punctuation">sleepDurationProvider</span><span class="token punctuation">:</span> retryAttempt <span class="token operator">=></span> 
                TimeSpan<span class="token punctuation">.</span><span class="token function">FromSeconds</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">Pow</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> retryAttempt<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token named-parameter punctuation">onRetry</span><span class="token punctuation">:</span> <span class="token punctuation">(</span>outcome<span class="token punctuation">,</span> timespan<span class="token punctuation">,</span> retryCount<span class="token punctuation">,</span> context<span class="token punctuation">)</span> <span class="token operator">=></span>
            <span class="token punctuation">&#123;</span>
                Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"Retry </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">retryCount</span><span class="token punctuation">&#125;</span></span><span class="token string"> after </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">timespan</span><span class="token punctuation">&#125;</span></span><span class="token string"> seconds"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 熔断策略</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name">IAsyncPolicy<span class="token punctuation">&lt;</span>HttpResponseMessage<span class="token punctuation">></span></span> <span class="token function">GetCircuitBreakerPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> HttpPolicyExtensions
        <span class="token punctuation">.</span><span class="token function">HandleTransientHttpError</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">CircuitBreakerAsync</span><span class="token punctuation">(</span>
            <span class="token named-parameter punctuation">handledEventsAllowedBeforeBreaking</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
            <span class="token named-parameter punctuation">durationOfBreak</span><span class="token punctuation">:</span> TimeSpan<span class="token punctuation">.</span><span class="token function">FromSeconds</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token named-parameter punctuation">onBreak</span><span class="token punctuation">:</span> <span class="token punctuation">(</span>exception<span class="token punctuation">,</span> duration<span class="token punctuation">)</span> <span class="token operator">=></span>
            <span class="token punctuation">&#123;</span>
                Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"Circuit breaker opened for </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">duration</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
            <span class="token named-parameter punctuation">onReset</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span>
            <span class="token punctuation">&#123;</span>
                Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Circuit breaker reset"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h3 id="2-消息队列通信"><a href="#2-消息队列通信" class="headerlink" title="2. 消息队列通信"></a>2. 消息队列通信</h3><figure><div class="code-wrapper"><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token comment">// RabbitMQ消息发布者</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MessagePublisher</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IConnection</span> _connection<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IModel</span> _channel<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">ILogger<span class="token punctuation">&lt;</span>MessagePublisher<span class="token punctuation">></span></span> _logger<span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token function">MessagePublisher</span><span class="token punctuation">(</span><span class="token class-name">IConnectionFactory</span> connectionFactory<span class="token punctuation">,</span> 
                           <span class="token class-name">ILogger<span class="token punctuation">&lt;</span>MessagePublisher<span class="token punctuation">></span></span> logger<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        _connection <span class="token operator">=</span> connectionFactory<span class="token punctuation">.</span><span class="token function">CreateConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        _channel <span class="token operator">=</span> _connection<span class="token punctuation">.</span><span class="token function">CreateModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        _logger <span class="token operator">=</span> logger<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token generic-method"><span class="token function">PublishAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> exchange<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> routingKey<span class="token punctuation">,</span> <span class="token class-name">T</span> message<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span>
        <span class="token punctuation">&#123;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> json <span class="token operator">=</span> JsonSerializer<span class="token punctuation">.</span><span class="token function">Serialize</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> body <span class="token operator">=</span> Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token class-name"><span class="token keyword">var</span></span> properties <span class="token operator">=</span> _channel<span class="token punctuation">.</span><span class="token function">CreateBasicProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            properties<span class="token punctuation">.</span>Persistent <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            properties<span class="token punctuation">.</span>MessageId <span class="token operator">=</span> Guid<span class="token punctuation">.</span><span class="token function">NewGuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            properties<span class="token punctuation">.</span>Timestamp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">AmqpTimestamp</span><span class="token punctuation">(</span>DateTimeOffset<span class="token punctuation">.</span>UtcNow<span class="token punctuation">.</span><span class="token function">ToUnixTimeSeconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            _channel<span class="token punctuation">.</span><span class="token function">BasicPublish</span><span class="token punctuation">(</span>
                <span class="token named-parameter punctuation">exchange</span><span class="token punctuation">:</span> exchange<span class="token punctuation">,</span>
                <span class="token named-parameter punctuation">routingKey</span><span class="token punctuation">:</span> routingKey<span class="token punctuation">,</span>
                <span class="token named-parameter punctuation">basicProperties</span><span class="token punctuation">:</span> properties<span class="token punctuation">,</span>
                <span class="token named-parameter punctuation">body</span><span class="token punctuation">:</span> body<span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            _logger<span class="token punctuation">.</span><span class="token function">LogInformation</span><span class="token punctuation">(</span><span class="token string">"Message published to &#123;Exchange&#125;/&#123;RoutingKey&#125;"</span><span class="token punctuation">,</span> 
                                  exchange<span class="token punctuation">,</span> routingKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            _logger<span class="token punctuation">.</span><span class="token function">LogError</span><span class="token punctuation">(</span>ex<span class="token punctuation">,</span> <span class="token string">"Error publishing message to &#123;Exchange&#125;/&#123;RoutingKey&#125;"</span><span class="token punctuation">,</span> 
                            exchange<span class="token punctuation">,</span> routingKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 消息消费者</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MessageConsumer</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">BackgroundService</span></span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IConnection</span> _connection<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IModel</span> _channel<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IServiceProvider</span> _serviceProvider<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">ILogger<span class="token punctuation">&lt;</span>MessageConsumer<span class="token punctuation">></span></span> _logger<span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token function">MessageConsumer</span><span class="token punctuation">(</span><span class="token class-name">IConnectionFactory</span> connectionFactory<span class="token punctuation">,</span>
                          <span class="token class-name">IServiceProvider</span> serviceProvider<span class="token punctuation">,</span>
                          <span class="token class-name">ILogger<span class="token punctuation">&lt;</span>MessageConsumer<span class="token punctuation">></span></span> logger<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        _connection <span class="token operator">=</span> connectionFactory<span class="token punctuation">.</span><span class="token function">CreateConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        _channel <span class="token operator">=</span> _connection<span class="token punctuation">.</span><span class="token function">CreateModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        _serviceProvider <span class="token operator">=</span> serviceProvider<span class="token punctuation">;</span>
        _logger <span class="token operator">=</span> logger<span class="token punctuation">;</span>
        
        <span class="token function">SetupQueues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">SetupQueues</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        _channel<span class="token punctuation">.</span><span class="token function">ExchangeDeclare</span><span class="token punctuation">(</span><span class="token string">"user.events"</span><span class="token punctuation">,</span> ExchangeType<span class="token punctuation">.</span>Topic<span class="token punctuation">,</span> <span class="token named-parameter punctuation">durable</span><span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        _channel<span class="token punctuation">.</span><span class="token function">QueueDeclare</span><span class="token punctuation">(</span><span class="token string">"user.created"</span><span class="token punctuation">,</span> <span class="token named-parameter punctuation">durable</span><span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token named-parameter punctuation">exclusive</span><span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token named-parameter punctuation">autoDelete</span><span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        _channel<span class="token punctuation">.</span><span class="token function">QueueBind</span><span class="token punctuation">(</span><span class="token string">"user.created"</span><span class="token punctuation">,</span> <span class="token string">"user.events"</span><span class="token punctuation">,</span> <span class="token string">"user.created"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token return-type class-name">Task</span> <span class="token function">ExecuteAsync</span><span class="token punctuation">(</span><span class="token class-name">CancellationToken</span> stoppingToken<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">EventingBasicConsumer</span><span class="token punctuation">(</span>_channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        consumer<span class="token punctuation">.</span>Received <span class="token operator">+=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>model<span class="token punctuation">,</span> ea<span class="token punctuation">)</span> <span class="token operator">=></span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">try</span>
            <span class="token punctuation">&#123;</span>
                <span class="token class-name"><span class="token keyword">var</span></span> body <span class="token operator">=</span> ea<span class="token punctuation">.</span>Body<span class="token punctuation">.</span><span class="token function">ToArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name"><span class="token keyword">var</span></span> message <span class="token operator">=</span> Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">.</span><span class="token function">GetString</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
                
                <span class="token keyword">await</span> <span class="token function">ProcessMessageAsync</span><span class="token punctuation">(</span>ea<span class="token punctuation">.</span>RoutingKey<span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
                
                _channel<span class="token punctuation">.</span><span class="token function">BasicAck</span><span class="token punctuation">(</span>ea<span class="token punctuation">.</span>DeliveryTag<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                _logger<span class="token punctuation">.</span><span class="token function">LogError</span><span class="token punctuation">(</span>ex<span class="token punctuation">,</span> <span class="token string">"Error processing message"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                _channel<span class="token punctuation">.</span><span class="token function">BasicNack</span><span class="token punctuation">(</span>ea<span class="token punctuation">.</span>DeliveryTag<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        
        _channel<span class="token punctuation">.</span><span class="token function">BasicConsume</span><span class="token punctuation">(</span><span class="token named-parameter punctuation">queue</span><span class="token punctuation">:</span> <span class="token string">"user.created"</span><span class="token punctuation">,</span> <span class="token named-parameter punctuation">autoAck</span><span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token named-parameter punctuation">consumer</span><span class="token punctuation">:</span> consumer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">return</span> Task<span class="token punctuation">.</span>CompletedTask<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">private</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">ProcessMessageAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> routingKey<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> message<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">using</span> <span class="token class-name"><span class="token keyword">var</span></span> scope <span class="token operator">=</span> _serviceProvider<span class="token punctuation">.</span><span class="token function">CreateScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>routingKey<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">case</span> <span class="token string">"user.created"</span><span class="token punctuation">:</span>
                <span class="token class-name"><span class="token keyword">var</span></span> userCreatedEvent <span class="token operator">=</span> JsonSerializer<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Deserialize</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>UserCreatedEvent<span class="token punctuation">></span></span></span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name"><span class="token keyword">var</span></span> handler <span class="token operator">=</span> scope<span class="token punctuation">.</span>ServiceProvider<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetRequiredService</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IUserCreatedEventHandler<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">await</span> handler<span class="token punctuation">.</span><span class="token function">HandleAsync</span><span class="token punctuation">(</span>userCreatedEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
                
            <span class="token keyword">default</span><span class="token punctuation">:</span>
                _logger<span class="token punctuation">.</span><span class="token function">LogWarning</span><span class="token punctuation">(</span><span class="token string">"Unknown routing key: &#123;RoutingKey&#125;"</span><span class="token punctuation">,</span> routingKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 事件模型</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserCreatedEvent</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> UserId <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Username <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Email <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">DateTime</span> CreatedAt <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IUserCreatedEventHandler</span>
<span class="token punctuation">&#123;</span>
    <span class="token return-type class-name">Task</span> <span class="token function">HandleAsync</span><span class="token punctuation">(</span><span class="token class-name">UserCreatedEvent</span> userCreatedEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserCreatedEventHandler</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IUserCreatedEventHandler</span></span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IEmailService</span> _emailService<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">ILogger<span class="token punctuation">&lt;</span>UserCreatedEventHandler<span class="token punctuation">></span></span> _logger<span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token function">UserCreatedEventHandler</span><span class="token punctuation">(</span><span class="token class-name">IEmailService</span> emailService<span class="token punctuation">,</span>
                                  <span class="token class-name">ILogger<span class="token punctuation">&lt;</span>UserCreatedEventHandler<span class="token punctuation">></span></span> logger<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        _emailService <span class="token operator">=</span> emailService<span class="token punctuation">;</span>
        _logger <span class="token operator">=</span> logger<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">HandleAsync</span><span class="token punctuation">(</span><span class="token class-name">UserCreatedEvent</span> userCreatedEvent<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        _logger<span class="token punctuation">.</span><span class="token function">LogInformation</span><span class="token punctuation">(</span><span class="token string">"Processing user created event for user &#123;UserId&#125;"</span><span class="token punctuation">,</span> 
                              userCreatedEvent<span class="token punctuation">.</span>UserId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 发送欢迎邮件</span>
        <span class="token keyword">await</span> _emailService<span class="token punctuation">.</span><span class="token function">SendWelcomeEmailAsync</span><span class="token punctuation">(</span>
            userCreatedEvent<span class="token punctuation">.</span>Email<span class="token punctuation">,</span> 
            userCreatedEvent<span class="token punctuation">.</span>Username<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h1 id="五、企业级开发特性"><a href="#五、企业级开发特性" class="headerlink" title="五、企业级开发特性"></a>五、企业级开发特性</h1><h2 id="（一）性能优化"><a href="#（一）性能优化" class="headerlink" title="（一）性能优化"></a>（一）性能优化</h2><h3 id="1-缓存策略"><a href="#1-缓存策略" class="headerlink" title="1. 缓存策略"></a>1. 缓存策略</h3><figure><div class="code-wrapper"><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token comment">// 分布式缓存实现</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CacheService</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IDistributedCache</span> _distributedCache<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IMemoryCache</span> _memoryCache<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">ILogger<span class="token punctuation">&lt;</span>CacheService<span class="token punctuation">></span></span> _logger<span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token function">CacheService</span><span class="token punctuation">(</span><span class="token class-name">IDistributedCache</span> distributedCache<span class="token punctuation">,</span>
                       <span class="token class-name">IMemoryCache</span> memoryCache<span class="token punctuation">,</span>
                       <span class="token class-name">ILogger<span class="token punctuation">&lt;</span>CacheService<span class="token punctuation">></span></span> logger<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        _distributedCache <span class="token operator">=</span> distributedCache<span class="token punctuation">;</span>
        _memoryCache <span class="token operator">=</span> memoryCache<span class="token punctuation">;</span>
        _logger <span class="token operator">=</span> logger<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">// 多级缓存策略</span>
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> <span class="token generic-method"><span class="token function">GetOrSetAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> key<span class="token punctuation">,</span> 
                                         <span class="token class-name">Func<span class="token punctuation">&lt;</span>Task<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span><span class="token punctuation">></span></span> getItem<span class="token punctuation">,</span> 
                                         <span class="token class-name">TimeSpan<span class="token punctuation">?</span></span> expiry <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token comment">// 首先检查内存缓存</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>_memoryCache<span class="token punctuation">.</span><span class="token function">TryGetValue</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token keyword">out</span> <span class="token class-name">T</span> cachedValue<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> cachedValue<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        
        <span class="token comment">// 检查分布式缓存</span>
        <span class="token class-name"><span class="token keyword">var</span></span> distributedValue <span class="token operator">=</span> <span class="token keyword">await</span> _distributedCache<span class="token punctuation">.</span><span class="token function">GetStringAsync</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">IsNullOrEmpty</span><span class="token punctuation">(</span>distributedValue<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> deserializedValue <span class="token operator">=</span> JsonSerializer<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Deserialize</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span></span><span class="token punctuation">(</span>distributedValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token comment">// 回填内存缓存</span>
            _memoryCache<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> deserializedValue<span class="token punctuation">,</span> TimeSpan<span class="token punctuation">.</span><span class="token function">FromMinutes</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token keyword">return</span> deserializedValue<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        
        <span class="token comment">// 缓存未命中，获取数据</span>
        <span class="token class-name"><span class="token keyword">var</span></span> item <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getItem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span>item <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> serializedItem <span class="token operator">=</span> JsonSerializer<span class="token punctuation">.</span><span class="token function">Serialize</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> options <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">DistributedCacheEntryOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token keyword">if</span> <span class="token punctuation">(</span>expiry<span class="token punctuation">.</span>HasValue<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                options<span class="token punctuation">.</span><span class="token function">SetAbsoluteExpiration</span><span class="token punctuation">(</span>expiry<span class="token punctuation">.</span>Value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">&#123;</span>
                options<span class="token punctuation">.</span><span class="token function">SetSlidingExpiration</span><span class="token punctuation">(</span>TimeSpan<span class="token punctuation">.</span><span class="token function">FromHours</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            
            <span class="token keyword">await</span> _distributedCache<span class="token punctuation">.</span><span class="token function">SetStringAsync</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> serializedItem<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
            _memoryCache<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> item<span class="token punctuation">,</span> TimeSpan<span class="token punctuation">.</span><span class="token function">FromMinutes</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        
        <span class="token keyword">return</span> item<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">RemoveAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> key<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        _memoryCache<span class="token punctuation">.</span><span class="token function">Remove</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">await</span> _distributedCache<span class="token punctuation">.</span><span class="token function">RemoveAsync</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 缓存装饰器模式</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CachedUserService</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IUserService</span></span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IUserService</span> _userService<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">CacheService</span> _cacheService<span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token function">CachedUserService</span><span class="token punctuation">(</span><span class="token class-name">IUserService</span> userService<span class="token punctuation">,</span> <span class="token class-name">CacheService</span> cacheService<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        _userService <span class="token operator">=</span> userService<span class="token punctuation">;</span>
        _cacheService <span class="token operator">=</span> cacheService<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>User<span class="token punctuation">></span></span> <span class="token function">GetUserAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> id<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">await</span> _cacheService<span class="token punctuation">.</span><span class="token function">GetOrSetAsync</span><span class="token punctuation">(</span>
            <span class="token interpolation-string"><span class="token string">$"user:</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">id</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
            <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> _userService<span class="token punctuation">.</span><span class="token function">GetUserAsync</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span>
            TimeSpan<span class="token punctuation">.</span><span class="token function">FromMinutes</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>User<span class="token punctuation">></span></span> <span class="token function">UpdateUserAsync</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> updatedUser <span class="token operator">=</span> <span class="token keyword">await</span> _userService<span class="token punctuation">.</span><span class="token function">UpdateUserAsync</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 清除缓存</span>
        <span class="token keyword">await</span> _cacheService<span class="token punctuation">.</span><span class="token function">RemoveAsync</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"user:</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">user<span class="token punctuation">.</span>Id</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">return</span> updatedUser<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h3 id="2-异步编程最佳实践"><a href="#2-异步编程最佳实践" class="headerlink" title="2. 异步编程最佳实践"></a>2. 异步编程最佳实践</h3><figure><div class="code-wrapper"><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token comment">// 异步编程模式</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AsyncBestPractices</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">HttpClient</span> _httpClient<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">ILogger<span class="token punctuation">&lt;</span>AsyncBestPractices<span class="token punctuation">></span></span> _logger<span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token function">AsyncBestPractices</span><span class="token punctuation">(</span><span class="token class-name">HttpClient</span> httpClient<span class="token punctuation">,</span> 
                             <span class="token class-name">ILogger<span class="token punctuation">&lt;</span>AsyncBestPractices<span class="token punctuation">></span></span> logger<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        _httpClient <span class="token operator">=</span> httpClient<span class="token punctuation">;</span>
        _logger <span class="token operator">=</span> logger<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">// 并行处理多个异步操作</span>
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span>UserDto<span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token function">GetUsersInParallelAsync</span><span class="token punctuation">(</span><span class="token class-name">List<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">></span></span> userIds<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> tasks <span class="token operator">=</span> userIds<span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span><span class="token keyword">async</span> id <span class="token operator">=></span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">try</span>
            <span class="token punctuation">&#123;</span>
                <span class="token class-name"><span class="token keyword">var</span></span> response <span class="token operator">=</span> <span class="token keyword">await</span> _httpClient<span class="token punctuation">.</span><span class="token function">GetAsync</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"/api/users/</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">id</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>IsSuccessStatusCode<span class="token punctuation">)</span>
                <span class="token punctuation">&#123;</span>
                    <span class="token class-name"><span class="token keyword">var</span></span> content <span class="token operator">=</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span>Content<span class="token punctuation">.</span><span class="token function">ReadAsStringAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> JsonSerializer<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Deserialize</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>UserDto<span class="token punctuation">></span></span></span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                _logger<span class="token punctuation">.</span><span class="token function">LogError</span><span class="token punctuation">(</span>ex<span class="token punctuation">,</span> <span class="token string">"Error fetching user &#123;UserId&#125;"</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token class-name"><span class="token keyword">var</span></span> results <span class="token operator">=</span> <span class="token keyword">await</span> Task<span class="token punctuation">.</span><span class="token function">WhenAll</span><span class="token punctuation">(</span>tasks<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> results<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>u <span class="token operator">=></span> u <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">// 异步流处理</span>
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">IAsyncEnumerable<span class="token punctuation">&lt;</span>ProcessedData<span class="token punctuation">></span></span> <span class="token function">ProcessDataStreamAsync</span><span class="token punctuation">(</span>
        <span class="token class-name">IAsyncEnumerable<span class="token punctuation">&lt;</span>RawData<span class="token punctuation">></span></span> dataStream<span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">EnumeratorCancellation</span></span><span class="token punctuation">]</span> <span class="token class-name">CancellationToken</span> cancellationToken <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">await</span> <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> data <span class="token keyword">in</span> dataStream<span class="token punctuation">.</span><span class="token function">WithCancellation</span><span class="token punctuation">(</span>cancellationToken<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token comment">// 异步处理每个数据项</span>
            <span class="token class-name"><span class="token keyword">var</span></span> processed <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">ProcessSingleDataAsync</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token keyword">if</span> <span class="token punctuation">(</span>processed <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                <span class="token keyword">yield</span> <span class="token keyword">return</span> processed<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">private</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>ProcessedData<span class="token punctuation">></span></span> <span class="token function">ProcessSingleDataAsync</span><span class="token punctuation">(</span><span class="token class-name">RawData</span> data<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token comment">// 模拟异步处理</span>
        <span class="token keyword">await</span> Task<span class="token punctuation">.</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ProcessedData</span>
        <span class="token punctuation">&#123;</span>
            Id <span class="token operator">=</span> data<span class="token punctuation">.</span>Id<span class="token punctuation">,</span>
            ProcessedValue <span class="token operator">=</span> data<span class="token punctuation">.</span>Value <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span>
            ProcessedAt <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>UtcNow
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">// 超时和取消处理</span>
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> <span class="token generic-method"><span class="token function">ExecuteWithTimeoutAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span></span><span class="token punctuation">(</span>
        <span class="token class-name">Func<span class="token punctuation">&lt;</span>CancellationToken<span class="token punctuation">,</span> Task<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span><span class="token punctuation">></span></span> operation<span class="token punctuation">,</span>
        <span class="token class-name">TimeSpan</span> timeout<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">using</span> <span class="token class-name"><span class="token keyword">var</span></span> cts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">CancellationTokenSource</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">try</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">operation</span><span class="token punctuation">(</span>cts<span class="token punctuation">.</span>Token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">OperationCanceledException</span><span class="token punctuation">)</span> <span class="token keyword">when</span> <span class="token punctuation">(</span>cts<span class="token punctuation">.</span>Token<span class="token punctuation">.</span>IsCancellationRequested<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">TimeoutException</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"Operation timed out after </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">timeout</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RawData</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> Id <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">double</span></span> Value <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProcessedData</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> Id <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">double</span></span> ProcessedValue <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">DateTime</span> ProcessedAt <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h2 id="（二）监控与诊断-3"><a href="#（二）监控与诊断-3" class="headerlink" title="（二）监控与诊断 3"></a>（二）监控与诊断 <mcreference link="https://www.cnblogs.com/edisonchou/p/dotnetcore_microservice_foundation_blogs_index_final.html" index="3">3</mcreference></h2><h3 id="1-健康检查"><a href="#1-健康检查" class="headerlink" title="1. 健康检查"></a>1. 健康检查</h3><figure><div class="code-wrapper"><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token comment">// 健康检查配置</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HealthCheckConfiguration</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ConfigureHealthChecks</span><span class="token punctuation">(</span><span class="token class-name">IServiceCollection</span> services<span class="token punctuation">,</span> 
                                     <span class="token class-name">IConfiguration</span> configuration<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        services<span class="token punctuation">.</span><span class="token function">AddHealthChecks</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">AddCheck</span><span class="token punctuation">(</span><span class="token string">"self"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> HealthCheckResult<span class="token punctuation">.</span><span class="token function">Healthy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">AddSqlServer</span><span class="token punctuation">(</span>configuration<span class="token punctuation">.</span><span class="token function">GetConnectionString</span><span class="token punctuation">(</span><span class="token string">"DefaultConnection"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                             <span class="token named-parameter punctuation">name</span><span class="token punctuation">:</span> <span class="token string">"database"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">AddRedis</span><span class="token punctuation">(</span>configuration<span class="token punctuation">.</span><span class="token function">GetConnectionString</span><span class="token punctuation">(</span><span class="token string">"Redis"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                         <span class="token named-parameter punctuation">name</span><span class="token punctuation">:</span> <span class="token string">"redis"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">AddUrlGroup</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Uri</span><span class="token punctuation">(</span><span class="token string">"https://api.external-service.com/health"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                           <span class="token named-parameter punctuation">name</span><span class="token punctuation">:</span> <span class="token string">"external-api"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddCheck</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>CustomHealthCheck<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token string">"custom-check"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ConfigureHealthCheckEndpoints</span><span class="token punctuation">(</span><span class="token class-name">IApplicationBuilder</span> app<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        app<span class="token punctuation">.</span><span class="token function">UseHealthChecks</span><span class="token punctuation">(</span><span class="token string">"/health"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">HealthCheckOptions</span>
        <span class="token punctuation">&#123;</span>
            ResponseWriter <span class="token operator">=</span> UIResponseWriter<span class="token punctuation">.</span>WriteHealthCheckUIResponse
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        app<span class="token punctuation">.</span><span class="token function">UseHealthChecks</span><span class="token punctuation">(</span><span class="token string">"/health/ready"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">HealthCheckOptions</span>
        <span class="token punctuation">&#123;</span>
            Predicate <span class="token operator">=</span> check <span class="token operator">=></span> check<span class="token punctuation">.</span>Tags<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span><span class="token string">"ready"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            ResponseWriter <span class="token operator">=</span> UIResponseWriter<span class="token punctuation">.</span>WriteHealthCheckUIResponse
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        app<span class="token punctuation">.</span><span class="token function">UseHealthChecks</span><span class="token punctuation">(</span><span class="token string">"/health/live"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">HealthCheckOptions</span>
        <span class="token punctuation">&#123;</span>
            Predicate <span class="token operator">=</span> _ <span class="token operator">=></span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            ResponseWriter <span class="token operator">=</span> UIResponseWriter<span class="token punctuation">.</span>WriteHealthCheckUIResponse
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 自定义健康检查</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomHealthCheck</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IHealthCheck</span></span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IUserService</span> _userService<span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token function">CustomHealthCheck</span><span class="token punctuation">(</span><span class="token class-name">IUserService</span> userService<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        _userService <span class="token operator">=</span> userService<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>HealthCheckResult<span class="token punctuation">></span></span> <span class="token function">CheckHealthAsync</span><span class="token punctuation">(</span>
        <span class="token class-name">HealthCheckContext</span> context<span class="token punctuation">,</span>
        <span class="token class-name">CancellationToken</span> cancellationToken <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span>
        <span class="token punctuation">&#123;</span>
            <span class="token comment">// 执行业务逻辑健康检查</span>
            <span class="token class-name"><span class="token keyword">var</span></span> isHealthy <span class="token operator">=</span> <span class="token keyword">await</span> _userService<span class="token punctuation">.</span><span class="token function">IsServiceHealthyAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token keyword">if</span> <span class="token punctuation">(</span>isHealthy<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                <span class="token keyword">return</span> HealthCheckResult<span class="token punctuation">.</span><span class="token function">Healthy</span><span class="token punctuation">(</span><span class="token string">"User service is healthy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            
            <span class="token keyword">return</span> HealthCheckResult<span class="token punctuation">.</span><span class="token function">Unhealthy</span><span class="token punctuation">(</span><span class="token string">"User service is not responding"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> HealthCheckResult<span class="token punctuation">.</span><span class="token function">Unhealthy</span><span class="token punctuation">(</span>
                <span class="token string">"User service health check failed"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h3 id="2-应用监控"><a href="#2-应用监控" class="headerlink" title="2. 应用监控"></a>2. 应用监控</h3><figure><div class="code-wrapper"><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token comment">// Application Insights集成</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MonitoringConfiguration</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ConfigureApplicationInsights</span><span class="token punctuation">(</span><span class="token class-name">IServiceCollection</span> services<span class="token punctuation">,</span> 
                                            <span class="token class-name">IConfiguration</span> configuration<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        services<span class="token punctuation">.</span><span class="token function">AddApplicationInsightsTelemetry</span><span class="token punctuation">(</span>configuration<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 自定义遥测初始化器</span>
        services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddSingleton</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>ITelemetryInitializer<span class="token punctuation">,</span> CustomTelemetryInitializer<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 自定义遥测处理器</span>
        services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddApplicationInsightsTelemetryProcessor</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>CustomTelemetryProcessor<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 自定义遥测初始化器</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomTelemetryInitializer</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ITelemetryInitializer</span></span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Initialize</span><span class="token punctuation">(</span><span class="token class-name">ITelemetry</span> telemetry<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        telemetry<span class="token punctuation">.</span>Context<span class="token punctuation">.</span>GlobalProperties<span class="token punctuation">[</span><span class="token string">"Environment"</span><span class="token punctuation">]</span> <span class="token operator">=</span> 
            Environment<span class="token punctuation">.</span><span class="token function">GetEnvironmentVariable</span><span class="token punctuation">(</span><span class="token string">"ASPNETCORE_ENVIRONMENT"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        telemetry<span class="token punctuation">.</span>Context<span class="token punctuation">.</span>GlobalProperties<span class="token punctuation">[</span><span class="token string">"ServiceName"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"UserService"</span><span class="token punctuation">;</span>
        telemetry<span class="token punctuation">.</span>Context<span class="token punctuation">.</span>GlobalProperties<span class="token punctuation">[</span><span class="token string">"Version"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"1.0.0"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 自定义遥测处理器</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomTelemetryProcessor</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ITelemetryProcessor</span></span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">ITelemetryProcessor</span> _next<span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token function">CustomTelemetryProcessor</span><span class="token punctuation">(</span><span class="token class-name">ITelemetryProcessor</span> next<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        _next <span class="token operator">=</span> next<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Process</span><span class="token punctuation">(</span><span class="token class-name">ITelemetry</span> item<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token comment">// 过滤敏感信息</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>item <span class="token keyword">is</span> <span class="token class-name">RequestTelemetry</span> request<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>Url<span class="token punctuation">?.</span>AbsolutePath<span class="token punctuation">?.</span><span class="token function">Contains</span><span class="token punctuation">(</span><span class="token string">"/health"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                <span class="token comment">// 不记录健康检查请求</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        
        <span class="token comment">// 添加自定义属性</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>item <span class="token keyword">is</span> <span class="token class-name">TraceTelemetry</span> trace<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            trace<span class="token punctuation">.</span>Properties<span class="token punctuation">[</span><span class="token string">"CustomProperty"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"CustomValue"</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        
        _next<span class="token punctuation">.</span><span class="token function">Process</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 自定义指标收集</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MetricsCollector</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">TelemetryClient</span> _telemetryClient<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">ILogger<span class="token punctuation">&lt;</span>MetricsCollector<span class="token punctuation">></span></span> _logger<span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token function">MetricsCollector</span><span class="token punctuation">(</span><span class="token class-name">TelemetryClient</span> telemetryClient<span class="token punctuation">,</span>
                           <span class="token class-name">ILogger<span class="token punctuation">&lt;</span>MetricsCollector<span class="token punctuation">></span></span> logger<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        _telemetryClient <span class="token operator">=</span> telemetryClient<span class="token punctuation">;</span>
        _logger <span class="token operator">=</span> logger<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">TrackUserOperation</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> operation<span class="token punctuation">,</span> <span class="token class-name">TimeSpan</span> duration<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">bool</span></span> success<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        _telemetryClient<span class="token punctuation">.</span><span class="token function">TrackMetric</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"UserOperation.</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">operation</span><span class="token punctuation">&#125;</span></span><span class="token string">.Duration"</span></span><span class="token punctuation">,</span> 
                                    duration<span class="token punctuation">.</span>TotalMilliseconds<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        _telemetryClient<span class="token punctuation">.</span><span class="token function">TrackMetric</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"UserOperation.</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">operation</span><span class="token punctuation">&#125;</span></span><span class="token string">.Success"</span></span><span class="token punctuation">,</span> 
                                    success <span class="token punctuation">?</span> <span class="token number">1</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token class-name"><span class="token keyword">var</span></span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Dictionary<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token punctuation">></span></span>
        <span class="token punctuation">&#123;</span>
            <span class="token punctuation">[</span><span class="token string">"Operation"</span><span class="token punctuation">]</span> <span class="token operator">=</span> operation<span class="token punctuation">,</span>
            <span class="token punctuation">[</span><span class="token string">"Success"</span><span class="token punctuation">]</span> <span class="token operator">=</span> success<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        
        _telemetryClient<span class="token punctuation">.</span><span class="token function">TrackEvent</span><span class="token punctuation">(</span><span class="token string">"UserOperationCompleted"</span><span class="token punctuation">,</span> properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">TrackBusinessMetric</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> metricName<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">double</span></span> <span class="token keyword">value</span><span class="token punctuation">,</span> 
                                   <span class="token class-name">Dictionary<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token punctuation">></span></span> properties <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        _telemetryClient<span class="token punctuation">.</span><span class="token function">TrackMetric</span><span class="token punctuation">(</span>metricName<span class="token punctuation">,</span> <span class="token keyword">value</span><span class="token punctuation">,</span> properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h1 id="六、开发工具生态"><a href="#六、开发工具生态" class="headerlink" title="六、开发工具生态"></a>六、开发工具生态</h1><h2 id="（一）Visual-Studio开发体验"><a href="#（一）Visual-Studio开发体验" class="headerlink" title="（一）Visual Studio开发体验"></a>（一）Visual Studio开发体验</h2><h3 id="1-项目模板和脚手架"><a href="#1-项目模板和脚手架" class="headerlink" title="1. 项目模板和脚手架"></a>1. 项目模板和脚手架</h3><figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># .NET CLI命令</span>
<span class="token comment"># 创建Web API项目</span>
dotnet new webapi <span class="token parameter variable">-n</span> MyApi

<span class="token comment"># 创建MVC项目</span>
dotnet new mvc <span class="token parameter variable">-n</span> MyWebApp

<span class="token comment"># 创建类库</span>
dotnet new classlib <span class="token parameter variable">-n</span> MyLibrary

<span class="token comment"># 创建解决方案</span>
dotnet new sln <span class="token parameter variable">-n</span> MySolution

<span class="token comment"># 添加项目到解决方案</span>
dotnet sln <span class="token function">add</span> MyApi/MyApi.csproj
dotnet sln <span class="token function">add</span> MyWebApp/MyWebApp.csproj

<span class="token comment"># 添加包引用</span>
dotnet <span class="token function">add</span> package Microsoft.EntityFrameworkCore.SqlServer
dotnet <span class="token function">add</span> package Serilog.AspNetCore

<span class="token comment"># 运行项目</span>
dotnet run

<span class="token comment"># 发布项目</span>
dotnet publish <span class="token parameter variable">-c</span> Release <span class="token parameter variable">-o</span> ./publish<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h3 id="2-调试和诊断工具"><a href="#2-调试和诊断工具" class="headerlink" title="2. 调试和诊断工具"></a>2. 调试和诊断工具</h3><figure><div class="code-wrapper"><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token comment">// 调试配置</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DebuggingConfiguration</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ConfigureDebugging</span><span class="token punctuation">(</span><span class="token class-name">IServiceCollection</span> services<span class="token punctuation">,</span> 
                                  <span class="token class-name">IWebHostEnvironment</span> env<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>env<span class="token punctuation">.</span><span class="token function">IsDevelopment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token comment">// 开发环境特定配置</span>
            services<span class="token punctuation">.</span><span class="token function">AddDeveloperExceptionPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            services<span class="token punctuation">.</span><span class="token function">AddDatabaseDeveloperPageExceptionFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token comment">// 启用详细错误信息</span>
            services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Configure</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>RouteOptions<span class="token punctuation">></span></span></span><span class="token punctuation">(</span>options <span class="token operator">=></span>
            <span class="token punctuation">&#123;</span>
                options<span class="token punctuation">.</span>LowercaseUrls <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                options<span class="token punctuation">.</span>LowercaseQueryStrings <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ConfigureDiagnostics</span><span class="token punctuation">(</span><span class="token class-name">IApplicationBuilder</span> app<span class="token punctuation">,</span> 
                                    <span class="token class-name">IWebHostEnvironment</span> env<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>env<span class="token punctuation">.</span><span class="token function">IsDevelopment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            app<span class="token punctuation">.</span><span class="token function">UseDeveloperExceptionPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            app<span class="token punctuation">.</span><span class="token function">UseMigrationsEndPoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">&#123;</span>
            app<span class="token punctuation">.</span><span class="token function">UseExceptionHandler</span><span class="token punctuation">(</span><span class="token string">"/Error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            app<span class="token punctuation">.</span><span class="token function">UseHsts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 性能分析</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PerformanceProfiler</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">ILogger<span class="token punctuation">&lt;</span>PerformanceProfiler<span class="token punctuation">></span></span> _logger<span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token function">PerformanceProfiler</span><span class="token punctuation">(</span><span class="token class-name">ILogger<span class="token punctuation">&lt;</span>PerformanceProfiler<span class="token punctuation">></span></span> logger<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        _logger <span class="token operator">=</span> logger<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> <span class="token generic-method"><span class="token function">ProfileAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> operationName<span class="token punctuation">,</span> 
                                        <span class="token class-name">Func<span class="token punctuation">&lt;</span>Task<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span><span class="token punctuation">></span></span> operation<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> stopwatch <span class="token operator">=</span> Stopwatch<span class="token punctuation">.</span><span class="token function">StartNew</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">try</span>
        <span class="token punctuation">&#123;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">operation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            stopwatch<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            _logger<span class="token punctuation">.</span><span class="token function">LogInformation</span><span class="token punctuation">(</span>
                <span class="token string">"Operation &#123;OperationName&#125; completed in &#123;ElapsedMs&#125;ms"</span><span class="token punctuation">,</span>
                operationName<span class="token punctuation">,</span> stopwatch<span class="token punctuation">.</span>ElapsedMilliseconds<span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            stopwatch<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            _logger<span class="token punctuation">.</span><span class="token function">LogError</span><span class="token punctuation">(</span>ex<span class="token punctuation">,</span> 
                <span class="token string">"Operation &#123;OperationName&#125; failed after &#123;ElapsedMs&#125;ms"</span><span class="token punctuation">,</span>
                operationName<span class="token punctuation">,</span> stopwatch<span class="token punctuation">.</span>ElapsedMilliseconds<span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token keyword">throw</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h2 id="（二）DevOps集成"><a href="#（二）DevOps集成" class="headerlink" title="（二）DevOps集成"></a>（二）DevOps集成</h2><h3 id="1-Docker容器化"><a href="#1-Docker容器化" class="headerlink" title="1. Docker容器化"></a>1. Docker容器化</h3><figure><div class="code-wrapper"><pre class="line-numbers language-docker" data-language="docker"><code class="language-docker"><span class="token comment"># Dockerfile示例</span>
<span class="token instruction"><span class="token keyword">FROM</span> mcr.microsoft.com/dotnet/aspnet:8.0 <span class="token keyword">AS</span> base</span>
<span class="token instruction"><span class="token keyword">WORKDIR</span> /app</span>
<span class="token instruction"><span class="token keyword">EXPOSE</span> 80</span>
<span class="token instruction"><span class="token keyword">EXPOSE</span> 443</span>

<span class="token instruction"><span class="token keyword">FROM</span> mcr.microsoft.com/dotnet/sdk:8.0 <span class="token keyword">AS</span> build</span>
<span class="token instruction"><span class="token keyword">WORKDIR</span> /src</span>
<span class="token instruction"><span class="token keyword">COPY</span> [<span class="token string">"MyApi/MyApi.csproj"</span>, <span class="token string">"MyApi/"</span>]</span>
<span class="token instruction"><span class="token keyword">RUN</span> dotnet restore <span class="token string">"MyApi/MyApi.csproj"</span></span>
<span class="token instruction"><span class="token keyword">COPY</span> . .</span>
<span class="token instruction"><span class="token keyword">WORKDIR</span> <span class="token string">"/src/MyApi"</span></span>
<span class="token instruction"><span class="token keyword">RUN</span> dotnet build <span class="token string">"MyApi.csproj"</span> -c Release -o /app/build</span>

<span class="token instruction"><span class="token keyword">FROM</span> build <span class="token keyword">AS</span> publish</span>
<span class="token instruction"><span class="token keyword">RUN</span> dotnet publish <span class="token string">"MyApi.csproj"</span> -c Release -o /app/publish</span>

<span class="token instruction"><span class="token keyword">FROM</span> base <span class="token keyword">AS</span> final</span>
<span class="token instruction"><span class="token keyword">WORKDIR</span> /app</span>
<span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">publish</span></span> /app/publish .</span>
<span class="token instruction"><span class="token keyword">ENTRYPOINT</span> [<span class="token string">"dotnet"</span>, <span class="token string">"MyApi.dll"</span>]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<figure><div class="code-wrapper"><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># docker-compose.yml</span>
<span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'3.8'</span>

<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">api</span><span class="token punctuation">:</span>
    <span class="token key atrule">build</span><span class="token punctuation">:</span>
      <span class="token key atrule">context</span><span class="token punctuation">:</span> .
      <span class="token key atrule">dockerfile</span><span class="token punctuation">:</span> Dockerfile
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"5000:80"</span>
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> ASPNETCORE_ENVIRONMENT=Development
      <span class="token punctuation">-</span> ConnectionStrings__DefaultConnection=Server=db;Database=MyApiDb;User Id=sa;Password=YourPassword123;
      <span class="token punctuation">-</span> ConnectionStrings__Redis=redis<span class="token punctuation">:</span><span class="token number">6379</span>
    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> db
      <span class="token punctuation">-</span> redis
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> app<span class="token punctuation">-</span>network

  <span class="token key atrule">db</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> mcr.microsoft.com/mssql/server<span class="token punctuation">:</span>2022<span class="token punctuation">-</span>latest
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> ACCEPT_EULA=Y
      <span class="token punctuation">-</span> SA_PASSWORD=YourPassword123
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"1433:1433"</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> sqlserver_data<span class="token punctuation">:</span>/var/opt/mssql
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> app<span class="token punctuation">-</span>network

  <span class="token key atrule">redis</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> redis<span class="token punctuation">:</span>7<span class="token punctuation">-</span>alpine
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"6379:6379"</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> redis_data<span class="token punctuation">:</span>/data
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> app<span class="token punctuation">-</span>network

<span class="token key atrule">volumes</span><span class="token punctuation">:</span>
  <span class="token key atrule">sqlserver_data</span><span class="token punctuation">:</span>
  <span class="token key atrule">redis_data</span><span class="token punctuation">:</span>

<span class="token key atrule">networks</span><span class="token punctuation">:</span>
  <span class="token key atrule">app-network</span><span class="token punctuation">:</span>
    <span class="token key atrule">driver</span><span class="token punctuation">:</span> bridge<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h3 id="2-CI-CD管道"><a href="#2-CI-CD管道" class="headerlink" title="2. CI&#x2F;CD管道"></a>2. CI&#x2F;CD管道</h3><figure><div class="code-wrapper"><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># Azure DevOps Pipeline</span>
<span class="token key atrule">trigger</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> main
<span class="token punctuation">-</span> develop

<span class="token key atrule">pool</span><span class="token punctuation">:</span>
  <span class="token key atrule">vmImage</span><span class="token punctuation">:</span> <span class="token string">'ubuntu-latest'</span>

<span class="token key atrule">variables</span><span class="token punctuation">:</span>
  <span class="token key atrule">buildConfiguration</span><span class="token punctuation">:</span> <span class="token string">'Release'</span>
  <span class="token key atrule">dotNetFramework</span><span class="token punctuation">:</span> <span class="token string">'net8.0'</span>
  <span class="token key atrule">dotNetVersion</span><span class="token punctuation">:</span> <span class="token string">'8.0.x'</span>

<span class="token key atrule">stages</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">stage</span><span class="token punctuation">:</span> Build
  <span class="token key atrule">displayName</span><span class="token punctuation">:</span> <span class="token string">'Build and Test'</span>
  <span class="token key atrule">jobs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">job</span><span class="token punctuation">:</span> BuildAndTest
    <span class="token key atrule">displayName</span><span class="token punctuation">:</span> <span class="token string">'Build and Test Job'</span>
    <span class="token key atrule">steps</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">task</span><span class="token punctuation">:</span> UseDotNet@2
      <span class="token key atrule">displayName</span><span class="token punctuation">:</span> <span class="token string">'Use .NET SDK'</span>
      <span class="token key atrule">inputs</span><span class="token punctuation">:</span>
        <span class="token key atrule">version</span><span class="token punctuation">:</span> $(dotNetVersion)
        <span class="token key atrule">includePreviewVersions</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>

    <span class="token punctuation">-</span> <span class="token key atrule">task</span><span class="token punctuation">:</span> DotNetCoreCLI@2
      <span class="token key atrule">displayName</span><span class="token punctuation">:</span> <span class="token string">'Restore packages'</span>
      <span class="token key atrule">inputs</span><span class="token punctuation">:</span>
        <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token string">'restore'</span>
        <span class="token key atrule">projects</span><span class="token punctuation">:</span> <span class="token string">'**/*.csproj'</span>

    <span class="token punctuation">-</span> <span class="token key atrule">task</span><span class="token punctuation">:</span> DotNetCoreCLI@2
      <span class="token key atrule">displayName</span><span class="token punctuation">:</span> <span class="token string">'Build solution'</span>
      <span class="token key atrule">inputs</span><span class="token punctuation">:</span>
        <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token string">'build'</span>
        <span class="token key atrule">projects</span><span class="token punctuation">:</span> <span class="token string">'**/*.csproj'</span>
        <span class="token key atrule">arguments</span><span class="token punctuation">:</span> <span class="token string">'--configuration $(buildConfiguration) --no-restore'</span>

    <span class="token punctuation">-</span> <span class="token key atrule">task</span><span class="token punctuation">:</span> DotNetCoreCLI@2
      <span class="token key atrule">displayName</span><span class="token punctuation">:</span> <span class="token string">'Run unit tests'</span>
      <span class="token key atrule">inputs</span><span class="token punctuation">:</span>
        <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token string">'test'</span>
        <span class="token key atrule">projects</span><span class="token punctuation">:</span> <span class="token string">'**/*Tests.csproj'</span>
        <span class="token key atrule">arguments</span><span class="token punctuation">:</span> <span class="token string">'--configuration $(buildConfiguration) --no-build --collect "Code coverage"'</span>

    <span class="token punctuation">-</span> <span class="token key atrule">task</span><span class="token punctuation">:</span> DotNetCoreCLI@2
      <span class="token key atrule">displayName</span><span class="token punctuation">:</span> <span class="token string">'Publish application'</span>
      <span class="token key atrule">inputs</span><span class="token punctuation">:</span>
        <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token string">'publish'</span>
        <span class="token key atrule">publishWebProjects</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">arguments</span><span class="token punctuation">:</span> <span class="token string">'--configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)'</span>
        <span class="token key atrule">zipAfterPublish</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>

    <span class="token punctuation">-</span> <span class="token key atrule">task</span><span class="token punctuation">:</span> PublishBuildArtifacts@1
      <span class="token key atrule">displayName</span><span class="token punctuation">:</span> <span class="token string">'Publish artifacts'</span>
      <span class="token key atrule">inputs</span><span class="token punctuation">:</span>
        <span class="token key atrule">PathtoPublish</span><span class="token punctuation">:</span> <span class="token string">'$(Build.ArtifactStagingDirectory)'</span>
        <span class="token key atrule">ArtifactName</span><span class="token punctuation">:</span> <span class="token string">'drop'</span>
        <span class="token key atrule">publishLocation</span><span class="token punctuation">:</span> <span class="token string">'Container'</span>

<span class="token punctuation">-</span> <span class="token key atrule">stage</span><span class="token punctuation">:</span> Deploy
  <span class="token key atrule">displayName</span><span class="token punctuation">:</span> <span class="token string">'Deploy to Production'</span>
  <span class="token key atrule">dependsOn</span><span class="token punctuation">:</span> Build
  <span class="token key atrule">condition</span><span class="token punctuation">:</span> and(succeeded()<span class="token punctuation">,</span> eq(variables<span class="token punctuation">[</span><span class="token string">'Build.SourceBranch'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 'refs/heads/main'))
  <span class="token key atrule">jobs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">deployment</span><span class="token punctuation">:</span> DeployToProduction
    <span class="token key atrule">displayName</span><span class="token punctuation">:</span> <span class="token string">'Deploy to Production'</span>
    <span class="token key atrule">environment</span><span class="token punctuation">:</span> <span class="token string">'production'</span>
    <span class="token key atrule">strategy</span><span class="token punctuation">:</span>
      <span class="token key atrule">runOnce</span><span class="token punctuation">:</span>
        <span class="token key atrule">deploy</span><span class="token punctuation">:</span>
          <span class="token key atrule">steps</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">task</span><span class="token punctuation">:</span> AzureWebApp@1
            <span class="token key atrule">displayName</span><span class="token punctuation">:</span> <span class="token string">'Deploy to Azure Web App'</span>
            <span class="token key atrule">inputs</span><span class="token punctuation">:</span>
              <span class="token key atrule">azureSubscription</span><span class="token punctuation">:</span> <span class="token string">'Azure-Connection'</span>
              <span class="token key atrule">appType</span><span class="token punctuation">:</span> <span class="token string">'webApp'</span>
              <span class="token key atrule">appName</span><span class="token punctuation">:</span> <span class="token string">'my-dotnet-api'</span>
              <span class="token key atrule">package</span><span class="token punctuation">:</span> <span class="token string">'$(Pipeline.Workspace)/drop/*.zip'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h1 id="七、实际应用案例"><a href="#七、实际应用案例" class="headerlink" title="七、实际应用案例"></a>七、实际应用案例</h1><h2 id="（一）电商平台微服务架构"><a href="#（一）电商平台微服务架构" class="headerlink" title="（一）电商平台微服务架构"></a>（一）电商平台微服务架构</h2><h3 id="1-系统架构设计"><a href="#1-系统架构设计" class="headerlink" title="1. 系统架构设计"></a>1. 系统架构设计</h3><figure><div class="code-wrapper"><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token comment">// 用户服务</span>
<span class="token punctuation">[</span>ApiController<span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Route</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">"api/[controller]"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UsersController</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ControllerBase</span></span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IUserService</span> _userService<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IEventBus</span> _eventBus<span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token function">UsersController</span><span class="token punctuation">(</span><span class="token class-name">IUserService</span> userService<span class="token punctuation">,</span> <span class="token class-name">IEventBus</span> eventBus<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        _userService <span class="token operator">=</span> userService<span class="token punctuation">;</span>
        _eventBus <span class="token operator">=</span> eventBus<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">HttpPost</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">"register"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>ActionResult<span class="token punctuation">&lt;</span>UserDto<span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token function">RegisterUser</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">FromBody</span></span><span class="token punctuation">]</span> <span class="token class-name">RegisterUserDto</span> dto<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> user <span class="token operator">=</span> <span class="token keyword">await</span> _userService<span class="token punctuation">.</span><span class="token function">RegisterUserAsync</span><span class="token punctuation">(</span>dto<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 发布用户注册事件</span>
        <span class="token keyword">await</span> _eventBus<span class="token punctuation">.</span><span class="token function">PublishAsync</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">UserRegisteredEvent</span>
        <span class="token punctuation">&#123;</span>
            UserId <span class="token operator">=</span> user<span class="token punctuation">.</span>Id<span class="token punctuation">,</span>
            Email <span class="token operator">=</span> user<span class="token punctuation">.</span>Email<span class="token punctuation">,</span>
            Username <span class="token operator">=</span> user<span class="token punctuation">.</span>Username
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">return</span> <span class="token function">Ok</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 订单服务</span>
<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ApiController</span></span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Route</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">"api/[controller]"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrdersController</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ControllerBase</span></span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IOrderService</span> _orderService<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IPaymentService</span> _paymentService<span class="token punctuation">;</span>
    
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">HttpPost</span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>ActionResult<span class="token punctuation">&lt;</span>OrderDto<span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token function">CreateOrder</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">FromBody</span></span><span class="token punctuation">]</span> <span class="token class-name">CreateOrderDto</span> dto<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token comment">// 创建订单</span>
        <span class="token class-name"><span class="token keyword">var</span></span> order <span class="token operator">=</span> <span class="token keyword">await</span> _orderService<span class="token punctuation">.</span><span class="token function">CreateOrderAsync</span><span class="token punctuation">(</span>dto<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 处理支付</span>
        <span class="token class-name"><span class="token keyword">var</span></span> paymentResult <span class="token operator">=</span> <span class="token keyword">await</span> _paymentService<span class="token punctuation">.</span><span class="token function">ProcessPaymentAsync</span><span class="token punctuation">(</span>
            order<span class="token punctuation">.</span>Id<span class="token punctuation">,</span> dto<span class="token punctuation">.</span>PaymentInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span>paymentResult<span class="token punctuation">.</span>IsSuccess<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">await</span> _orderService<span class="token punctuation">.</span><span class="token function">ConfirmOrderAsync</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span>Id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        
        <span class="token keyword">return</span> <span class="token function">Ok</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 库存服务</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InventoryService</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IInventoryService</span></span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IRepository<span class="token punctuation">&lt;</span>Product<span class="token punctuation">></span></span> _productRepository<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IDistributedLock</span> _distributedLock<span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span><span class="token keyword">bool</span><span class="token punctuation">></span></span> <span class="token function">ReserveInventoryAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> productId<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> quantity<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> lockKey <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">$"inventory:product:</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">productId</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">;</span>
        
        <span class="token keyword">using</span> <span class="token class-name"><span class="token keyword">var</span></span> lockHandle <span class="token operator">=</span> <span class="token keyword">await</span> _distributedLock<span class="token punctuation">.</span><span class="token function">AcquireAsync</span><span class="token punctuation">(</span>lockKey<span class="token punctuation">,</span> TimeSpan<span class="token punctuation">.</span><span class="token function">FromSeconds</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lockHandle <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> product <span class="token operator">=</span> <span class="token keyword">await</span> _productRepository<span class="token punctuation">.</span><span class="token function">GetByIdAsync</span><span class="token punctuation">(</span>productId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token keyword">if</span> <span class="token punctuation">(</span>product<span class="token punctuation">.</span>Stock <span class="token operator">>=</span> quantity<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                product<span class="token punctuation">.</span>Stock <span class="token operator">-=</span> quantity<span class="token punctuation">;</span>
                <span class="token keyword">await</span> _productRepository<span class="token punctuation">.</span><span class="token function">UpdateAsync</span><span class="token punctuation">(</span>product<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h3 id="2-分布式事务处理"><a href="#2-分布式事务处理" class="headerlink" title="2. 分布式事务处理"></a>2. 分布式事务处理</h3><figure><div class="code-wrapper"><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token comment">// Saga模式实现</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderSaga</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IOrderService</span> _orderService<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IPaymentService</span> _paymentService<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IInventoryService</span> _inventoryService<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IEventBus</span> _eventBus<span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">HandleOrderCreatedEvent</span><span class="token punctuation">(</span><span class="token class-name">OrderCreatedEvent</span> @<span class="token keyword">event</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> sagaData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">OrderSagaData</span>
        <span class="token punctuation">&#123;</span>
            OrderId <span class="token operator">=</span> @<span class="token keyword">event</span><span class="token punctuation">.</span>OrderId<span class="token punctuation">,</span>
            UserId <span class="token operator">=</span> @<span class="token keyword">event</span><span class="token punctuation">.</span>UserId<span class="token punctuation">,</span>
            Items <span class="token operator">=</span> @<span class="token keyword">event</span><span class="token punctuation">.</span>Items<span class="token punctuation">,</span>
            State <span class="token operator">=</span> SagaState<span class="token punctuation">.</span>Started
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        
        <span class="token keyword">try</span>
        <span class="token punctuation">&#123;</span>
            <span class="token comment">// 步骤1：预留库存</span>
            <span class="token class-name"><span class="token keyword">var</span></span> inventoryReserved <span class="token operator">=</span> <span class="token keyword">await</span> _inventoryService<span class="token punctuation">.</span><span class="token function">ReserveInventoryAsync</span><span class="token punctuation">(</span>
                sagaData<span class="token punctuation">.</span>Items<span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inventoryReserved<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                <span class="token keyword">await</span> <span class="token function">CompensateOrderAsync</span><span class="token punctuation">(</span>sagaData<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            
            sagaData<span class="token punctuation">.</span>State <span class="token operator">=</span> SagaState<span class="token punctuation">.</span>InventoryReserved<span class="token punctuation">;</span>
            
            <span class="token comment">// 步骤2：处理支付</span>
            <span class="token class-name"><span class="token keyword">var</span></span> paymentResult <span class="token operator">=</span> <span class="token keyword">await</span> _paymentService<span class="token punctuation">.</span><span class="token function">ProcessPaymentAsync</span><span class="token punctuation">(</span>
                sagaData<span class="token punctuation">.</span>OrderId<span class="token punctuation">,</span> sagaData<span class="token punctuation">.</span>PaymentAmount<span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>paymentResult<span class="token punctuation">.</span>IsSuccess<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                <span class="token keyword">await</span> <span class="token function">CompensateInventoryAsync</span><span class="token punctuation">(</span>sagaData<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">await</span> <span class="token function">CompensateOrderAsync</span><span class="token punctuation">(</span>sagaData<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            
            sagaData<span class="token punctuation">.</span>State <span class="token operator">=</span> SagaState<span class="token punctuation">.</span>PaymentProcessed<span class="token punctuation">;</span>
            
            <span class="token comment">// 步骤3：确认订单</span>
            <span class="token keyword">await</span> _orderService<span class="token punctuation">.</span><span class="token function">ConfirmOrderAsync</span><span class="token punctuation">(</span>sagaData<span class="token punctuation">.</span>OrderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            sagaData<span class="token punctuation">.</span>State <span class="token operator">=</span> SagaState<span class="token punctuation">.</span>Completed<span class="token punctuation">;</span>
            
            <span class="token keyword">await</span> _eventBus<span class="token punctuation">.</span><span class="token function">PublishAsync</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">OrderCompletedEvent</span>
            <span class="token punctuation">&#123;</span>
                OrderId <span class="token operator">=</span> sagaData<span class="token punctuation">.</span>OrderId<span class="token punctuation">,</span>
                UserId <span class="token operator">=</span> sagaData<span class="token punctuation">.</span>UserId
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">await</span> <span class="token function">CompensateAsync</span><span class="token punctuation">(</span>sagaData<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">private</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">CompensateAsync</span><span class="token punctuation">(</span><span class="token class-name">OrderSagaData</span> sagaData<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>sagaData<span class="token punctuation">.</span>State<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">case</span> SagaState<span class="token punctuation">.</span>PaymentProcessed<span class="token punctuation">:</span>
                <span class="token keyword">await</span> _paymentService<span class="token punctuation">.</span><span class="token function">RefundPaymentAsync</span><span class="token punctuation">(</span>sagaData<span class="token punctuation">.</span>OrderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">goto</span> <span class="token keyword">case</span> SagaState<span class="token punctuation">.</span>InventoryReserved<span class="token punctuation">;</span>
                
            <span class="token keyword">case</span> SagaState<span class="token punctuation">.</span>InventoryReserved<span class="token punctuation">:</span>
                <span class="token keyword">await</span> _inventoryService<span class="token punctuation">.</span><span class="token function">ReleaseInventoryAsync</span><span class="token punctuation">(</span>sagaData<span class="token punctuation">.</span>Items<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">goto</span> <span class="token keyword">case</span> SagaState<span class="token punctuation">.</span>Started<span class="token punctuation">;</span>
                
            <span class="token keyword">case</span> SagaState<span class="token punctuation">.</span>Started<span class="token punctuation">:</span>
                <span class="token keyword">await</span> _orderService<span class="token punctuation">.</span><span class="token function">CancelOrderAsync</span><span class="token punctuation">(</span>sagaData<span class="token punctuation">.</span>OrderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h2 id="（二）企业级应用最佳实践"><a href="#（二）企业级应用最佳实践" class="headerlink" title="（二）企业级应用最佳实践"></a>（二）企业级应用最佳实践</h2><h3 id="1-配置管理"><a href="#1-配置管理" class="headerlink" title="1. 配置管理"></a>1. 配置管理</h3><figure><div class="code-wrapper"><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token comment">// 强类型配置</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ApplicationSettings</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">DatabaseSettings</span> Database <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">RedisSettings</span> Redis <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">JwtSettings</span> Jwt <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">EmailSettings</span> Email <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DatabaseSettings</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> ConnectionString <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> CommandTimeout <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> EnableSensitiveDataLogging <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JwtSettings</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> SecretKey <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Issuer <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Audience <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> ExpirationMinutes <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token number">60</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 配置验证</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ApplicationSettingsValidator</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IValidateOptions<span class="token punctuation">&lt;</span>ApplicationSettings<span class="token punctuation">></span></span></span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">ValidateOptionsResult</span> <span class="token function">Validate</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> name<span class="token punctuation">,</span> <span class="token class-name">ApplicationSettings</span> options<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> errors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">IsNullOrEmpty</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>Database<span class="token punctuation">?.</span>ConnectionString<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            errors<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">"Database connection string is required"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">IsNullOrEmpty</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>Jwt<span class="token punctuation">?.</span>SecretKey<span class="token punctuation">)</span> <span class="token operator">||</span> 
            options<span class="token punctuation">.</span>Jwt<span class="token punctuation">.</span>SecretKey<span class="token punctuation">.</span>Length <span class="token operator">&lt;</span> <span class="token number">32</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            errors<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">"JWT secret key must be at least 32 characters"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span>errors<span class="token punctuation">.</span><span class="token function">Any</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> ValidateOptionsResult<span class="token punctuation">.</span><span class="token function">Fail</span><span class="token punctuation">(</span>errors<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        
        <span class="token keyword">return</span> ValidateOptionsResult<span class="token punctuation">.</span>Success<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// Startup配置</span>
<span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ConfigureServices</span><span class="token punctuation">(</span><span class="token class-name">IServiceCollection</span> services<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token comment">// 绑定配置</span>
    services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Configure</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>ApplicationSettings<span class="token punctuation">></span></span></span><span class="token punctuation">(</span>Configuration<span class="token punctuation">)</span><span class="token punctuation">;</span>
    services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddSingleton</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IValidateOptions<span class="token punctuation">&lt;</span>ApplicationSettings<span class="token punctuation">></span><span class="token punctuation">,</span> 
                         ApplicationSettingsValidator<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 使用配置</span>
    services<span class="token punctuation">.</span><span class="token function">AddScoped</span><span class="token punctuation">(</span>provider <span class="token operator">=></span>
    <span class="token punctuation">&#123;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> options <span class="token operator">=</span> provider<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetRequiredService</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IOptions<span class="token punctuation">&lt;</span>ApplicationSettings<span class="token punctuation">></span><span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> options<span class="token punctuation">.</span>Value<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h3 id="2-错误处理和日志记录"><a href="#2-错误处理和日志记录" class="headerlink" title="2. 错误处理和日志记录"></a>2. 错误处理和日志记录</h3><figure><div class="code-wrapper"><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token comment">// 全局异常处理中间件</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GlobalExceptionHandlingMiddleware</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">RequestDelegate</span> _next<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">ILogger<span class="token punctuation">&lt;</span>GlobalExceptionHandlingMiddleware<span class="token punctuation">></span></span> _logger<span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token function">GlobalExceptionHandlingMiddleware</span><span class="token punctuation">(</span><span class="token class-name">RequestDelegate</span> next<span class="token punctuation">,</span>
                                           <span class="token class-name">ILogger<span class="token punctuation">&lt;</span>GlobalExceptionHandlingMiddleware<span class="token punctuation">></span></span> logger<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        _next <span class="token operator">=</span> next<span class="token punctuation">;</span>
        _logger <span class="token operator">=</span> logger<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">InvokeAsync</span><span class="token punctuation">(</span><span class="token class-name">HttpContext</span> context<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">await</span> <span class="token function">_next</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            _logger<span class="token punctuation">.</span><span class="token function">LogError</span><span class="token punctuation">(</span>ex<span class="token punctuation">,</span> <span class="token string">"An unhandled exception occurred"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">await</span> <span class="token function">HandleExceptionAsync</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">HandleExceptionAsync</span><span class="token punctuation">(</span><span class="token class-name">HttpContext</span> context<span class="token punctuation">,</span> <span class="token class-name">Exception</span> exception<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span>ContentType <span class="token operator">=</span> <span class="token string">"application/json"</span><span class="token punctuation">;</span>
        
        <span class="token class-name"><span class="token keyword">var</span></span> response <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ErrorResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>exception<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">case</span> <span class="token class-name">ValidationException</span> validationEx<span class="token punctuation">:</span>
                response<span class="token punctuation">.</span>StatusCode <span class="token operator">=</span> <span class="token number">400</span><span class="token punctuation">;</span>
                response<span class="token punctuation">.</span>Message <span class="token operator">=</span> <span class="token string">"Validation failed"</span><span class="token punctuation">;</span>
                response<span class="token punctuation">.</span>Details <span class="token operator">=</span> validationEx<span class="token punctuation">.</span>Errors<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
                
            <span class="token keyword">case</span> <span class="token class-name">NotFoundException</span> notFoundEx<span class="token punctuation">:</span>
                response<span class="token punctuation">.</span>StatusCode <span class="token operator">=</span> <span class="token number">404</span><span class="token punctuation">;</span>
                response<span class="token punctuation">.</span>Message <span class="token operator">=</span> notFoundEx<span class="token punctuation">.</span>Message<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
                
            <span class="token keyword">case</span> <span class="token class-name">UnauthorizedException</span> unauthorizedEx<span class="token punctuation">:</span>
                response<span class="token punctuation">.</span>StatusCode <span class="token operator">=</span> <span class="token number">401</span><span class="token punctuation">;</span>
                response<span class="token punctuation">.</span>Message <span class="token operator">=</span> <span class="token string">"Unauthorized access"</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
                
            <span class="token keyword">default</span><span class="token punctuation">:</span>
                response<span class="token punctuation">.</span>StatusCode <span class="token operator">=</span> <span class="token number">500</span><span class="token punctuation">;</span>
                response<span class="token punctuation">.</span>Message <span class="token operator">=</span> <span class="token string">"An internal server error occurred"</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        
        context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span>StatusCode <span class="token operator">=</span> response<span class="token punctuation">.</span>StatusCode<span class="token punctuation">;</span>
        
        <span class="token class-name"><span class="token keyword">var</span></span> jsonResponse <span class="token operator">=</span> JsonSerializer<span class="token punctuation">.</span><span class="token function">Serialize</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">await</span> context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span><span class="token function">WriteAsync</span><span class="token punctuation">(</span>jsonResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ErrorResponse</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> StatusCode <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Message <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">object</span></span> Details <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> TraceId <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span> <span class="token operator">=</span> Activity<span class="token punctuation">.</span>Current<span class="token punctuation">?.</span>Id<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h1 id="八、总结与展望"><a href="#八、总结与展望" class="headerlink" title="八、总结与展望"></a>八、总结与展望</h1><h2 id="（一）-NET生态系统优势"><a href="#（一）-NET生态系统优势" class="headerlink" title="（一）.NET生态系统优势"></a>（一）.NET生态系统优势</h2><h3 id="1-技术优势"><a href="#1-技术优势" class="headerlink" title="1. 技术优势"></a>1. 技术优势</h3><ul>
<li><strong>跨平台能力</strong>：支持Windows、macOS、Linux多平台部署</li>
<li><strong>高性能</strong>：优化的运行时和编译器，出色的性能表现</li>
<li><strong>现代化架构</strong>：微服务、云原生、容器化友好</li>
<li><strong>强类型系统</strong>：编译时错误检查，提高代码质量</li>
<li><strong>丰富的生态</strong>：完善的包管理和第三方库支持</li>
</ul>
<h3 id="2-企业级特性"><a href="#2-企业级特性" class="headerlink" title="2. 企业级特性"></a>2. 企业级特性</h3><ul>
<li><strong>成熟的开发工具</strong>：Visual Studio、VS Code等优秀IDE</li>
<li><strong>完善的监控诊断</strong>：Application Insights、健康检查等</li>
<li><strong>安全性</strong>：内置安全特性，符合企业级安全要求</li>
<li><strong>可扩展性</strong>：支持水平扩展和垂直扩展</li>
<li><strong>社区支持</strong>：活跃的开发者社区和微软官方支持</li>
</ul>
<h2 id="（二）适用场景"><a href="#（二）适用场景" class="headerlink" title="（二）适用场景"></a>（二）适用场景</h2><h3 id="1-企业级Web应用"><a href="#1-企业级Web应用" class="headerlink" title="1. 企业级Web应用"></a>1. 企业级Web应用</h3><ul>
<li>大型电商平台</li>
<li>企业管理系统</li>
<li>金融服务应用</li>
<li>政府信息系统</li>
</ul>
<h3 id="2-微服务架构"><a href="#2-微服务架构" class="headerlink" title="2. 微服务架构"></a>2. 微服务架构</h3><ul>
<li>分布式系统</li>
<li>云原生应用</li>
<li>API网关服务</li>
<li>事件驱动架构</li>
</ul>
<h3 id="3-实时应用"><a href="#3-实时应用" class="headerlink" title="3. 实时应用"></a>3. 实时应用</h3><ul>
<li>在线聊天系统</li>
<li>实时数据监控</li>
<li>游戏服务器</li>
<li>IoT数据处理</li>
</ul>
<h2 id="（三）学习建议"><a href="#（三）学习建议" class="headerlink" title="（三）学习建议"></a>（三）学习建议</h2><h3 id="1-学习路径"><a href="#1-学习路径" class="headerlink" title="1. 学习路径"></a>1. 学习路径</h3><ol>
<li><strong>基础语法</strong>：掌握C#语言基础和面向对象编程</li>
<li><strong>Web开发</strong>：学习ASP.NET Core框架和Web API开发</li>
<li><strong>数据访问</strong>：掌握Entity Framework Core和数据库操作</li>
<li><strong>微服务</strong>：了解微服务架构和相关技术栈</li>
<li><strong>DevOps</strong>：学习容器化、CI&#x2F;CD和云部署</li>
</ol>
<h3 id="2-实践项目"><a href="#2-实践项目" class="headerlink" title="2. 实践项目"></a>2. 实践项目</h3><ul>
<li>构建RESTful API服务</li>
<li>开发微服务应用</li>
<li>实现实时通信功能</li>
<li>集成第三方服务</li>
<li>部署到云平台</li>
</ul>
<h2 id="（四）未来发展趋势"><a href="#（四）未来发展趋势" class="headerlink" title="（四）未来发展趋势"></a>（四）未来发展趋势</h2><h3 id="1-技术发展方向"><a href="#1-技术发展方向" class="headerlink" title="1. 技术发展方向"></a>1. 技术发展方向</h3><ul>
<li>**.NET 9+**：持续的性能优化和新特性</li>
<li><strong>云原生优化</strong>：更好的容器和Kubernetes支持</li>
<li><strong>AI&#x2F;ML集成</strong>：机器学习和人工智能能力增强</li>
<li><strong>WebAssembly</strong>：前端应用开发能力扩展</li>
</ul>
<h3 id="2-生态系统演进"><a href="#2-生态系统演进" class="headerlink" title="2. 生态系统演进"></a>2. 生态系统演进</h3><ul>
<li><strong>开源生态</strong>：更多开源项目和社区贡献</li>
<li><strong>跨平台增强</strong>：移动端和嵌入式设备支持</li>
<li><strong>性能提升</strong>：AOT编译和运行时优化</li>
<li><strong>开发体验</strong>：更智能的开发工具和调试能力</li>
</ul>
<p>C#和.NET生态系统作为现代企业级开发平台，凭借其强大的技术能力、完善的工具链和活跃的社区支持，已经成为构建高性能、可扩展、安全可靠应用的首选技术栈。无论是传统的Web应用开发，还是现代的微服务架构和云原生应用，.NET都能提供完整的解决方案和最佳实践。</p>
<p>随着技术的不断演进和生态系统的持续完善，.NET将继续在企业级应用开发领域发挥重要作用，为开发者提供更加高效、现代化的开发体验。</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E5%90%8E%E7%AB%AF/" class="category-chain-item">后端</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E5%90%8E%E7%AB%AF/" class="print-no-link">#后端</a>
      
        <a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" class="print-no-link">#微服务</a>
      
        <a href="/tags/C/" class="print-no-link">#C#</a>
      
        <a href="/tags/NET/" class="print-no-link">#.NET</a>
      
        <a href="/tags/ASP-NET-Core/" class="print-no-link">#ASP.NET Core</a>
      
        <a href="/tags/%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%BC%80%E5%8F%91/" class="print-no-link">#企业级开发</a>
      
    </div>
  
</div>


              

              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2025/03/20/%E3%80%90LINUX%E3%80%91MySQL%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84%E5%AE%89%E5%85%A8%E9%85%8D%E7%BD%AE/" title="【LINUX】MySQL服务器的安全配置">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">【LINUX】MySQL服务器的安全配置</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2024/12/20/%E3%80%90%E5%8D%9A%E5%AE%A2%E3%80%91Hexo%E5%8D%9A%E5%AE%A2%E4%B8%BB%E9%A2%98%E6%8E%A8%E8%8D%90%E4%B8%8E%E5%AF%B9%E6%AF%94/" title="【博客】Hexo博客主题推荐与对比">
                        <span class="hidden-mobile">【博客】Hexo博客主题推荐与对比</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    

  

</div>

  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script  src="https://lib.baomitu.com/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js" ></script>

  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>




  
<script src="/js/custom.js"></script>
<script src="/js/ai-assistant.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mermaid@9.4.0/dist/mermaid.min.js"></script>



<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
