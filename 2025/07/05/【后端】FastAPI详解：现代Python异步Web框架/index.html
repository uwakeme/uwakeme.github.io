

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="https://cdn.jsdelivr.net/gh/uwakeme/cdn@main/img/favicon.png">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Wake">
  <meta name="keywords" content="FastAPI, Python异步框架, REST API开发, Pydantic数据验证, 异步编程, 微服务架构, OpenAPI文档, JWT认证, SQLAlchemy ORM, WebSocket, 性能优化, 容器化部署">
  
    <meta name="description" content="全面深入解析FastAPI现代Python异步Web框架，从基础概念到高级特性，涵盖异步编程模式、RESTful API设计、数据验证与序列化、用户认证授权、数据库集成、WebSocket实时通信、性能优化、安全防护、测试策略、容器化部署等核心技术，助力开发者构建高性能、可扩展的现代Web应用和微服务架构">
<meta property="og:type" content="article">
<meta property="og:title" content="FastAPI详解：现代Python异步Web框架">
<meta property="og:url" content="https://uwakeme.top/2025/07/05/%E3%80%90%E5%90%8E%E7%AB%AF%E3%80%91FastAPI%E8%AF%A6%E8%A7%A3%EF%BC%9A%E7%8E%B0%E4%BB%A3Python%E5%BC%82%E6%AD%A5Web%E6%A1%86%E6%9E%B6/index.html">
<meta property="og:site_name" content="Uwakeme">
<meta property="og:description" content="全面深入解析FastAPI现代Python异步Web框架，从基础概念到高级特性，涵盖异步编程模式、RESTful API设计、数据验证与序列化、用户认证授权、数据库集成、WebSocket实时通信、性能优化、安全防护、测试策略、容器化部署等核心技术，助力开发者构建高性能、可扩展的现代Web应用和微服务架构">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2025-07-04T16:00:00.000Z">
<meta property="article:modified_time" content="2025-07-15T02:03:44.220Z">
<meta property="article:author" content="Wake">
<meta property="article:tag" content="Python">
<meta property="article:tag" content="框架">
<meta property="article:tag" content="异步编程">
<meta property="article:tag" content="微服务">
<meta property="article:tag" content="REST API">
<meta property="article:tag" content="FastAPI">
<meta name="twitter:card" content="summary_large_image">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>FastAPI详解：现代Python异步Web框架 - Uwakeme</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  



  
<link rel="stylesheet" href="//at.alicdn.com/t/c/font_3846514_kabxni94auf.css">
<link rel="stylesheet" href="/css/custom.css">
<link rel="stylesheet" href="/css/ai-assistant.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"uwakeme.top","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"|","loop":false,"scope":[],"backSpeed":40,"showCursor":true},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":"#"},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100},"position_indicator":{"enable":true,"color":"#33a3dc"}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""],"img_max_width":"80%","img_max_height":"80%"},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0,"level":3,"collapse":false,"follow":true,"number":true,"heading_list":true,"expand_all":true},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2,"element_loading_img":true},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":"41fc030db57d5570dd22f78997dc4a7e","google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null},"busuanzi":{"enable":true,"script_url":"//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js","site_uv":true,"site_pv":true,"page_pv":true}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  
    <!-- Baidu Analytics -->
    <script async>
      if (!Fluid.ctx.dnt) {
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?41fc030db57d5570dd22f78997dc4a7e";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
      }
    </script>
  

  

  

  

  



  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Wake 的博客</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives" target="_self">
                <i class="iconfont icon-books"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories" target="_self">
                <i class="iconfont icon-th-large"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/" target="_self">
                <i class="iconfont icon-link-fill"></i>
                <span>友链</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" target="_self" href="javascript:;" role="button"
                 data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <i class="iconfont icon-book"></i>
                <span>文档</span>
              </a>
              <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                
                  
                  
                  
                  <a class="dropdown-item" href="https://hexo.fluid-dev.com/" target="_self">
                    
                    <span>主题博客</span>
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="https://hexo.fluid-dev.com/docs/guide/" target="_self">
                    
                    <span>配置指南</span>
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="https://hexo.fluid-dev.com/docs/icon/" target="_self">
                    
                    <span>图标用法</span>
                  </a>
                
              </div>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="FastAPI详解：现代Python异步Web框架"></span>
          
        </div>

        
          
  <div class="mt-3">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-author" aria-hidden="true"></i>
        Wake
      </span>
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-07-05 00:00" pubdate>
          2025-07-05 00:00
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          <!-- compatible with older versions-->
          7.5k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          <!-- compatible with older versions-->
          63 分钟
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> 次
        </span>
        

      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">FastAPI详解：现代Python异步Web框架</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>FastAPI是由Sebastian Ramirez于2018年创建的现代Python Web框架，专为构建高性能API而设计。作为新一代的Python Web框架，FastAPI结合了现代Python特性（如类型提示、异步编程）和最佳实践，为开发者提供了一个既强大又易用的API开发解决方案。</p>
<h2 id="为什么选择FastAPI？"><a href="#为什么选择FastAPI？" class="headerlink" title="为什么选择FastAPI？"></a>为什么选择FastAPI？</h2><ul>
<li><strong>卓越性能</strong>：基于Starlette和Pydantic构建，性能可媲美NodeJS和Go语言</li>
<li><strong>开发效率</strong>：通过类型提示和自动化功能，减少约40%的开发错误</li>
<li><strong>现代化设计</strong>：原生支持Python 3.6+的异步编程特性</li>
<li><strong>标准兼容</strong>：完全兼容OpenAPI（Swagger）和JSON Schema标准</li>
<li><strong>自动文档</strong>：零配置自动生成交互式API文档</li>
<li><strong>类型安全</strong>：基于Python类型提示，提供完整的IDE支持和代码补全</li>
<li><strong>生产就绪</strong>：内置数据验证、序列化、认证等企业级功能</li>
</ul>
<h2 id="核心技术优势"><a href="#核心技术优势" class="headerlink" title="核心技术优势"></a>核心技术优势</h2><ul>
<li><strong>异步优先</strong>：原生支持async&#x2F;await，充分利用Python异步编程能力</li>
<li><strong>数据验证</strong>：集成Pydantic，提供强大的数据验证和序列化功能</li>
<li><strong>自动文档生成</strong>：基于代码自动生成Swagger UI和ReDoc文档</li>
<li><strong>依赖注入</strong>：优雅的依赖注入系统，支持复杂的业务逻辑组织</li>
<li><strong>中间件支持</strong>：灵活的中间件机制，易于扩展和定制</li>
<li><strong>WebSocket支持</strong>：内置WebSocket支持，轻松构建实时应用</li>
<li><strong>测试友好</strong>：基于Starlette的测试客户端，简化API测试</li>
</ul>
<h2 id="适用场景"><a href="#适用场景" class="headerlink" title="适用场景"></a>适用场景</h2><ul>
<li><strong>RESTful API开发</strong>：构建标准的REST API服务</li>
<li><strong>微服务架构</strong>：作为微服务架构中的服务节点</li>
<li><strong>数据科学API</strong>：为机器学习模型提供API接口</li>
<li><strong>实时应用</strong>：利用WebSocket构建实时通信应用</li>
<li><strong>企业级应用</strong>：需要高性能和可靠性的企业级API服务</li>
</ul>
<h2 id="本文内容概览"><a href="#本文内容概览" class="headerlink" title="本文内容概览"></a>本文内容概览</h2><p>本文将全面介绍FastAPI框架的核心概念和实践应用，包括：</p>
<ul>
<li><strong>基础入门</strong>：FastAPI安装配置、项目结构和基本概念</li>
<li><strong>路径操作详解</strong>：路由定义、参数处理和请求响应模式</li>
<li><strong>数据模型与验证</strong>：Pydantic模型设计和数据验证策略</li>
<li><strong>异步编程实践</strong>：异步路由、数据库操作和并发处理</li>
<li><strong>数据库集成</strong>：SQLAlchemy ORM集成和数据库操作最佳实践</li>
<li><strong>用户认证授权</strong>：JWT认证、OAuth2集成和权限管理</li>
<li><strong>高级特性应用</strong>：中间件、依赖注入、WebSocket和后台任务</li>
<li><strong>API文档与测试</strong>：自动文档生成和测试策略</li>
<li><strong>性能优化</strong>：缓存策略、数据库优化和并发调优</li>
<li><strong>安全防护</strong>：CORS配置、输入验证和安全最佳实践</li>
<li><strong>部署与运维</strong>：容器化部署、监控和日志管理</li>
</ul>
<h1 id="一、FastAPI基础"><a href="#一、FastAPI基础" class="headerlink" title="一、FastAPI基础"></a>一、FastAPI基础</h1><h2 id="（一）安装与配置"><a href="#（一）安装与配置" class="headerlink" title="（一）安装与配置"></a>（一）安装与配置</h2><h3 id="1-环境准备"><a href="#1-环境准备" class="headerlink" title="1. 环境准备"></a>1. 环境准备</h3><figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 创建虚拟环境</span>
python <span class="token parameter variable">-m</span> venv fastapi_env
<span class="token builtin class-name">source</span> fastapi_env/bin/activate  <span class="token comment"># Linux/Mac</span>
<span class="token comment"># fastapi_env\Scripts\activate  # Windows</span>

<span class="token comment"># 安装FastAPI和ASGI服务器</span>
pip <span class="token function">install</span> fastapi<span class="token punctuation">[</span>all<span class="token punctuation">]</span>
pip <span class="token function">install</span> uvicorn<span class="token punctuation">[</span>standard<span class="token punctuation">]</span>

<span class="token comment"># 或者分别安装</span>
pip <span class="token function">install</span> fastapi
pip <span class="token function">install</span> uvicorn
pip <span class="token function">install</span> python-multipart  <span class="token comment"># 表单和文件上传</span>
pip <span class="token function">install</span> python-jose<span class="token punctuation">[</span>cryptography<span class="token punctuation">]</span>  <span class="token comment"># JWT</span>
pip <span class="token function">install</span> passlib<span class="token punctuation">[</span>bcrypt<span class="token punctuation">]</span>  <span class="token comment"># 密码哈希</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h3 id="2-第一个FastAPI应用"><a href="#2-第一个FastAPI应用" class="headerlink" title="2. 第一个FastAPI应用"></a>2. 第一个FastAPI应用</h3><figure><div class="code-wrapper"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># main.py</span>
<span class="token keyword">from</span> fastapi <span class="token keyword">import</span> FastAPI
<span class="token keyword">from</span> pydantic <span class="token keyword">import</span> BaseModel
<span class="token keyword">from</span> typing <span class="token keyword">import</span> Optional

app <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span>
    title<span class="token operator">=</span><span class="token string">"我的API"</span><span class="token punctuation">,</span>
    description<span class="token operator">=</span><span class="token string">"这是一个示例API"</span><span class="token punctuation">,</span>
    version<span class="token operator">=</span><span class="token string">"1.0.0"</span><span class="token punctuation">,</span>
    docs_url<span class="token operator">=</span><span class="token string">"/docs"</span><span class="token punctuation">,</span>  <span class="token comment"># Swagger UI</span>
    redoc_url<span class="token operator">=</span><span class="token string">"/redoc"</span>  <span class="token comment"># ReDoc</span>
<span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Item</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name<span class="token punctuation">:</span> <span class="token builtin">str</span>
    price<span class="token punctuation">:</span> <span class="token builtin">float</span>
    is_offer<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">bool</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">read_root</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">"Hello"</span><span class="token punctuation">:</span> <span class="token string">"World"</span><span class="token punctuation">&#125;</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/items/&#123;item_id&#125;"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">read_item</span><span class="token punctuation">(</span>item_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> q<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">"item_id"</span><span class="token punctuation">:</span> item_id<span class="token punctuation">,</span> <span class="token string">"q"</span><span class="token punctuation">:</span> q<span class="token punctuation">&#125;</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">"/items/"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">create_item</span><span class="token punctuation">(</span>item<span class="token punctuation">:</span> Item<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> item

<span class="token comment"># 启动服务器</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    <span class="token keyword">import</span> uvicorn
    uvicorn<span class="token punctuation">.</span>run<span class="token punctuation">(</span>app<span class="token punctuation">,</span> host<span class="token operator">=</span><span class="token string">"0.0.0.0"</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">8000</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h3 id="3-运行应用"><a href="#3-运行应用" class="headerlink" title="3. 运行应用"></a>3. 运行应用</h3><figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 开发模式</span>
uvicorn main:app <span class="token parameter variable">--reload</span>

<span class="token comment"># 生产模式</span>
uvicorn main:app <span class="token parameter variable">--host</span> <span class="token number">0.0</span>.0.0 <span class="token parameter variable">--port</span> <span class="token number">8000</span>

<span class="token comment"># 访问API文档</span>
<span class="token comment"># http://localhost:8000/docs (Swagger UI)</span>
<span class="token comment"># http://localhost:8000/redoc (ReDoc)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h2 id="（二）路径操作与参数"><a href="#（二）路径操作与参数" class="headerlink" title="（二）路径操作与参数"></a>（二）路径操作与参数</h2><h3 id="1-路径参数"><a href="#1-路径参数" class="headerlink" title="1. 路径参数"></a>1. 路径参数</h3><figure><div class="code-wrapper"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> enum <span class="token keyword">import</span> Enum
<span class="token keyword">from</span> fastapi <span class="token keyword">import</span> FastAPI<span class="token punctuation">,</span> HTTPException

app <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">ModelName</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">,</span> Enum<span class="token punctuation">)</span><span class="token punctuation">:</span>
    alexnet <span class="token operator">=</span> <span class="token string">"alexnet"</span>
    resnet <span class="token operator">=</span> <span class="token string">"resnet"</span>
    lenet <span class="token operator">=</span> <span class="token string">"lenet"</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/models/&#123;model_name&#125;"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get_model</span><span class="token punctuation">(</span>model_name<span class="token punctuation">:</span> ModelName<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> model_name <span class="token operator">==</span> ModelName<span class="token punctuation">.</span>alexnet<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">"model_name"</span><span class="token punctuation">:</span> model_name<span class="token punctuation">,</span> <span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"Deep Learning FTW!"</span><span class="token punctuation">&#125;</span>
    
    <span class="token keyword">if</span> model_name<span class="token punctuation">.</span>value <span class="token operator">==</span> <span class="token string">"lenet"</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">"model_name"</span><span class="token punctuation">:</span> model_name<span class="token punctuation">,</span> <span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"LeCNN all the images"</span><span class="token punctuation">&#125;</span>
    
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">"model_name"</span><span class="token punctuation">:</span> model_name<span class="token punctuation">,</span> <span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"Have some residuals"</span><span class="token punctuation">&#125;</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/files/&#123;file_path:path&#125;"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">read_file</span><span class="token punctuation">(</span>file_path<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">"file_path"</span><span class="token punctuation">:</span> file_path<span class="token punctuation">&#125;</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/users/&#123;user_id&#125;"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">read_user</span><span class="token punctuation">(</span>user_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> user_id <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> HTTPException<span class="token punctuation">(</span>status_code<span class="token operator">=</span><span class="token number">400</span><span class="token punctuation">,</span> detail<span class="token operator">=</span><span class="token string">"用户ID必须大于0"</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">"user_id"</span><span class="token punctuation">:</span> user_id<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h3 id="2-查询参数"><a href="#2-查询参数" class="headerlink" title="2. 查询参数"></a>2. 查询参数</h3><figure><div class="code-wrapper"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> typing <span class="token keyword">import</span> Optional<span class="token punctuation">,</span> List
<span class="token keyword">from</span> fastapi <span class="token keyword">import</span> Query

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/items/"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">read_items</span><span class="token punctuation">(</span>
    skip<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
    limit<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">,</span>
    q<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> Query<span class="token punctuation">(</span>
        <span class="token boolean">None</span><span class="token punctuation">,</span> 
        min_length<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> 
        max_length<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">,</span>
        regex<span class="token operator">=</span><span class="token string">"^[a-zA-Z0-9\s]+$"</span><span class="token punctuation">,</span>
        description<span class="token operator">=</span><span class="token string">"搜索查询字符串"</span><span class="token punctuation">,</span>
        example<span class="token operator">=</span><span class="token string">"python"</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
    tags<span class="token punctuation">:</span> List<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> Query<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> description<span class="token operator">=</span><span class="token string">"标签列表"</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span>
    results <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"skip"</span><span class="token punctuation">:</span> skip<span class="token punctuation">,</span> <span class="token string">"limit"</span><span class="token punctuation">:</span> limit<span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> q<span class="token punctuation">:</span>
        results<span class="token punctuation">[</span><span class="token string">"q"</span><span class="token punctuation">]</span> <span class="token operator">=</span> q
    <span class="token keyword">if</span> tags<span class="token punctuation">:</span>
        results<span class="token punctuation">[</span><span class="token string">"tags"</span><span class="token punctuation">]</span> <span class="token operator">=</span> tags
    <span class="token keyword">return</span> results

<span class="token comment"># 必需查询参数</span>
<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/items-required/"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">read_items_required</span><span class="token punctuation">(</span>
    q<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> Query<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> min_length<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> description<span class="token operator">=</span><span class="token string">"必需的查询参数"</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">"q"</span><span class="token punctuation">:</span> q<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h3 id="3-请求体"><a href="#3-请求体" class="headerlink" title="3. 请求体"></a>3. 请求体</h3><figure><div class="code-wrapper"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pydantic <span class="token keyword">import</span> BaseModel<span class="token punctuation">,</span> Field<span class="token punctuation">,</span> validator
<span class="token keyword">from</span> typing <span class="token keyword">import</span> Optional<span class="token punctuation">,</span> List
<span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime

<span class="token keyword">class</span> <span class="token class-name">User</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> min_length<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> max_length<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span> description<span class="token operator">=</span><span class="token string">"用户名"</span><span class="token punctuation">)</span>
    email<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> regex<span class="token operator">=</span><span class="token string">r'^[\w\.-]+@[\w\.-]+\.\w+$'</span><span class="token punctuation">,</span> description<span class="token operator">=</span><span class="token string">"邮箱"</span><span class="token punctuation">)</span>
    age<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">,</span> ge<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> le<span class="token operator">=</span><span class="token number">120</span><span class="token punctuation">,</span> description<span class="token operator">=</span><span class="token string">"年龄"</span><span class="token punctuation">)</span>
    is_active<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">,</span> description<span class="token operator">=</span><span class="token string">"是否激活"</span><span class="token punctuation">)</span>
    
    <span class="token decorator annotation punctuation">@validator</span><span class="token punctuation">(</span><span class="token string">'email'</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">validate_email</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token string">'@'</span> <span class="token keyword">not</span> <span class="token keyword">in</span> v<span class="token punctuation">:</span>
            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">'邮箱格式不正确'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> v<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Item</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name<span class="token punctuation">:</span> <span class="token builtin">str</span>
    description<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
    price<span class="token punctuation">:</span> <span class="token builtin">float</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> gt<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> description<span class="token operator">=</span><span class="token string">"价格必须大于0"</span><span class="token punctuation">)</span>
    tax<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">float</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
    tags<span class="token punctuation">:</span> List<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    created_at<span class="token punctuation">:</span> datetime <span class="token operator">=</span> Field<span class="token punctuation">(</span>default_factory<span class="token operator">=</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">UserItem</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    user<span class="token punctuation">:</span> User
    item<span class="token punctuation">:</span> Item
    quantity<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> ge<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> description<span class="token operator">=</span><span class="token string">"数量"</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">"/users/"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">create_user</span><span class="token punctuation">(</span>user<span class="token punctuation">:</span> User<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"用户 </span><span class="token interpolation"><span class="token punctuation">&#123;</span>user<span class="token punctuation">.</span>name<span class="token punctuation">&#125;</span></span><span class="token string"> 创建成功"</span></span><span class="token punctuation">,</span> <span class="token string">"user"</span><span class="token punctuation">:</span> user<span class="token punctuation">&#125;</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">"/items/"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">create_item</span><span class="token punctuation">(</span>item<span class="token punctuation">:</span> Item<span class="token punctuation">)</span><span class="token punctuation">:</span>
    item_dict <span class="token operator">=</span> item<span class="token punctuation">.</span><span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> item<span class="token punctuation">.</span>tax<span class="token punctuation">:</span>
        price_with_tax <span class="token operator">=</span> item<span class="token punctuation">.</span>price <span class="token operator">+</span> item<span class="token punctuation">.</span>tax
        item_dict<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"price_with_tax"</span><span class="token punctuation">:</span> price_with_tax<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> item_dict

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>put</span><span class="token punctuation">(</span><span class="token string">"/items/&#123;item_id&#125;"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">update_item</span><span class="token punctuation">(</span>
    item_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> 
    item<span class="token punctuation">:</span> Item<span class="token punctuation">,</span> 
    q<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
    timestamp<span class="token punctuation">:</span> datetime <span class="token operator">=</span> Field<span class="token punctuation">(</span>default_factory<span class="token operator">=</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span>
    result <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"item_id"</span><span class="token punctuation">:</span> item_id<span class="token punctuation">,</span> <span class="token string">"item"</span><span class="token punctuation">:</span> item<span class="token punctuation">,</span> <span class="token string">"timestamp"</span><span class="token punctuation">:</span> timestamp<span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> q<span class="token punctuation">:</span>
        result<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"q"</span><span class="token punctuation">:</span> q<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> result<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h1 id="二、异步编程与数据库"><a href="#二、异步编程与数据库" class="headerlink" title="二、异步编程与数据库"></a>二、异步编程与数据库</h1><h2 id="（一）异步编程基础"><a href="#（一）异步编程基础" class="headerlink" title="（一）异步编程基础"></a>（一）异步编程基础</h2><h3 id="1-异步路径操作"><a href="#1-异步路径操作" class="headerlink" title="1. 异步路径操作"></a>1. 异步路径操作</h3><figure><div class="code-wrapper"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> asyncio
<span class="token keyword">import</span> aiohttp
<span class="token keyword">from</span> fastapi <span class="token keyword">import</span> FastAPI
<span class="token keyword">from</span> typing <span class="token keyword">import</span> List

app <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 异步函数</span>
<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/async-example"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">async_example</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 模拟异步操作</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"这是一个异步操作"</span><span class="token punctuation">&#125;</span>

<span class="token comment"># 并发处理</span>
<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/fetch-urls"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">fetch_multiple_urls</span><span class="token punctuation">(</span>urls<span class="token punctuation">:</span> List<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">fetch_url</span><span class="token punctuation">(</span>session<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token keyword">async</span> <span class="token keyword">with</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span> <span class="token keyword">as</span> response<span class="token punctuation">:</span>
                <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
                    <span class="token string">"url"</span><span class="token punctuation">:</span> url<span class="token punctuation">,</span>
                    <span class="token string">"status"</span><span class="token punctuation">:</span> response<span class="token punctuation">.</span>status<span class="token punctuation">,</span>
                    <span class="token string">"content_length"</span><span class="token punctuation">:</span> <span class="token builtin">len</span><span class="token punctuation">(</span><span class="token keyword">await</span> response<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">&#125;</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">"url"</span><span class="token punctuation">:</span> url<span class="token punctuation">,</span> <span class="token string">"error"</span><span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">&#125;</span>
    
    <span class="token keyword">async</span> <span class="token keyword">with</span> aiohttp<span class="token punctuation">.</span>ClientSession<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> session<span class="token punctuation">:</span>
        tasks <span class="token operator">=</span> <span class="token punctuation">[</span>fetch_url<span class="token punctuation">(</span>session<span class="token punctuation">,</span> url<span class="token punctuation">)</span> <span class="token keyword">for</span> url <span class="token keyword">in</span> urls<span class="token punctuation">]</span>
        results <span class="token operator">=</span> <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>gather<span class="token punctuation">(</span><span class="token operator">*</span>tasks<span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">"results"</span><span class="token punctuation">:</span> results<span class="token punctuation">&#125;</span>

<span class="token comment"># 异步生成器</span>
<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/stream-data"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">stream_data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">generate_data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span>
            <span class="token keyword">yield</span> <span class="token string-interpolation"><span class="token string">f"data chunk </span><span class="token interpolation"><span class="token punctuation">&#123;</span>i<span class="token punctuation">&#125;</span></span><span class="token string">\n"</span></span>
    
    <span class="token keyword">return</span> StreamingResponse<span class="token punctuation">(</span>
        generate_data<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
        media_type<span class="token operator">=</span><span class="token string">"text/plain"</span>
    <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h3 id="2-后台任务"><a href="#2-后台任务" class="headerlink" title="2. 后台任务"></a>2. 后台任务</h3><figure><div class="code-wrapper"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> fastapi <span class="token keyword">import</span> BackgroundTasks
<span class="token keyword">import</span> smtplib
<span class="token keyword">from</span> email<span class="token punctuation">.</span>mime<span class="token punctuation">.</span>text <span class="token keyword">import</span> MIMEText
<span class="token keyword">from</span> email<span class="token punctuation">.</span>mime<span class="token punctuation">.</span>multipart <span class="token keyword">import</span> MIMEMultipart

<span class="token keyword">def</span> <span class="token function">send_email</span><span class="token punctuation">(</span>email<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> message<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""发送邮件的后台任务"""</span>
    <span class="token comment"># 这里是发送邮件的逻辑</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"发送邮件到 </span><span class="token interpolation"><span class="token punctuation">&#123;</span>email<span class="token punctuation">&#125;</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>message<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token comment"># 实际的邮件发送代码...</span>

<span class="token keyword">def</span> <span class="token function">write_log</span><span class="token punctuation">(</span>message<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""写入日志的后台任务"""</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"log.txt"</span><span class="token punctuation">,</span> <span class="token string">"a"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> log_file<span class="token punctuation">:</span>
        log_file<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>message<span class="token punctuation">&#125;</span></span><span class="token string">\n"</span></span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">"/send-notification/"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">send_notification</span><span class="token punctuation">(</span>
    email<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> 
    message<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> 
    background_tasks<span class="token punctuation">:</span> BackgroundTasks
<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 添加后台任务</span>
    background_tasks<span class="token punctuation">.</span>add_task<span class="token punctuation">(</span>send_email<span class="token punctuation">,</span> email<span class="token punctuation">,</span> message<span class="token punctuation">)</span>
    background_tasks<span class="token punctuation">.</span>add_task<span class="token punctuation">(</span>write_log<span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"邮件发送到 </span><span class="token interpolation"><span class="token punctuation">&#123;</span>email<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"邮件将在后台发送"</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h2 id="（二）数据库集成"><a href="#（二）数据库集成" class="headerlink" title="（二）数据库集成"></a>（二）数据库集成</h2><h3 id="1-SQLAlchemy配置"><a href="#1-SQLAlchemy配置" class="headerlink" title="1. SQLAlchemy配置"></a>1. SQLAlchemy配置</h3><figure><div class="code-wrapper"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># database.py</span>
<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> create_engine
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>ext<span class="token punctuation">.</span>declarative <span class="token keyword">import</span> declarative_base
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> sessionmaker
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>ext<span class="token punctuation">.</span>asyncio <span class="token keyword">import</span> create_async_engine<span class="token punctuation">,</span> AsyncSession

<span class="token comment"># 同步数据库</span>
SQLALCHEMY_DATABASE_URL <span class="token operator">=</span> <span class="token string">"sqlite:///./test.db"</span>
<span class="token comment"># SQLALCHEMY_DATABASE_URL = "postgresql://user:password@localhost/dbname"</span>

engine <span class="token operator">=</span> create_engine<span class="token punctuation">(</span>
    SQLALCHEMY_DATABASE_URL<span class="token punctuation">,</span> 
    connect_args<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">"check_same_thread"</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">&#125;</span>  <span class="token comment"># 仅SQLite需要</span>
<span class="token punctuation">)</span>
SessionLocal <span class="token operator">=</span> sessionmaker<span class="token punctuation">(</span>autocommit<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> autoflush<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> bind<span class="token operator">=</span>engine<span class="token punctuation">)</span>

<span class="token comment"># 异步数据库</span>
ASYNC_SQLALCHEMY_DATABASE_URL <span class="token operator">=</span> <span class="token string">"sqlite+aiosqlite:///./test.db"</span>
<span class="token comment"># ASYNC_SQLALCHEMY_DATABASE_URL = "postgresql+asyncpg://user:password@localhost/dbname"</span>

async_engine <span class="token operator">=</span> create_async_engine<span class="token punctuation">(</span>ASYNC_SQLALCHEMY_DATABASE_URL<span class="token punctuation">)</span>
AsyncSessionLocal <span class="token operator">=</span> sessionmaker<span class="token punctuation">(</span>
    async_engine<span class="token punctuation">,</span> class_<span class="token operator">=</span>AsyncSession<span class="token punctuation">,</span> expire_on_commit<span class="token operator">=</span><span class="token boolean">False</span>
<span class="token punctuation">)</span>

Base <span class="token operator">=</span> declarative_base<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 依赖注入</span>
<span class="token keyword">def</span> <span class="token function">get_db</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    db <span class="token operator">=</span> SessionLocal<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">yield</span> db
    <span class="token keyword">finally</span><span class="token punctuation">:</span>
        db<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get_async_db</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">async</span> <span class="token keyword">with</span> AsyncSessionLocal<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> session<span class="token punctuation">:</span>
        <span class="token keyword">yield</span> session<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h3 id="2-数据模型"><a href="#2-数据模型" class="headerlink" title="2. 数据模型"></a>2. 数据模型</h3><figure><div class="code-wrapper"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># models.py</span>
<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> Boolean<span class="token punctuation">,</span> Column<span class="token punctuation">,</span> ForeignKey<span class="token punctuation">,</span> Integer<span class="token punctuation">,</span> String<span class="token punctuation">,</span> DateTime<span class="token punctuation">,</span> Text<span class="token punctuation">,</span> Float
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> relationship
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>sql <span class="token keyword">import</span> func
<span class="token keyword">from</span> database <span class="token keyword">import</span> Base

<span class="token keyword">class</span> <span class="token class-name">User</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">"users"</span>
    
    <span class="token builtin">id</span> <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    email <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">,</span> unique<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    username <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">,</span> unique<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    hashed_password <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    is_active <span class="token operator">=</span> Column<span class="token punctuation">(</span>Boolean<span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    is_superuser <span class="token operator">=</span> Column<span class="token punctuation">(</span>Boolean<span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    created_at <span class="token operator">=</span> Column<span class="token punctuation">(</span>DateTime<span class="token punctuation">(</span>timezone<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span> server_default<span class="token operator">=</span>func<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    updated_at <span class="token operator">=</span> Column<span class="token punctuation">(</span>DateTime<span class="token punctuation">(</span>timezone<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span> onupdate<span class="token operator">=</span>func<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    items <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">"Item"</span><span class="token punctuation">,</span> back_populates<span class="token operator">=</span><span class="token string">"owner"</span><span class="token punctuation">)</span>
    posts <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">"Post"</span><span class="token punctuation">,</span> back_populates<span class="token operator">=</span><span class="token string">"author"</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Item</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">"items"</span>
    
    <span class="token builtin">id</span> <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    title <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    description <span class="token operator">=</span> Column<span class="token punctuation">(</span>Text<span class="token punctuation">)</span>
    price <span class="token operator">=</span> Column<span class="token punctuation">(</span>Float<span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    is_available <span class="token operator">=</span> Column<span class="token punctuation">(</span>Boolean<span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    owner_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> ForeignKey<span class="token punctuation">(</span><span class="token string">"users.id"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    created_at <span class="token operator">=</span> Column<span class="token punctuation">(</span>DateTime<span class="token punctuation">(</span>timezone<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span> server_default<span class="token operator">=</span>func<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    owner <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">"User"</span><span class="token punctuation">,</span> back_populates<span class="token operator">=</span><span class="token string">"items"</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Post</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">"posts"</span>
    
    <span class="token builtin">id</span> <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    title <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    content <span class="token operator">=</span> Column<span class="token punctuation">(</span>Text<span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    published <span class="token operator">=</span> Column<span class="token punctuation">(</span>Boolean<span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    author_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> ForeignKey<span class="token punctuation">(</span><span class="token string">"users.id"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    created_at <span class="token operator">=</span> Column<span class="token punctuation">(</span>DateTime<span class="token punctuation">(</span>timezone<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span> server_default<span class="token operator">=</span>func<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    updated_at <span class="token operator">=</span> Column<span class="token punctuation">(</span>DateTime<span class="token punctuation">(</span>timezone<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span> onupdate<span class="token operator">=</span>func<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    author <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">"User"</span><span class="token punctuation">,</span> back_populates<span class="token operator">=</span><span class="token string">"posts"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h3 id="3-Pydantic模式"><a href="#3-Pydantic模式" class="headerlink" title="3. Pydantic模式"></a>3. Pydantic模式</h3><figure><div class="code-wrapper"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># schemas.py</span>
<span class="token keyword">from</span> pydantic <span class="token keyword">import</span> BaseModel<span class="token punctuation">,</span> EmailStr<span class="token punctuation">,</span> validator
<span class="token keyword">from</span> typing <span class="token keyword">import</span> List<span class="token punctuation">,</span> Optional
<span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime

<span class="token comment"># 基础模式</span>
<span class="token keyword">class</span> <span class="token class-name">ItemBase</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    title<span class="token punctuation">:</span> <span class="token builtin">str</span>
    description<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
    price<span class="token punctuation">:</span> <span class="token builtin">float</span>
    is_available<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">True</span>
    
    <span class="token decorator annotation punctuation">@validator</span><span class="token punctuation">(</span><span class="token string">'price'</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">validate_price</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> v <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">'价格必须大于0'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> v

<span class="token keyword">class</span> <span class="token class-name">ItemCreate</span><span class="token punctuation">(</span>ItemBase<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">pass</span>

<span class="token keyword">class</span> <span class="token class-name">ItemUpdate</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    title<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
    description<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
    price<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">float</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
    is_available<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">bool</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>

<span class="token keyword">class</span> <span class="token class-name">Item</span><span class="token punctuation">(</span>ItemBase<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token builtin">id</span><span class="token punctuation">:</span> <span class="token builtin">int</span>
    owner_id<span class="token punctuation">:</span> <span class="token builtin">int</span>
    created_at<span class="token punctuation">:</span> datetime
    
    <span class="token keyword">class</span> <span class="token class-name">Config</span><span class="token punctuation">:</span>
        orm_mode <span class="token operator">=</span> <span class="token boolean">True</span>

<span class="token comment"># 用户模式</span>
<span class="token keyword">class</span> <span class="token class-name">UserBase</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    email<span class="token punctuation">:</span> EmailStr
    username<span class="token punctuation">:</span> <span class="token builtin">str</span>
    is_active<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">True</span>

<span class="token keyword">class</span> <span class="token class-name">UserCreate</span><span class="token punctuation">(</span>UserBase<span class="token punctuation">)</span><span class="token punctuation">:</span>
    password<span class="token punctuation">:</span> <span class="token builtin">str</span>
    
    <span class="token decorator annotation punctuation">@validator</span><span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">validate_password</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">'密码至少需要8个字符'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> v

<span class="token keyword">class</span> <span class="token class-name">UserUpdate</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    email<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>EmailStr<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
    username<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
    is_active<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">bool</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
    password<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>

<span class="token keyword">class</span> <span class="token class-name">User</span><span class="token punctuation">(</span>UserBase<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token builtin">id</span><span class="token punctuation">:</span> <span class="token builtin">int</span>
    is_superuser<span class="token punctuation">:</span> <span class="token builtin">bool</span>
    created_at<span class="token punctuation">:</span> datetime
    items<span class="token punctuation">:</span> List<span class="token punctuation">[</span>Item<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    
    <span class="token keyword">class</span> <span class="token class-name">Config</span><span class="token punctuation">:</span>
        orm_mode <span class="token operator">=</span> <span class="token boolean">True</span>

<span class="token keyword">class</span> <span class="token class-name">UserInDB</span><span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">:</span>
    hashed_password<span class="token punctuation">:</span> <span class="token builtin">str</span>

<span class="token comment"># 认证模式</span>
<span class="token keyword">class</span> <span class="token class-name">Token</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    access_token<span class="token punctuation">:</span> <span class="token builtin">str</span>
    token_type<span class="token punctuation">:</span> <span class="token builtin">str</span>

<span class="token keyword">class</span> <span class="token class-name">TokenData</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    username<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>

<span class="token keyword">class</span> <span class="token class-name">UserLogin</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    username<span class="token punctuation">:</span> <span class="token builtin">str</span>
    password<span class="token punctuation">:</span> <span class="token builtin">str</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h3 id="4-CRUD操作"><a href="#4-CRUD操作" class="headerlink" title="4. CRUD操作"></a>4. CRUD操作</h3><figure><div class="code-wrapper"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># crud.py</span>
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> Session
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>ext<span class="token punctuation">.</span>asyncio <span class="token keyword">import</span> AsyncSession
<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> select<span class="token punctuation">,</span> update<span class="token punctuation">,</span> delete
<span class="token keyword">from</span> passlib<span class="token punctuation">.</span>context <span class="token keyword">import</span> CryptContext
<span class="token keyword">from</span> typing <span class="token keyword">import</span> List<span class="token punctuation">,</span> Optional
<span class="token keyword">import</span> models
<span class="token keyword">import</span> schemas

pwd_context <span class="token operator">=</span> CryptContext<span class="token punctuation">(</span>schemes<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"bcrypt"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> deprecated<span class="token operator">=</span><span class="token string">"auto"</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">get_password_hash</span><span class="token punctuation">(</span>password<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">str</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> pwd_context<span class="token punctuation">.</span><span class="token builtin">hash</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">verify_password</span><span class="token punctuation">(</span>plain_password<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> hashed_password<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> pwd_context<span class="token punctuation">.</span>verify<span class="token punctuation">(</span>plain_password<span class="token punctuation">,</span> hashed_password<span class="token punctuation">)</span>

<span class="token comment"># 用户CRUD</span>
<span class="token keyword">class</span> <span class="token class-name">UserCRUD</span><span class="token punctuation">:</span>
    <span class="token decorator annotation punctuation">@staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">get_user</span><span class="token punctuation">(</span>db<span class="token punctuation">:</span> Session<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Optional<span class="token punctuation">[</span>models<span class="token punctuation">.</span>User<span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> db<span class="token punctuation">.</span>query<span class="token punctuation">(</span>models<span class="token punctuation">.</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token builtin">id</span> <span class="token operator">==</span> user_id<span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token decorator annotation punctuation">@staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">get_user_by_email</span><span class="token punctuation">(</span>db<span class="token punctuation">:</span> Session<span class="token punctuation">,</span> email<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Optional<span class="token punctuation">[</span>models<span class="token punctuation">.</span>User<span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> db<span class="token punctuation">.</span>query<span class="token punctuation">(</span>models<span class="token punctuation">.</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>User<span class="token punctuation">.</span>email <span class="token operator">==</span> email<span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token decorator annotation punctuation">@staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">get_user_by_username</span><span class="token punctuation">(</span>db<span class="token punctuation">:</span> Session<span class="token punctuation">,</span> username<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Optional<span class="token punctuation">[</span>models<span class="token punctuation">.</span>User<span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> db<span class="token punctuation">.</span>query<span class="token punctuation">(</span>models<span class="token punctuation">.</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>User<span class="token punctuation">.</span>username <span class="token operator">==</span> username<span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token decorator annotation punctuation">@staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">get_users</span><span class="token punctuation">(</span>db<span class="token punctuation">:</span> Session<span class="token punctuation">,</span> skip<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> limit<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> List<span class="token punctuation">[</span>models<span class="token punctuation">.</span>User<span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> db<span class="token punctuation">.</span>query<span class="token punctuation">(</span>models<span class="token punctuation">.</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span>offset<span class="token punctuation">(</span>skip<span class="token punctuation">)</span><span class="token punctuation">.</span>limit<span class="token punctuation">(</span>limit<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token decorator annotation punctuation">@staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">create_user</span><span class="token punctuation">(</span>db<span class="token punctuation">:</span> Session<span class="token punctuation">,</span> user<span class="token punctuation">:</span> schemas<span class="token punctuation">.</span>UserCreate<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> models<span class="token punctuation">.</span>User<span class="token punctuation">:</span>
        hashed_password <span class="token operator">=</span> get_password_hash<span class="token punctuation">(</span>user<span class="token punctuation">.</span>password<span class="token punctuation">)</span>
        db_user <span class="token operator">=</span> models<span class="token punctuation">.</span>User<span class="token punctuation">(</span>
            email<span class="token operator">=</span>user<span class="token punctuation">.</span>email<span class="token punctuation">,</span>
            username<span class="token operator">=</span>user<span class="token punctuation">.</span>username<span class="token punctuation">,</span>
            hashed_password<span class="token operator">=</span>hashed_password<span class="token punctuation">,</span>
            is_active<span class="token operator">=</span>user<span class="token punctuation">.</span>is_active
        <span class="token punctuation">)</span>
        db<span class="token punctuation">.</span>add<span class="token punctuation">(</span>db_user<span class="token punctuation">)</span>
        db<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
        db<span class="token punctuation">.</span>refresh<span class="token punctuation">(</span>db_user<span class="token punctuation">)</span>
        <span class="token keyword">return</span> db_user
    
    <span class="token decorator annotation punctuation">@staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">update_user</span><span class="token punctuation">(</span>db<span class="token punctuation">:</span> Session<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> user_update<span class="token punctuation">:</span> schemas<span class="token punctuation">.</span>UserUpdate<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Optional<span class="token punctuation">[</span>models<span class="token punctuation">.</span>User<span class="token punctuation">]</span><span class="token punctuation">:</span>
        db_user <span class="token operator">=</span> db<span class="token punctuation">.</span>query<span class="token punctuation">(</span>models<span class="token punctuation">.</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token builtin">id</span> <span class="token operator">==</span> user_id<span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> db_user<span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token boolean">None</span>
        
        update_data <span class="token operator">=</span> user_update<span class="token punctuation">.</span><span class="token builtin">dict</span><span class="token punctuation">(</span>exclude_unset<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token string">'password'</span> <span class="token keyword">in</span> update_data<span class="token punctuation">:</span>
            update_data<span class="token punctuation">[</span><span class="token string">'hashed_password'</span><span class="token punctuation">]</span> <span class="token operator">=</span> get_password_hash<span class="token punctuation">(</span>update_data<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        
        <span class="token keyword">for</span> field<span class="token punctuation">,</span> value <span class="token keyword">in</span> update_data<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token builtin">setattr</span><span class="token punctuation">(</span>db_user<span class="token punctuation">,</span> field<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
        
        db<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
        db<span class="token punctuation">.</span>refresh<span class="token punctuation">(</span>db_user<span class="token punctuation">)</span>
        <span class="token keyword">return</span> db_user
    
    <span class="token decorator annotation punctuation">@staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">delete_user</span><span class="token punctuation">(</span>db<span class="token punctuation">:</span> Session<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
        db_user <span class="token operator">=</span> db<span class="token punctuation">.</span>query<span class="token punctuation">(</span>models<span class="token punctuation">.</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token builtin">id</span> <span class="token operator">==</span> user_id<span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> db_user<span class="token punctuation">:</span>
            db<span class="token punctuation">.</span>delete<span class="token punctuation">(</span>db_user<span class="token punctuation">)</span>
            db<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">True</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>

<span class="token comment"># 异步用户CRUD</span>
<span class="token keyword">class</span> <span class="token class-name">AsyncUserCRUD</span><span class="token punctuation">:</span>
    <span class="token decorator annotation punctuation">@staticmethod</span>
    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get_user</span><span class="token punctuation">(</span>db<span class="token punctuation">:</span> AsyncSession<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Optional<span class="token punctuation">[</span>models<span class="token punctuation">.</span>User<span class="token punctuation">]</span><span class="token punctuation">:</span>
        result <span class="token operator">=</span> <span class="token keyword">await</span> db<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>select<span class="token punctuation">(</span>models<span class="token punctuation">.</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span>models<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token builtin">id</span> <span class="token operator">==</span> user_id<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> result<span class="token punctuation">.</span>scalar_one_or_none<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token decorator annotation punctuation">@staticmethod</span>
    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get_user_by_username</span><span class="token punctuation">(</span>db<span class="token punctuation">:</span> AsyncSession<span class="token punctuation">,</span> username<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Optional<span class="token punctuation">[</span>models<span class="token punctuation">.</span>User<span class="token punctuation">]</span><span class="token punctuation">:</span>
        result <span class="token operator">=</span> <span class="token keyword">await</span> db<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>select<span class="token punctuation">(</span>models<span class="token punctuation">.</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span>models<span class="token punctuation">.</span>User<span class="token punctuation">.</span>username <span class="token operator">==</span> username<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> result<span class="token punctuation">.</span>scalar_one_or_none<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token decorator annotation punctuation">@staticmethod</span>
    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">create_user</span><span class="token punctuation">(</span>db<span class="token punctuation">:</span> AsyncSession<span class="token punctuation">,</span> user<span class="token punctuation">:</span> schemas<span class="token punctuation">.</span>UserCreate<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> models<span class="token punctuation">.</span>User<span class="token punctuation">:</span>
        hashed_password <span class="token operator">=</span> get_password_hash<span class="token punctuation">(</span>user<span class="token punctuation">.</span>password<span class="token punctuation">)</span>
        db_user <span class="token operator">=</span> models<span class="token punctuation">.</span>User<span class="token punctuation">(</span>
            email<span class="token operator">=</span>user<span class="token punctuation">.</span>email<span class="token punctuation">,</span>
            username<span class="token operator">=</span>user<span class="token punctuation">.</span>username<span class="token punctuation">,</span>
            hashed_password<span class="token operator">=</span>hashed_password<span class="token punctuation">,</span>
            is_active<span class="token operator">=</span>user<span class="token punctuation">.</span>is_active
        <span class="token punctuation">)</span>
        db<span class="token punctuation">.</span>add<span class="token punctuation">(</span>db_user<span class="token punctuation">)</span>
        <span class="token keyword">await</span> db<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">await</span> db<span class="token punctuation">.</span>refresh<span class="token punctuation">(</span>db_user<span class="token punctuation">)</span>
        <span class="token keyword">return</span> db_user

<span class="token comment"># 商品CRUD</span>
<span class="token keyword">class</span> <span class="token class-name">ItemCRUD</span><span class="token punctuation">:</span>
    <span class="token decorator annotation punctuation">@staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">get_items</span><span class="token punctuation">(</span>db<span class="token punctuation">:</span> Session<span class="token punctuation">,</span> skip<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> limit<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> List<span class="token punctuation">[</span>models<span class="token punctuation">.</span>Item<span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> db<span class="token punctuation">.</span>query<span class="token punctuation">(</span>models<span class="token punctuation">.</span>Item<span class="token punctuation">)</span><span class="token punctuation">.</span>offset<span class="token punctuation">(</span>skip<span class="token punctuation">)</span><span class="token punctuation">.</span>limit<span class="token punctuation">(</span>limit<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token decorator annotation punctuation">@staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">get_item</span><span class="token punctuation">(</span>db<span class="token punctuation">:</span> Session<span class="token punctuation">,</span> item_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Optional<span class="token punctuation">[</span>models<span class="token punctuation">.</span>Item<span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> db<span class="token punctuation">.</span>query<span class="token punctuation">(</span>models<span class="token punctuation">.</span>Item<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Item<span class="token punctuation">.</span><span class="token builtin">id</span> <span class="token operator">==</span> item_id<span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token decorator annotation punctuation">@staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">create_user_item</span><span class="token punctuation">(</span>db<span class="token punctuation">:</span> Session<span class="token punctuation">,</span> item<span class="token punctuation">:</span> schemas<span class="token punctuation">.</span>ItemCreate<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> models<span class="token punctuation">.</span>Item<span class="token punctuation">:</span>
        db_item <span class="token operator">=</span> models<span class="token punctuation">.</span>Item<span class="token punctuation">(</span><span class="token operator">**</span>item<span class="token punctuation">.</span><span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> owner_id<span class="token operator">=</span>user_id<span class="token punctuation">)</span>
        db<span class="token punctuation">.</span>add<span class="token punctuation">(</span>db_item<span class="token punctuation">)</span>
        db<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
        db<span class="token punctuation">.</span>refresh<span class="token punctuation">(</span>db_item<span class="token punctuation">)</span>
        <span class="token keyword">return</span> db_item
    
    <span class="token decorator annotation punctuation">@staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">update_item</span><span class="token punctuation">(</span>db<span class="token punctuation">:</span> Session<span class="token punctuation">,</span> item_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> item_update<span class="token punctuation">:</span> schemas<span class="token punctuation">.</span>ItemUpdate<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Optional<span class="token punctuation">[</span>models<span class="token punctuation">.</span>Item<span class="token punctuation">]</span><span class="token punctuation">:</span>
        db_item <span class="token operator">=</span> db<span class="token punctuation">.</span>query<span class="token punctuation">(</span>models<span class="token punctuation">.</span>Item<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Item<span class="token punctuation">.</span><span class="token builtin">id</span> <span class="token operator">==</span> item_id<span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> db_item<span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token boolean">None</span>
        
        update_data <span class="token operator">=</span> item_update<span class="token punctuation">.</span><span class="token builtin">dict</span><span class="token punctuation">(</span>exclude_unset<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> field<span class="token punctuation">,</span> value <span class="token keyword">in</span> update_data<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token builtin">setattr</span><span class="token punctuation">(</span>db_item<span class="token punctuation">,</span> field<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
        
        db<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
        db<span class="token punctuation">.</span>refresh<span class="token punctuation">(</span>db_item<span class="token punctuation">)</span>
        <span class="token keyword">return</span> db_item<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h1 id="三、认证与授权"><a href="#三、认证与授权" class="headerlink" title="三、认证与授权"></a>三、认证与授权</h1><h2 id="（一）JWT认证"><a href="#（一）JWT认证" class="headerlink" title="（一）JWT认证"></a>（一）JWT认证</h2><h3 id="1-JWT配置"><a href="#1-JWT配置" class="headerlink" title="1. JWT配置"></a>1. JWT配置</h3><figure><div class="code-wrapper"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># auth.py</span>
<span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime<span class="token punctuation">,</span> timedelta
<span class="token keyword">from</span> typing <span class="token keyword">import</span> Optional
<span class="token keyword">from</span> jose <span class="token keyword">import</span> JWTError<span class="token punctuation">,</span> jwt
<span class="token keyword">from</span> passlib<span class="token punctuation">.</span>context <span class="token keyword">import</span> CryptContext
<span class="token keyword">from</span> fastapi <span class="token keyword">import</span> Depends<span class="token punctuation">,</span> HTTPException<span class="token punctuation">,</span> status
<span class="token keyword">from</span> fastapi<span class="token punctuation">.</span>security <span class="token keyword">import</span> OAuth2PasswordBearer<span class="token punctuation">,</span> OAuth2PasswordRequestForm
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> Session
<span class="token keyword">import</span> crud
<span class="token keyword">import</span> schemas
<span class="token keyword">from</span> database <span class="token keyword">import</span> get_db

<span class="token comment"># 配置</span>
SECRET_KEY <span class="token operator">=</span> <span class="token string">"your-secret-key-here"</span>  <span class="token comment"># 在生产环境中使用环境变量</span>
ALGORITHM <span class="token operator">=</span> <span class="token string">"HS256"</span>
ACCESS_TOKEN_EXPIRE_MINUTES <span class="token operator">=</span> <span class="token number">30</span>

pwd_context <span class="token operator">=</span> CryptContext<span class="token punctuation">(</span>schemes<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"bcrypt"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> deprecated<span class="token operator">=</span><span class="token string">"auto"</span><span class="token punctuation">)</span>
oauth2_scheme <span class="token operator">=</span> OAuth2PasswordBearer<span class="token punctuation">(</span>tokenUrl<span class="token operator">=</span><span class="token string">"token"</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">verify_password</span><span class="token punctuation">(</span>plain_password<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> hashed_password<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> pwd_context<span class="token punctuation">.</span>verify<span class="token punctuation">(</span>plain_password<span class="token punctuation">,</span> hashed_password<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">get_password_hash</span><span class="token punctuation">(</span>password<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">str</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> pwd_context<span class="token punctuation">.</span><span class="token builtin">hash</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">authenticate_user</span><span class="token punctuation">(</span>db<span class="token punctuation">:</span> Session<span class="token punctuation">,</span> username<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> password<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    user <span class="token operator">=</span> crud<span class="token punctuation">.</span>UserCRUD<span class="token punctuation">.</span>get_user_by_username<span class="token punctuation">(</span>db<span class="token punctuation">,</span> username<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> user<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> verify_password<span class="token punctuation">(</span>password<span class="token punctuation">,</span> user<span class="token punctuation">.</span>hashed_password<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>
    <span class="token keyword">return</span> user

<span class="token keyword">def</span> <span class="token function">create_access_token</span><span class="token punctuation">(</span>data<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">,</span> expires_delta<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>timedelta<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    to_encode <span class="token operator">=</span> data<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> expires_delta<span class="token punctuation">:</span>
        expire <span class="token operator">=</span> datetime<span class="token punctuation">.</span>utcnow<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> expires_delta
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        expire <span class="token operator">=</span> datetime<span class="token punctuation">.</span>utcnow<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> timedelta<span class="token punctuation">(</span>minutes<span class="token operator">=</span><span class="token number">15</span><span class="token punctuation">)</span>
    to_encode<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"exp"</span><span class="token punctuation">:</span> expire<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    encoded_jwt <span class="token operator">=</span> jwt<span class="token punctuation">.</span>encode<span class="token punctuation">(</span>to_encode<span class="token punctuation">,</span> SECRET_KEY<span class="token punctuation">,</span> algorithm<span class="token operator">=</span>ALGORITHM<span class="token punctuation">)</span>
    <span class="token keyword">return</span> encoded_jwt

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get_current_user</span><span class="token punctuation">(</span>token<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> Depends<span class="token punctuation">(</span>oauth2_scheme<span class="token punctuation">)</span><span class="token punctuation">,</span> db<span class="token punctuation">:</span> Session <span class="token operator">=</span> Depends<span class="token punctuation">(</span>get_db<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    credentials_exception <span class="token operator">=</span> HTTPException<span class="token punctuation">(</span>
        status_code<span class="token operator">=</span>status<span class="token punctuation">.</span>HTTP_401_UNAUTHORIZED<span class="token punctuation">,</span>
        detail<span class="token operator">=</span><span class="token string">"Could not validate credentials"</span><span class="token punctuation">,</span>
        headers<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">"WWW-Authenticate"</span><span class="token punctuation">:</span> <span class="token string">"Bearer"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        payload <span class="token operator">=</span> jwt<span class="token punctuation">.</span>decode<span class="token punctuation">(</span>token<span class="token punctuation">,</span> SECRET_KEY<span class="token punctuation">,</span> algorithms<span class="token operator">=</span><span class="token punctuation">[</span>ALGORITHM<span class="token punctuation">]</span><span class="token punctuation">)</span>
        username<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> payload<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"sub"</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> username <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> credentials_exception
        token_data <span class="token operator">=</span> schemas<span class="token punctuation">.</span>TokenData<span class="token punctuation">(</span>username<span class="token operator">=</span>username<span class="token punctuation">)</span>
    <span class="token keyword">except</span> JWTError<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> credentials_exception
    
    user <span class="token operator">=</span> crud<span class="token punctuation">.</span>UserCRUD<span class="token punctuation">.</span>get_user_by_username<span class="token punctuation">(</span>db<span class="token punctuation">,</span> username<span class="token operator">=</span>token_data<span class="token punctuation">.</span>username<span class="token punctuation">)</span>
    <span class="token keyword">if</span> user <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> credentials_exception
    <span class="token keyword">return</span> user

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get_current_active_user</span><span class="token punctuation">(</span>current_user<span class="token punctuation">:</span> schemas<span class="token punctuation">.</span>User <span class="token operator">=</span> Depends<span class="token punctuation">(</span>get_current_user<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> current_user<span class="token punctuation">.</span>is_active<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> HTTPException<span class="token punctuation">(</span>status_code<span class="token operator">=</span><span class="token number">400</span><span class="token punctuation">,</span> detail<span class="token operator">=</span><span class="token string">"Inactive user"</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> current_user

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get_current_superuser</span><span class="token punctuation">(</span>current_user<span class="token punctuation">:</span> schemas<span class="token punctuation">.</span>User <span class="token operator">=</span> Depends<span class="token punctuation">(</span>get_current_user<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> current_user<span class="token punctuation">.</span>is_superuser<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> HTTPException<span class="token punctuation">(</span>
            status_code<span class="token operator">=</span>status<span class="token punctuation">.</span>HTTP_403_FORBIDDEN<span class="token punctuation">,</span>
            detail<span class="token operator">=</span><span class="token string">"Not enough permissions"</span>
        <span class="token punctuation">)</span>
    <span class="token keyword">return</span> current_user<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h3 id="2-认证路由"><a href="#2-认证路由" class="headerlink" title="2. 认证路由"></a>2. 认证路由</h3><figure><div class="code-wrapper"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># routers/auth.py</span>
<span class="token keyword">from</span> datetime <span class="token keyword">import</span> timedelta
<span class="token keyword">from</span> fastapi <span class="token keyword">import</span> APIRouter<span class="token punctuation">,</span> Depends<span class="token punctuation">,</span> HTTPException<span class="token punctuation">,</span> status
<span class="token keyword">from</span> fastapi<span class="token punctuation">.</span>security <span class="token keyword">import</span> OAuth2PasswordRequestForm
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> Session
<span class="token keyword">import</span> crud
<span class="token keyword">import</span> schemas
<span class="token keyword">from</span> database <span class="token keyword">import</span> get_db
<span class="token keyword">from</span> auth <span class="token keyword">import</span> authenticate_user<span class="token punctuation">,</span> create_access_token<span class="token punctuation">,</span> ACCESS_TOKEN_EXPIRE_MINUTES

router <span class="token operator">=</span> APIRouter<span class="token punctuation">(</span>prefix<span class="token operator">=</span><span class="token string">"/auth"</span><span class="token punctuation">,</span> tags<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"认证"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@router<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">"/register"</span><span class="token punctuation">,</span> response_model<span class="token operator">=</span>schemas<span class="token punctuation">.</span>User<span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">register</span><span class="token punctuation">(</span>user<span class="token punctuation">:</span> schemas<span class="token punctuation">.</span>UserCreate<span class="token punctuation">,</span> db<span class="token punctuation">:</span> Session <span class="token operator">=</span> Depends<span class="token punctuation">(</span>get_db<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 检查用户是否已存在</span>
    db_user <span class="token operator">=</span> crud<span class="token punctuation">.</span>UserCRUD<span class="token punctuation">.</span>get_user_by_email<span class="token punctuation">(</span>db<span class="token punctuation">,</span> email<span class="token operator">=</span>user<span class="token punctuation">.</span>email<span class="token punctuation">)</span>
    <span class="token keyword">if</span> db_user<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> HTTPException<span class="token punctuation">(</span>
            status_code<span class="token operator">=</span><span class="token number">400</span><span class="token punctuation">,</span> 
            detail<span class="token operator">=</span><span class="token string">"邮箱已被注册"</span>
        <span class="token punctuation">)</span>
    
    db_user <span class="token operator">=</span> crud<span class="token punctuation">.</span>UserCRUD<span class="token punctuation">.</span>get_user_by_username<span class="token punctuation">(</span>db<span class="token punctuation">,</span> username<span class="token operator">=</span>user<span class="token punctuation">.</span>username<span class="token punctuation">)</span>
    <span class="token keyword">if</span> db_user<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> HTTPException<span class="token punctuation">(</span>
            status_code<span class="token operator">=</span><span class="token number">400</span><span class="token punctuation">,</span> 
            detail<span class="token operator">=</span><span class="token string">"用户名已被使用"</span>
        <span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> crud<span class="token punctuation">.</span>UserCRUD<span class="token punctuation">.</span>create_user<span class="token punctuation">(</span>db<span class="token operator">=</span>db<span class="token punctuation">,</span> user<span class="token operator">=</span>user<span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@router<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">"/token"</span><span class="token punctuation">,</span> response_model<span class="token operator">=</span>schemas<span class="token punctuation">.</span>Token<span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">login_for_access_token</span><span class="token punctuation">(</span>
    form_data<span class="token punctuation">:</span> OAuth2PasswordRequestForm <span class="token operator">=</span> Depends<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
    db<span class="token punctuation">:</span> Session <span class="token operator">=</span> Depends<span class="token punctuation">(</span>get_db<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span>
    user <span class="token operator">=</span> authenticate_user<span class="token punctuation">(</span>db<span class="token punctuation">,</span> form_data<span class="token punctuation">.</span>username<span class="token punctuation">,</span> form_data<span class="token punctuation">.</span>password<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> user<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> HTTPException<span class="token punctuation">(</span>
            status_code<span class="token operator">=</span>status<span class="token punctuation">.</span>HTTP_401_UNAUTHORIZED<span class="token punctuation">,</span>
            detail<span class="token operator">=</span><span class="token string">"用户名或密码错误"</span><span class="token punctuation">,</span>
            headers<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">"WWW-Authenticate"</span><span class="token punctuation">:</span> <span class="token string">"Bearer"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
    access_token_expires <span class="token operator">=</span> timedelta<span class="token punctuation">(</span>minutes<span class="token operator">=</span>ACCESS_TOKEN_EXPIRE_MINUTES<span class="token punctuation">)</span>
    access_token <span class="token operator">=</span> create_access_token<span class="token punctuation">(</span>
        data<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">"sub"</span><span class="token punctuation">:</span> user<span class="token punctuation">.</span>username<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> expires_delta<span class="token operator">=</span>access_token_expires
    <span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">"access_token"</span><span class="token punctuation">:</span> access_token<span class="token punctuation">,</span> <span class="token string">"token_type"</span><span class="token punctuation">:</span> <span class="token string">"bearer"</span><span class="token punctuation">&#125;</span>

<span class="token decorator annotation punctuation">@router<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/me"</span><span class="token punctuation">,</span> response_model<span class="token operator">=</span>schemas<span class="token punctuation">.</span>User<span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">read_users_me</span><span class="token punctuation">(</span>current_user<span class="token punctuation">:</span> schemas<span class="token punctuation">.</span>User <span class="token operator">=</span> Depends<span class="token punctuation">(</span>get_current_active_user<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> current_user

<span class="token decorator annotation punctuation">@router<span class="token punctuation">.</span>put</span><span class="token punctuation">(</span><span class="token string">"/me"</span><span class="token punctuation">,</span> response_model<span class="token operator">=</span>schemas<span class="token punctuation">.</span>User<span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">update_user_me</span><span class="token punctuation">(</span>
    user_update<span class="token punctuation">:</span> schemas<span class="token punctuation">.</span>UserUpdate<span class="token punctuation">,</span>
    current_user<span class="token punctuation">:</span> schemas<span class="token punctuation">.</span>User <span class="token operator">=</span> Depends<span class="token punctuation">(</span>get_current_active_user<span class="token punctuation">)</span><span class="token punctuation">,</span>
    db<span class="token punctuation">:</span> Session <span class="token operator">=</span> Depends<span class="token punctuation">(</span>get_db<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> crud<span class="token punctuation">.</span>UserCRUD<span class="token punctuation">.</span>update_user<span class="token punctuation">(</span>db<span class="token punctuation">,</span> current_user<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span> user_update<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h2 id="（二）权限控制"><a href="#（二）权限控制" class="headerlink" title="（二）权限控制"></a>（二）权限控制</h2><h3 id="1-基于角色的权限"><a href="#1-基于角色的权限" class="headerlink" title="1. 基于角色的权限"></a>1. 基于角色的权限</h3><figure><div class="code-wrapper"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># permissions.py</span>
<span class="token keyword">from</span> enum <span class="token keyword">import</span> Enum
<span class="token keyword">from</span> typing <span class="token keyword">import</span> List
<span class="token keyword">from</span> fastapi <span class="token keyword">import</span> HTTPException<span class="token punctuation">,</span> status<span class="token punctuation">,</span> Depends
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> Session
<span class="token keyword">import</span> models
<span class="token keyword">from</span> auth <span class="token keyword">import</span> get_current_active_user
<span class="token keyword">from</span> database <span class="token keyword">import</span> get_db

<span class="token keyword">class</span> <span class="token class-name">Permission</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">,</span> Enum<span class="token punctuation">)</span><span class="token punctuation">:</span>
    READ <span class="token operator">=</span> <span class="token string">"read"</span>
    WRITE <span class="token operator">=</span> <span class="token string">"write"</span>
    DELETE <span class="token operator">=</span> <span class="token string">"delete"</span>
    ADMIN <span class="token operator">=</span> <span class="token string">"admin"</span>

<span class="token keyword">class</span> <span class="token class-name">Role</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">,</span> Enum<span class="token punctuation">)</span><span class="token punctuation">:</span>
    USER <span class="token operator">=</span> <span class="token string">"user"</span>
    MODERATOR <span class="token operator">=</span> <span class="token string">"moderator"</span>
    ADMIN <span class="token operator">=</span> <span class="token string">"admin"</span>
    SUPERUSER <span class="token operator">=</span> <span class="token string">"superuser"</span>

<span class="token comment"># 角色权限映射</span>
ROLE_PERMISSIONS <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    Role<span class="token punctuation">.</span>USER<span class="token punctuation">:</span> <span class="token punctuation">[</span>Permission<span class="token punctuation">.</span>READ<span class="token punctuation">]</span><span class="token punctuation">,</span>
    Role<span class="token punctuation">.</span>MODERATOR<span class="token punctuation">:</span> <span class="token punctuation">[</span>Permission<span class="token punctuation">.</span>READ<span class="token punctuation">,</span> Permission<span class="token punctuation">.</span>WRITE<span class="token punctuation">]</span><span class="token punctuation">,</span>
    Role<span class="token punctuation">.</span>ADMIN<span class="token punctuation">:</span> <span class="token punctuation">[</span>Permission<span class="token punctuation">.</span>READ<span class="token punctuation">,</span> Permission<span class="token punctuation">.</span>WRITE<span class="token punctuation">,</span> Permission<span class="token punctuation">.</span>DELETE<span class="token punctuation">]</span><span class="token punctuation">,</span>
    Role<span class="token punctuation">.</span>SUPERUSER<span class="token punctuation">:</span> <span class="token punctuation">[</span>Permission<span class="token punctuation">.</span>READ<span class="token punctuation">,</span> Permission<span class="token punctuation">.</span>WRITE<span class="token punctuation">,</span> Permission<span class="token punctuation">.</span>DELETE<span class="token punctuation">,</span> Permission<span class="token punctuation">.</span>ADMIN<span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">def</span> <span class="token function">require_permissions</span><span class="token punctuation">(</span>required_permissions<span class="token punctuation">:</span> List<span class="token punctuation">[</span>Permission<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">permission_checker</span><span class="token punctuation">(</span>
        current_user<span class="token punctuation">:</span> models<span class="token punctuation">.</span>User <span class="token operator">=</span> Depends<span class="token punctuation">(</span>get_current_active_user<span class="token punctuation">)</span><span class="token punctuation">,</span>
        db<span class="token punctuation">:</span> Session <span class="token operator">=</span> Depends<span class="token punctuation">(</span>get_db<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 超级用户拥有所有权限</span>
        <span class="token keyword">if</span> current_user<span class="token punctuation">.</span>is_superuser<span class="token punctuation">:</span>
            <span class="token keyword">return</span> current_user
        
        <span class="token comment"># 检查用户角色权限</span>
        user_role <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>current_user<span class="token punctuation">,</span> <span class="token string">'role'</span><span class="token punctuation">,</span> Role<span class="token punctuation">.</span>USER<span class="token punctuation">)</span>
        user_permissions <span class="token operator">=</span> ROLE_PERMISSIONS<span class="token punctuation">.</span>get<span class="token punctuation">(</span>user_role<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        
        <span class="token keyword">for</span> permission <span class="token keyword">in</span> required_permissions<span class="token punctuation">:</span>
            <span class="token keyword">if</span> permission <span class="token keyword">not</span> <span class="token keyword">in</span> user_permissions<span class="token punctuation">:</span>
                <span class="token keyword">raise</span> HTTPException<span class="token punctuation">(</span>
                    status_code<span class="token operator">=</span>status<span class="token punctuation">.</span>HTTP_403_FORBIDDEN<span class="token punctuation">,</span>
                    detail<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"需要 </span><span class="token interpolation"><span class="token punctuation">&#123;</span>permission<span class="token punctuation">.</span>value<span class="token punctuation">&#125;</span></span><span class="token string"> 权限"</span></span>
                <span class="token punctuation">)</span>
        
        <span class="token keyword">return</span> current_user
    
    <span class="token keyword">return</span> permission_checker

<span class="token keyword">def</span> <span class="token function">require_owner_or_admin</span><span class="token punctuation">(</span>resource_owner_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">owner_checker</span><span class="token punctuation">(</span>
        current_user<span class="token punctuation">:</span> models<span class="token punctuation">.</span>User <span class="token operator">=</span> Depends<span class="token punctuation">(</span>get_current_active_user<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> current_user<span class="token punctuation">.</span>is_superuser <span class="token keyword">or</span> current_user<span class="token punctuation">.</span><span class="token builtin">id</span> <span class="token operator">==</span> resource_owner_id<span class="token punctuation">:</span>
            <span class="token keyword">return</span> current_user
        
        <span class="token keyword">raise</span> HTTPException<span class="token punctuation">(</span>
            status_code<span class="token operator">=</span>status<span class="token punctuation">.</span>HTTP_403_FORBIDDEN<span class="token punctuation">,</span>
            detail<span class="token operator">=</span><span class="token string">"只能操作自己的资源"</span>
        <span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> owner_checker

<span class="token comment"># 使用示例</span>
<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/admin/users"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">get_all_users</span><span class="token punctuation">(</span>
    db<span class="token punctuation">:</span> Session <span class="token operator">=</span> Depends<span class="token punctuation">(</span>get_db<span class="token punctuation">)</span><span class="token punctuation">,</span>
    current_user<span class="token punctuation">:</span> models<span class="token punctuation">.</span>User <span class="token operator">=</span> Depends<span class="token punctuation">(</span>require_permissions<span class="token punctuation">(</span><span class="token punctuation">[</span>Permission<span class="token punctuation">.</span>ADMIN<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> crud<span class="token punctuation">.</span>UserCRUD<span class="token punctuation">.</span>get_users<span class="token punctuation">(</span>db<span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>delete</span><span class="token punctuation">(</span><span class="token string">"/items/&#123;item_id&#125;"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">delete_item</span><span class="token punctuation">(</span>
    item_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
    db<span class="token punctuation">:</span> Session <span class="token operator">=</span> Depends<span class="token punctuation">(</span>get_db<span class="token punctuation">)</span><span class="token punctuation">,</span>
    current_user<span class="token punctuation">:</span> models<span class="token punctuation">.</span>User <span class="token operator">=</span> Depends<span class="token punctuation">(</span>get_current_active_user<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span>
    item <span class="token operator">=</span> crud<span class="token punctuation">.</span>ItemCRUD<span class="token punctuation">.</span>get_item<span class="token punctuation">(</span>db<span class="token punctuation">,</span> item_id<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> item<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> HTTPException<span class="token punctuation">(</span>status_code<span class="token operator">=</span><span class="token number">404</span><span class="token punctuation">,</span> detail<span class="token operator">=</span><span class="token string">"商品不存在"</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 检查是否为所有者或管理员</span>
    require_owner_or_admin<span class="token punctuation">(</span>item<span class="token punctuation">.</span>owner_id<span class="token punctuation">)</span><span class="token punctuation">(</span>current_user<span class="token punctuation">)</span>
    
    <span class="token comment"># 删除逻辑...</span>
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"删除成功"</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h1 id="四、API路由与中间件"><a href="#四、API路由与中间件" class="headerlink" title="四、API路由与中间件"></a>四、API路由与中间件</h1><h2 id="（一）路由组织"><a href="#（一）路由组织" class="headerlink" title="（一）路由组织"></a>（一）路由组织</h2><h3 id="1-路由模块化"><a href="#1-路由模块化" class="headerlink" title="1. 路由模块化"></a>1. 路由模块化</h3><figure><div class="code-wrapper"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># routers/users.py</span>
<span class="token keyword">from</span> fastapi <span class="token keyword">import</span> APIRouter<span class="token punctuation">,</span> Depends<span class="token punctuation">,</span> HTTPException<span class="token punctuation">,</span> status
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> Session
<span class="token keyword">from</span> typing <span class="token keyword">import</span> List
<span class="token keyword">import</span> crud
<span class="token keyword">import</span> schemas
<span class="token keyword">from</span> database <span class="token keyword">import</span> get_db
<span class="token keyword">from</span> auth <span class="token keyword">import</span> get_current_active_user<span class="token punctuation">,</span> get_current_superuser

router <span class="token operator">=</span> APIRouter<span class="token punctuation">(</span>
    prefix<span class="token operator">=</span><span class="token string">"/users"</span><span class="token punctuation">,</span>
    tags<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"用户管理"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    dependencies<span class="token operator">=</span><span class="token punctuation">[</span>Depends<span class="token punctuation">(</span>get_current_active_user<span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@router<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> response_model<span class="token operator">=</span>List<span class="token punctuation">[</span>schemas<span class="token punctuation">.</span>User<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">read_users</span><span class="token punctuation">(</span>
    skip<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> 
    limit<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">,</span> 
    db<span class="token punctuation">:</span> Session <span class="token operator">=</span> Depends<span class="token punctuation">(</span>get_db<span class="token punctuation">)</span><span class="token punctuation">,</span>
    current_user<span class="token punctuation">:</span> schemas<span class="token punctuation">.</span>User <span class="token operator">=</span> Depends<span class="token punctuation">(</span>get_current_superuser<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span>
    users <span class="token operator">=</span> crud<span class="token punctuation">.</span>UserCRUD<span class="token punctuation">.</span>get_users<span class="token punctuation">(</span>db<span class="token punctuation">,</span> skip<span class="token operator">=</span>skip<span class="token punctuation">,</span> limit<span class="token operator">=</span>limit<span class="token punctuation">)</span>
    <span class="token keyword">return</span> users

<span class="token decorator annotation punctuation">@router<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/&#123;user_id&#125;"</span><span class="token punctuation">,</span> response_model<span class="token operator">=</span>schemas<span class="token punctuation">.</span>User<span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">read_user</span><span class="token punctuation">(</span>
    user_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> 
    db<span class="token punctuation">:</span> Session <span class="token operator">=</span> Depends<span class="token punctuation">(</span>get_db<span class="token punctuation">)</span><span class="token punctuation">,</span>
    current_user<span class="token punctuation">:</span> schemas<span class="token punctuation">.</span>User <span class="token operator">=</span> Depends<span class="token punctuation">(</span>get_current_active_user<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 用户只能查看自己的信息，除非是超级用户</span>
    <span class="token keyword">if</span> user_id <span class="token operator">!=</span> current_user<span class="token punctuation">.</span><span class="token builtin">id</span> <span class="token keyword">and</span> <span class="token keyword">not</span> current_user<span class="token punctuation">.</span>is_superuser<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> HTTPException<span class="token punctuation">(</span>
            status_code<span class="token operator">=</span>status<span class="token punctuation">.</span>HTTP_403_FORBIDDEN<span class="token punctuation">,</span>
            detail<span class="token operator">=</span><span class="token string">"没有权限查看其他用户信息"</span>
        <span class="token punctuation">)</span>
    
    db_user <span class="token operator">=</span> crud<span class="token punctuation">.</span>UserCRUD<span class="token punctuation">.</span>get_user<span class="token punctuation">(</span>db<span class="token punctuation">,</span> user_id<span class="token operator">=</span>user_id<span class="token punctuation">)</span>
    <span class="token keyword">if</span> db_user <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> HTTPException<span class="token punctuation">(</span>status_code<span class="token operator">=</span><span class="token number">404</span><span class="token punctuation">,</span> detail<span class="token operator">=</span><span class="token string">"用户不存在"</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> db_user

<span class="token decorator annotation punctuation">@router<span class="token punctuation">.</span>put</span><span class="token punctuation">(</span><span class="token string">"/&#123;user_id&#125;"</span><span class="token punctuation">,</span> response_model<span class="token operator">=</span>schemas<span class="token punctuation">.</span>User<span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">update_user</span><span class="token punctuation">(</span>
    user_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
    user_update<span class="token punctuation">:</span> schemas<span class="token punctuation">.</span>UserUpdate<span class="token punctuation">,</span>
    db<span class="token punctuation">:</span> Session <span class="token operator">=</span> Depends<span class="token punctuation">(</span>get_db<span class="token punctuation">)</span><span class="token punctuation">,</span>
    current_user<span class="token punctuation">:</span> schemas<span class="token punctuation">.</span>User <span class="token operator">=</span> Depends<span class="token punctuation">(</span>get_current_active_user<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 用户只能更新自己的信息，除非是超级用户</span>
    <span class="token keyword">if</span> user_id <span class="token operator">!=</span> current_user<span class="token punctuation">.</span><span class="token builtin">id</span> <span class="token keyword">and</span> <span class="token keyword">not</span> current_user<span class="token punctuation">.</span>is_superuser<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> HTTPException<span class="token punctuation">(</span>
            status_code<span class="token operator">=</span>status<span class="token punctuation">.</span>HTTP_403_FORBIDDEN<span class="token punctuation">,</span>
            detail<span class="token operator">=</span><span class="token string">"没有权限修改其他用户信息"</span>
        <span class="token punctuation">)</span>
    
    db_user <span class="token operator">=</span> crud<span class="token punctuation">.</span>UserCRUD<span class="token punctuation">.</span>update_user<span class="token punctuation">(</span>db<span class="token punctuation">,</span> user_id<span class="token punctuation">,</span> user_update<span class="token punctuation">)</span>
    <span class="token keyword">if</span> db_user <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> HTTPException<span class="token punctuation">(</span>status_code<span class="token operator">=</span><span class="token number">404</span><span class="token punctuation">,</span> detail<span class="token operator">=</span><span class="token string">"用户不存在"</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> db_user

<span class="token decorator annotation punctuation">@router<span class="token punctuation">.</span>delete</span><span class="token punctuation">(</span><span class="token string">"/&#123;user_id&#125;"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">delete_user</span><span class="token punctuation">(</span>
    user_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
    db<span class="token punctuation">:</span> Session <span class="token operator">=</span> Depends<span class="token punctuation">(</span>get_db<span class="token punctuation">)</span><span class="token punctuation">,</span>
    current_user<span class="token punctuation">:</span> schemas<span class="token punctuation">.</span>User <span class="token operator">=</span> Depends<span class="token punctuation">(</span>get_current_superuser<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span>
    success <span class="token operator">=</span> crud<span class="token punctuation">.</span>UserCRUD<span class="token punctuation">.</span>delete_user<span class="token punctuation">(</span>db<span class="token punctuation">,</span> user_id<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> success<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> HTTPException<span class="token punctuation">(</span>status_code<span class="token operator">=</span><span class="token number">404</span><span class="token punctuation">,</span> detail<span class="token operator">=</span><span class="token string">"用户不存在"</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"用户删除成功"</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<figure><div class="code-wrapper"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># routers/items.py</span>
<span class="token keyword">from</span> fastapi <span class="token keyword">import</span> APIRouter<span class="token punctuation">,</span> Depends<span class="token punctuation">,</span> HTTPException<span class="token punctuation">,</span> Query
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> Session
<span class="token keyword">from</span> typing <span class="token keyword">import</span> List<span class="token punctuation">,</span> Optional
<span class="token keyword">import</span> crud
<span class="token keyword">import</span> schemas
<span class="token keyword">from</span> database <span class="token keyword">import</span> get_db
<span class="token keyword">from</span> auth <span class="token keyword">import</span> get_current_active_user

router <span class="token operator">=</span> APIRouter<span class="token punctuation">(</span>prefix<span class="token operator">=</span><span class="token string">"/items"</span><span class="token punctuation">,</span> tags<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"商品管理"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@router<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> response_model<span class="token operator">=</span>List<span class="token punctuation">[</span>schemas<span class="token punctuation">.</span>Item<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">read_items</span><span class="token punctuation">(</span>
    skip<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> Query<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> ge<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> description<span class="token operator">=</span><span class="token string">"跳过的记录数"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    limit<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> Query<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> ge<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> le<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">,</span> description<span class="token operator">=</span><span class="token string">"返回的记录数"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    search<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> Query<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">,</span> description<span class="token operator">=</span><span class="token string">"搜索关键词"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    db<span class="token punctuation">:</span> Session <span class="token operator">=</span> Depends<span class="token punctuation">(</span>get_db<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span>
    items <span class="token operator">=</span> crud<span class="token punctuation">.</span>ItemCRUD<span class="token punctuation">.</span>get_items<span class="token punctuation">(</span>db<span class="token punctuation">,</span> skip<span class="token operator">=</span>skip<span class="token punctuation">,</span> limit<span class="token operator">=</span>limit<span class="token punctuation">)</span>
    <span class="token keyword">return</span> items

<span class="token decorator annotation punctuation">@router<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/&#123;item_id&#125;"</span><span class="token punctuation">,</span> response_model<span class="token operator">=</span>schemas<span class="token punctuation">.</span>Item<span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">read_item</span><span class="token punctuation">(</span>item_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> db<span class="token punctuation">:</span> Session <span class="token operator">=</span> Depends<span class="token punctuation">(</span>get_db<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    db_item <span class="token operator">=</span> crud<span class="token punctuation">.</span>ItemCRUD<span class="token punctuation">.</span>get_item<span class="token punctuation">(</span>db<span class="token punctuation">,</span> item_id<span class="token operator">=</span>item_id<span class="token punctuation">)</span>
    <span class="token keyword">if</span> db_item <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> HTTPException<span class="token punctuation">(</span>status_code<span class="token operator">=</span><span class="token number">404</span><span class="token punctuation">,</span> detail<span class="token operator">=</span><span class="token string">"商品不存在"</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> db_item

<span class="token decorator annotation punctuation">@router<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> response_model<span class="token operator">=</span>schemas<span class="token punctuation">.</span>Item<span class="token punctuation">,</span> status_code<span class="token operator">=</span>status<span class="token punctuation">.</span>HTTP_201_CREATED<span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">create_item</span><span class="token punctuation">(</span>
    item<span class="token punctuation">:</span> schemas<span class="token punctuation">.</span>ItemCreate<span class="token punctuation">,</span>
    db<span class="token punctuation">:</span> Session <span class="token operator">=</span> Depends<span class="token punctuation">(</span>get_db<span class="token punctuation">)</span><span class="token punctuation">,</span>
    current_user<span class="token punctuation">:</span> schemas<span class="token punctuation">.</span>User <span class="token operator">=</span> Depends<span class="token punctuation">(</span>get_current_active_user<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> crud<span class="token punctuation">.</span>ItemCRUD<span class="token punctuation">.</span>create_user_item<span class="token punctuation">(</span>db<span class="token operator">=</span>db<span class="token punctuation">,</span> item<span class="token operator">=</span>item<span class="token punctuation">,</span> user_id<span class="token operator">=</span>current_user<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@router<span class="token punctuation">.</span>put</span><span class="token punctuation">(</span><span class="token string">"/&#123;item_id&#125;"</span><span class="token punctuation">,</span> response_model<span class="token operator">=</span>schemas<span class="token punctuation">.</span>Item<span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">update_item</span><span class="token punctuation">(</span>
    item_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
    item_update<span class="token punctuation">:</span> schemas<span class="token punctuation">.</span>ItemUpdate<span class="token punctuation">,</span>
    db<span class="token punctuation">:</span> Session <span class="token operator">=</span> Depends<span class="token punctuation">(</span>get_db<span class="token punctuation">)</span><span class="token punctuation">,</span>
    current_user<span class="token punctuation">:</span> schemas<span class="token punctuation">.</span>User <span class="token operator">=</span> Depends<span class="token punctuation">(</span>get_current_active_user<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 检查商品是否存在</span>
    db_item <span class="token operator">=</span> crud<span class="token punctuation">.</span>ItemCRUD<span class="token punctuation">.</span>get_item<span class="token punctuation">(</span>db<span class="token punctuation">,</span> item_id<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> db_item<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> HTTPException<span class="token punctuation">(</span>status_code<span class="token operator">=</span><span class="token number">404</span><span class="token punctuation">,</span> detail<span class="token operator">=</span><span class="token string">"商品不存在"</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 检查权限</span>
    <span class="token keyword">if</span> db_item<span class="token punctuation">.</span>owner_id <span class="token operator">!=</span> current_user<span class="token punctuation">.</span><span class="token builtin">id</span> <span class="token keyword">and</span> <span class="token keyword">not</span> current_user<span class="token punctuation">.</span>is_superuser<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> HTTPException<span class="token punctuation">(</span>
            status_code<span class="token operator">=</span>status<span class="token punctuation">.</span>HTTP_403_FORBIDDEN<span class="token punctuation">,</span>
            detail<span class="token operator">=</span><span class="token string">"只能修改自己的商品"</span>
        <span class="token punctuation">)</span>
    
    updated_item <span class="token operator">=</span> crud<span class="token punctuation">.</span>ItemCRUD<span class="token punctuation">.</span>update_item<span class="token punctuation">(</span>db<span class="token punctuation">,</span> item_id<span class="token punctuation">,</span> item_update<span class="token punctuation">)</span>
    <span class="token keyword">return</span> updated_item<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h3 id="2-主应用配置"><a href="#2-主应用配置" class="headerlink" title="2. 主应用配置"></a>2. 主应用配置</h3><figure><div class="code-wrapper"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># main.py</span>
<span class="token keyword">from</span> fastapi <span class="token keyword">import</span> FastAPI<span class="token punctuation">,</span> Request<span class="token punctuation">,</span> status
<span class="token keyword">from</span> fastapi<span class="token punctuation">.</span>middleware<span class="token punctuation">.</span>cors <span class="token keyword">import</span> CORSMiddleware
<span class="token keyword">from</span> fastapi<span class="token punctuation">.</span>middleware<span class="token punctuation">.</span>trustedhost <span class="token keyword">import</span> TrustedHostMiddleware
<span class="token keyword">from</span> fastapi<span class="token punctuation">.</span>responses <span class="token keyword">import</span> JSONResponse
<span class="token keyword">from</span> fastapi<span class="token punctuation">.</span>exceptions <span class="token keyword">import</span> RequestValidationError
<span class="token keyword">from</span> starlette<span class="token punctuation">.</span>exceptions <span class="token keyword">import</span> HTTPException <span class="token keyword">as</span> StarletteHTTPException
<span class="token keyword">import</span> time
<span class="token keyword">import</span> logging

<span class="token comment"># 导入路由</span>
<span class="token keyword">from</span> routers <span class="token keyword">import</span> auth<span class="token punctuation">,</span> users<span class="token punctuation">,</span> items
<span class="token keyword">from</span> database <span class="token keyword">import</span> engine
<span class="token keyword">import</span> models

<span class="token comment"># 创建数据库表</span>
models<span class="token punctuation">.</span>Base<span class="token punctuation">.</span>metadata<span class="token punctuation">.</span>create_all<span class="token punctuation">(</span>bind<span class="token operator">=</span>engine<span class="token punctuation">)</span>

<span class="token comment"># 创建FastAPI应用</span>
app <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span>
    title<span class="token operator">=</span><span class="token string">"我的API应用"</span><span class="token punctuation">,</span>
    description<span class="token operator">=</span><span class="token string">"这是一个完整的FastAPI应用示例"</span><span class="token punctuation">,</span>
    version<span class="token operator">=</span><span class="token string">"1.0.0"</span><span class="token punctuation">,</span>
    docs_url<span class="token operator">=</span><span class="token string">"/docs"</span><span class="token punctuation">,</span>
    redoc_url<span class="token operator">=</span><span class="token string">"/redoc"</span>
<span class="token punctuation">)</span>

<span class="token comment"># 配置CORS</span>
app<span class="token punctuation">.</span>add_middleware<span class="token punctuation">(</span>
    CORSMiddleware<span class="token punctuation">,</span>
    allow_origins<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"http://localhost:3000"</span><span class="token punctuation">,</span> <span class="token string">"https://yourdomain.com"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    allow_credentials<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    allow_methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"*"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    allow_headers<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"*"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>

<span class="token comment"># 信任的主机</span>
app<span class="token punctuation">.</span>add_middleware<span class="token punctuation">(</span>
    TrustedHostMiddleware<span class="token punctuation">,</span> 
    allowed_hosts<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token string">"*.yourdomain.com"</span><span class="token punctuation">]</span>
<span class="token punctuation">)</span>

<span class="token comment"># 包含路由</span>
app<span class="token punctuation">.</span>include_router<span class="token punctuation">(</span>auth<span class="token punctuation">.</span>router<span class="token punctuation">)</span>
app<span class="token punctuation">.</span>include_router<span class="token punctuation">(</span>users<span class="token punctuation">.</span>router<span class="token punctuation">)</span>
app<span class="token punctuation">.</span>include_router<span class="token punctuation">(</span>items<span class="token punctuation">.</span>router<span class="token punctuation">)</span>

<span class="token comment"># 全局异常处理</span>
<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>exception_handler</span><span class="token punctuation">(</span>StarletteHTTPException<span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">http_exception_handler</span><span class="token punctuation">(</span>request<span class="token punctuation">:</span> Request<span class="token punctuation">,</span> exc<span class="token punctuation">:</span> StarletteHTTPException<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> JSONResponse<span class="token punctuation">(</span>
        status_code<span class="token operator">=</span>exc<span class="token punctuation">.</span>status_code<span class="token punctuation">,</span>
        content<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">"message"</span><span class="token punctuation">:</span> exc<span class="token punctuation">.</span>detail<span class="token punctuation">,</span> <span class="token string">"status_code"</span><span class="token punctuation">:</span> exc<span class="token punctuation">.</span>status_code<span class="token punctuation">&#125;</span>
    <span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>exception_handler</span><span class="token punctuation">(</span>RequestValidationError<span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">validation_exception_handler</span><span class="token punctuation">(</span>request<span class="token punctuation">:</span> Request<span class="token punctuation">,</span> exc<span class="token punctuation">:</span> RequestValidationError<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> JSONResponse<span class="token punctuation">(</span>
        status_code<span class="token operator">=</span>status<span class="token punctuation">.</span>HTTP_422_UNPROCESSABLE_ENTITY<span class="token punctuation">,</span>
        content<span class="token operator">=</span><span class="token punctuation">&#123;</span>
            <span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"请求数据验证失败"</span><span class="token punctuation">,</span>
            <span class="token string">"details"</span><span class="token punctuation">:</span> exc<span class="token punctuation">.</span>errors<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">)</span>

<span class="token comment"># 请求日志中间件</span>
<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>middleware</span><span class="token punctuation">(</span><span class="token string">"http"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">log_requests</span><span class="token punctuation">(</span>request<span class="token punctuation">:</span> Request<span class="token punctuation">,</span> call_next<span class="token punctuation">)</span><span class="token punctuation">:</span>
    start_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    response <span class="token operator">=</span> <span class="token keyword">await</span> call_next<span class="token punctuation">(</span>request<span class="token punctuation">)</span>
    
    process_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start_time
    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span>
        <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>request<span class="token punctuation">.</span>method<span class="token punctuation">&#125;</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">&#123;</span>request<span class="token punctuation">.</span>url<span class="token punctuation">&#125;</span></span><span class="token string"> - </span><span class="token interpolation"><span class="token punctuation">&#123;</span>response<span class="token punctuation">.</span>status_code<span class="token punctuation">&#125;</span></span><span class="token string"> - </span><span class="token interpolation"><span class="token punctuation">&#123;</span>process_time<span class="token punctuation">:</span><span class="token format-spec">.4f</span><span class="token punctuation">&#125;</span></span><span class="token string">s"</span></span>
    <span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> response

<span class="token comment"># 健康检查</span>
<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/health"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">health_check</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">"status"</span><span class="token punctuation">:</span> <span class="token string">"healthy"</span><span class="token punctuation">,</span> <span class="token string">"timestamp"</span><span class="token punctuation">:</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span>

<span class="token comment"># 根路径</span>
<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">read_root</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"欢迎使用我的API"</span><span class="token punctuation">,</span>
        <span class="token string">"docs"</span><span class="token punctuation">:</span> <span class="token string">"/docs"</span><span class="token punctuation">,</span>
        <span class="token string">"redoc"</span><span class="token punctuation">:</span> <span class="token string">"/redoc"</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h2 id="（二）中间件"><a href="#（二）中间件" class="headerlink" title="（二）中间件"></a>（二）中间件</h2><h3 id="1-自定义中间件"><a href="#1-自定义中间件" class="headerlink" title="1. 自定义中间件"></a>1. 自定义中间件</h3><figure><div class="code-wrapper"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># middleware.py</span>
<span class="token keyword">import</span> time
<span class="token keyword">import</span> uuid
<span class="token keyword">from</span> fastapi <span class="token keyword">import</span> Request<span class="token punctuation">,</span> Response
<span class="token keyword">from</span> starlette<span class="token punctuation">.</span>middleware<span class="token punctuation">.</span>base <span class="token keyword">import</span> BaseHTTPMiddleware
<span class="token keyword">from</span> starlette<span class="token punctuation">.</span>responses <span class="token keyword">import</span> JSONResponse
<span class="token keyword">import</span> logging

<span class="token keyword">class</span> <span class="token class-name">RequestIDMiddleware</span><span class="token punctuation">(</span>BaseHTTPMiddleware<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""为每个请求添加唯一ID"""</span>
    
    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">dispatch</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">:</span> Request<span class="token punctuation">,</span> call_next<span class="token punctuation">)</span><span class="token punctuation">:</span>
        request_id <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>uuid<span class="token punctuation">.</span>uuid4<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        request<span class="token punctuation">.</span>state<span class="token punctuation">.</span>request_id <span class="token operator">=</span> request_id
        
        response <span class="token operator">=</span> <span class="token keyword">await</span> call_next<span class="token punctuation">(</span>request<span class="token punctuation">)</span>
        response<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">"X-Request-ID"</span><span class="token punctuation">]</span> <span class="token operator">=</span> request_id
        
        <span class="token keyword">return</span> response

<span class="token keyword">class</span> <span class="token class-name">TimingMiddleware</span><span class="token punctuation">(</span>BaseHTTPMiddleware<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""记录请求处理时间"""</span>
    
    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">dispatch</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">:</span> Request<span class="token punctuation">,</span> call_next<span class="token punctuation">)</span><span class="token punctuation">:</span>
        start_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        response <span class="token operator">=</span> <span class="token keyword">await</span> call_next<span class="token punctuation">(</span>request<span class="token punctuation">)</span>
        
        process_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start_time
        response<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">"X-Process-Time"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>process_time<span class="token punctuation">)</span>
        
        <span class="token keyword">return</span> response

<span class="token keyword">class</span> <span class="token class-name">RateLimitMiddleware</span><span class="token punctuation">(</span>BaseHTTPMiddleware<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""简单的速率限制中间件"""</span>
    
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> app<span class="token punctuation">,</span> calls<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">,</span> period<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>app<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>calls <span class="token operator">=</span> calls
        self<span class="token punctuation">.</span>period <span class="token operator">=</span> period
        self<span class="token punctuation">.</span>clients <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    
    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">dispatch</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">:</span> Request<span class="token punctuation">,</span> call_next<span class="token punctuation">)</span><span class="token punctuation">:</span>
        client_ip <span class="token operator">=</span> request<span class="token punctuation">.</span>client<span class="token punctuation">.</span>host
        current_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        <span class="token comment"># 清理过期记录</span>
        <span class="token keyword">if</span> client_ip <span class="token keyword">in</span> self<span class="token punctuation">.</span>clients<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>clients<span class="token punctuation">[</span>client_ip<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
                timestamp <span class="token keyword">for</span> timestamp <span class="token keyword">in</span> self<span class="token punctuation">.</span>clients<span class="token punctuation">[</span>client_ip<span class="token punctuation">]</span>
                <span class="token keyword">if</span> current_time <span class="token operator">-</span> timestamp <span class="token operator">&lt;</span> self<span class="token punctuation">.</span>period
            <span class="token punctuation">]</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>clients<span class="token punctuation">[</span>client_ip<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        
        <span class="token comment"># 检查速率限制</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>clients<span class="token punctuation">[</span>client_ip<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">>=</span> self<span class="token punctuation">.</span>calls<span class="token punctuation">:</span>
            <span class="token keyword">return</span> JSONResponse<span class="token punctuation">(</span>
                status_code<span class="token operator">=</span><span class="token number">429</span><span class="token punctuation">,</span>
                content<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"请求过于频繁，请稍后再试"</span><span class="token punctuation">&#125;</span>
            <span class="token punctuation">)</span>
        
        <span class="token comment"># 记录请求时间</span>
        self<span class="token punctuation">.</span>clients<span class="token punctuation">[</span>client_ip<span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>current_time<span class="token punctuation">)</span>
        
        response <span class="token operator">=</span> <span class="token keyword">await</span> call_next<span class="token punctuation">(</span>request<span class="token punctuation">)</span>
        <span class="token keyword">return</span> response

<span class="token keyword">class</span> <span class="token class-name">SecurityHeadersMiddleware</span><span class="token punctuation">(</span>BaseHTTPMiddleware<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""添加安全头"""</span>
    
    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">dispatch</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">:</span> Request<span class="token punctuation">,</span> call_next<span class="token punctuation">)</span><span class="token punctuation">:</span>
        response <span class="token operator">=</span> <span class="token keyword">await</span> call_next<span class="token punctuation">(</span>request<span class="token punctuation">)</span>
        
        response<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">"X-Content-Type-Options"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"nosniff"</span>
        response<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">"X-Frame-Options"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"DENY"</span>
        response<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">"X-XSS-Protection"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"1; mode=block"</span>
        response<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">"Strict-Transport-Security"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"max-age=31536000; includeSubDomains"</span>
        
        <span class="token keyword">return</span> response

<span class="token comment"># 在main.py中使用</span>
app<span class="token punctuation">.</span>add_middleware<span class="token punctuation">(</span>SecurityHeadersMiddleware<span class="token punctuation">)</span>
app<span class="token punctuation">.</span>add_middleware<span class="token punctuation">(</span>RateLimitMiddleware<span class="token punctuation">,</span> calls<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span> period<span class="token operator">=</span><span class="token number">60</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span>add_middleware<span class="token punctuation">(</span>TimingMiddleware<span class="token punctuation">)</span>
app<span class="token punctuation">.</span>add_middleware<span class="token punctuation">(</span>RequestIDMiddleware<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h1 id="五、文件处理与WebSocket"><a href="#五、文件处理与WebSocket" class="headerlink" title="五、文件处理与WebSocket"></a>五、文件处理与WebSocket</h1><h2 id="（一）文件上传与下载"><a href="#（一）文件上传与下载" class="headerlink" title="（一）文件上传与下载"></a>（一）文件上传与下载</h2><h3 id="1-文件上传"><a href="#1-文件上传" class="headerlink" title="1. 文件上传"></a>1. 文件上传</h3><figure><div class="code-wrapper"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># routers/files.py</span>
<span class="token keyword">from</span> fastapi <span class="token keyword">import</span> APIRouter<span class="token punctuation">,</span> File<span class="token punctuation">,</span> UploadFile<span class="token punctuation">,</span> HTTPException<span class="token punctuation">,</span> Depends<span class="token punctuation">,</span> Form
<span class="token keyword">from</span> fastapi<span class="token punctuation">.</span>responses <span class="token keyword">import</span> FileResponse
<span class="token keyword">from</span> typing <span class="token keyword">import</span> List<span class="token punctuation">,</span> Optional
<span class="token keyword">import</span> os
<span class="token keyword">import</span> shutil
<span class="token keyword">import</span> uuid
<span class="token keyword">from</span> pathlib <span class="token keyword">import</span> Path
<span class="token keyword">import</span> aiofiles
<span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image
<span class="token keyword">import</span> magic

router <span class="token operator">=</span> APIRouter<span class="token punctuation">(</span>prefix<span class="token operator">=</span><span class="token string">"/files"</span><span class="token punctuation">,</span> tags<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"文件管理"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment"># 配置</span>
UPLOAD_DIR <span class="token operator">=</span> Path<span class="token punctuation">(</span><span class="token string">"uploads"</span><span class="token punctuation">)</span>
UPLOAD_DIR<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span>exist_ok<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
MAX_FILE_SIZE <span class="token operator">=</span> <span class="token number">10</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span>  <span class="token comment"># 10MB</span>
ALLOWED_EXTENSIONS <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">".jpg"</span><span class="token punctuation">,</span> <span class="token string">".jpeg"</span><span class="token punctuation">,</span> <span class="token string">".png"</span><span class="token punctuation">,</span> <span class="token string">".gif"</span><span class="token punctuation">,</span> <span class="token string">".pdf"</span><span class="token punctuation">,</span> <span class="token string">".txt"</span><span class="token punctuation">,</span> <span class="token string">".docx"</span><span class="token punctuation">&#125;</span>
ALLOWED_MIME_TYPES <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token string">"image/jpeg"</span><span class="token punctuation">,</span> <span class="token string">"image/png"</span><span class="token punctuation">,</span> <span class="token string">"image/gif"</span><span class="token punctuation">,</span>
    <span class="token string">"application/pdf"</span><span class="token punctuation">,</span> <span class="token string">"text/plain"</span><span class="token punctuation">,</span>
    <span class="token string">"application/vnd.openxmlformats-officedocument.wordprocessingml.document"</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">def</span> <span class="token function">validate_file</span><span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">:</span> UploadFile<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""验证文件"""</span>
    <span class="token comment"># 检查文件扩展名</span>
    file_ext <span class="token operator">=</span> Path<span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">.</span>filename<span class="token punctuation">)</span><span class="token punctuation">.</span>suffix<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> file_ext <span class="token keyword">not</span> <span class="token keyword">in</span> ALLOWED_EXTENSIONS<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>
    
    <span class="token comment"># 检查MIME类型</span>
    <span class="token keyword">if</span> <span class="token builtin">file</span><span class="token punctuation">.</span>content_type <span class="token keyword">not</span> <span class="token keyword">in</span> ALLOWED_MIME_TYPES<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>
    
    <span class="token keyword">return</span> <span class="token boolean">True</span>

<span class="token decorator annotation punctuation">@router<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">"/upload"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">upload_file</span><span class="token punctuation">(</span>
    <span class="token builtin">file</span><span class="token punctuation">:</span> UploadFile <span class="token operator">=</span> File<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    description<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> Form<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 验证文件</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> validate_file<span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> HTTPException<span class="token punctuation">(</span>
            status_code<span class="token operator">=</span><span class="token number">400</span><span class="token punctuation">,</span>
            detail<span class="token operator">=</span><span class="token string">"不支持的文件类型"</span>
        <span class="token punctuation">)</span>
    
    <span class="token comment"># 检查文件大小</span>
    file_content <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token builtin">file</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>file_content<span class="token punctuation">)</span> <span class="token operator">></span> MAX_FILE_SIZE<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> HTTPException<span class="token punctuation">(</span>
            status_code<span class="token operator">=</span><span class="token number">400</span><span class="token punctuation">,</span>
            detail<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"文件大小不能超过 </span><span class="token interpolation"><span class="token punctuation">&#123;</span>MAX_FILE_SIZE <span class="token operator">//</span> <span class="token punctuation">(</span><span class="token number">1024</span><span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">MB"</span></span>
        <span class="token punctuation">)</span>
    
    <span class="token comment"># 生成唯一文件名</span>
    file_ext <span class="token operator">=</span> Path<span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">.</span>filename<span class="token punctuation">)</span><span class="token punctuation">.</span>suffix
    unique_filename <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>uuid<span class="token punctuation">.</span>uuid4<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token interpolation"><span class="token punctuation">&#123;</span>file_ext<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span>
    file_path <span class="token operator">=</span> UPLOAD_DIR <span class="token operator">/</span> unique_filename
    
    <span class="token comment"># 保存文件</span>
    <span class="token keyword">async</span> <span class="token keyword">with</span> aiofiles<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> <span class="token string">'wb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        <span class="token keyword">await</span> f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>file_content<span class="token punctuation">)</span>
    
    <span class="token comment"># 如果是图片，生成缩略图</span>
    <span class="token keyword">if</span> <span class="token builtin">file</span><span class="token punctuation">.</span>content_type<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">'image/'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            thumbnail_path <span class="token operator">=</span> UPLOAD_DIR <span class="token operator">/</span> <span class="token string-interpolation"><span class="token string">f"thumb_</span><span class="token interpolation"><span class="token punctuation">&#123;</span>unique_filename<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span>
            <span class="token keyword">with</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>file_path<span class="token punctuation">)</span> <span class="token keyword">as</span> img<span class="token punctuation">:</span>
                img<span class="token punctuation">.</span>thumbnail<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                img<span class="token punctuation">.</span>save<span class="token punctuation">(</span>thumbnail_path<span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            logging<span class="token punctuation">.</span>warning<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"生成缩略图失败: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>e<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"filename"</span><span class="token punctuation">:</span> unique_filename<span class="token punctuation">,</span>
        <span class="token string">"original_filename"</span><span class="token punctuation">:</span> <span class="token builtin">file</span><span class="token punctuation">.</span>filename<span class="token punctuation">,</span>
        <span class="token string">"size"</span><span class="token punctuation">:</span> <span class="token builtin">len</span><span class="token punctuation">(</span>file_content<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">"content_type"</span><span class="token punctuation">:</span> <span class="token builtin">file</span><span class="token punctuation">.</span>content_type<span class="token punctuation">,</span>
        <span class="token string">"description"</span><span class="token punctuation">:</span> description
    <span class="token punctuation">&#125;</span>

<span class="token decorator annotation punctuation">@router<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">"/upload-multiple"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">upload_multiple_files</span><span class="token punctuation">(</span>
    files<span class="token punctuation">:</span> List<span class="token punctuation">[</span>UploadFile<span class="token punctuation">]</span> <span class="token operator">=</span> File<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">10</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> HTTPException<span class="token punctuation">(</span>
            status_code<span class="token operator">=</span><span class="token number">400</span><span class="token punctuation">,</span>
            detail<span class="token operator">=</span><span class="token string">"一次最多上传10个文件"</span>
        <span class="token punctuation">)</span>
    
    results <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> <span class="token builtin">file</span> <span class="token keyword">in</span> files<span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            result <span class="token operator">=</span> <span class="token keyword">await</span> upload_file<span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">)</span>
            results<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"success"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token string">"data"</span><span class="token punctuation">:</span> result<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> HTTPException <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            results<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
                <span class="token string">"success"</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span> 
                <span class="token string">"filename"</span><span class="token punctuation">:</span> <span class="token builtin">file</span><span class="token punctuation">.</span>filename<span class="token punctuation">,</span>
                <span class="token string">"error"</span><span class="token punctuation">:</span> e<span class="token punctuation">.</span>detail
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">"results"</span><span class="token punctuation">:</span> results<span class="token punctuation">&#125;</span>

<span class="token decorator annotation punctuation">@router<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/download/&#123;filename&#125;"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">download_file</span><span class="token punctuation">(</span>filename<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    file_path <span class="token operator">=</span> UPLOAD_DIR <span class="token operator">/</span> filename
    
    <span class="token keyword">if</span> <span class="token keyword">not</span> file_path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> HTTPException<span class="token punctuation">(</span>status_code<span class="token operator">=</span><span class="token number">404</span><span class="token punctuation">,</span> detail<span class="token operator">=</span><span class="token string">"文件不存在"</span><span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> FileResponse<span class="token punctuation">(</span>
        path<span class="token operator">=</span>file_path<span class="token punctuation">,</span>
        filename<span class="token operator">=</span>filename<span class="token punctuation">,</span>
        media_type<span class="token operator">=</span><span class="token string">'application/octet-stream'</span>
    <span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@router<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/thumbnail/&#123;filename&#125;"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get_thumbnail</span><span class="token punctuation">(</span>filename<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    thumbnail_path <span class="token operator">=</span> UPLOAD_DIR <span class="token operator">/</span> <span class="token string-interpolation"><span class="token string">f"thumb_</span><span class="token interpolation"><span class="token punctuation">&#123;</span>filename<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span>
    
    <span class="token keyword">if</span> <span class="token keyword">not</span> thumbnail_path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 如果缩略图不存在，返回原图</span>
        original_path <span class="token operator">=</span> UPLOAD_DIR <span class="token operator">/</span> filename
        <span class="token keyword">if</span> <span class="token keyword">not</span> original_path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> HTTPException<span class="token punctuation">(</span>status_code<span class="token operator">=</span><span class="token number">404</span><span class="token punctuation">,</span> detail<span class="token operator">=</span><span class="token string">"文件不存在"</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> FileResponse<span class="token punctuation">(</span>path<span class="token operator">=</span>original_path<span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> FileResponse<span class="token punctuation">(</span>path<span class="token operator">=</span>thumbnail_path<span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@router<span class="token punctuation">.</span>delete</span><span class="token punctuation">(</span><span class="token string">"/delete/&#123;filename&#125;"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">delete_file</span><span class="token punctuation">(</span>filename<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    file_path <span class="token operator">=</span> UPLOAD_DIR <span class="token operator">/</span> filename
    thumbnail_path <span class="token operator">=</span> UPLOAD_DIR <span class="token operator">/</span> <span class="token string-interpolation"><span class="token string">f"thumb_</span><span class="token interpolation"><span class="token punctuation">&#123;</span>filename<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span>
    
    <span class="token keyword">if</span> <span class="token keyword">not</span> file_path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> HTTPException<span class="token punctuation">(</span>status_code<span class="token operator">=</span><span class="token number">404</span><span class="token punctuation">,</span> detail<span class="token operator">=</span><span class="token string">"文件不存在"</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 删除原文件</span>
    os<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>file_path<span class="token punctuation">)</span>
    
    <span class="token comment"># 删除缩略图（如果存在）</span>
    <span class="token keyword">if</span> thumbnail_path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        os<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>thumbnail_path<span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"文件删除成功"</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h2 id="（二）WebSocket实时通信"><a href="#（二）WebSocket实时通信" class="headerlink" title="（二）WebSocket实时通信"></a>（二）WebSocket实时通信</h2><h3 id="1-WebSocket基础"><a href="#1-WebSocket基础" class="headerlink" title="1. WebSocket基础"></a>1. WebSocket基础</h3><figure><div class="code-wrapper"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># routers/websocket.py</span>
<span class="token keyword">from</span> fastapi <span class="token keyword">import</span> APIRouter<span class="token punctuation">,</span> WebSocket<span class="token punctuation">,</span> WebSocketDisconnect<span class="token punctuation">,</span> Depends
<span class="token keyword">from</span> typing <span class="token keyword">import</span> List<span class="token punctuation">,</span> Dict
<span class="token keyword">import</span> json
<span class="token keyword">import</span> asyncio
<span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime

router <span class="token operator">=</span> APIRouter<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">ConnectionManager</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""WebSocket连接管理器"""</span>
    
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>active_connections<span class="token punctuation">:</span> List<span class="token punctuation">[</span>WebSocket<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>user_connections<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> WebSocket<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    
    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">connect</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> websocket<span class="token punctuation">:</span> WebSocket<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">await</span> websocket<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>active_connections<span class="token punctuation">.</span>append<span class="token punctuation">(</span>websocket<span class="token punctuation">)</span>
        <span class="token keyword">if</span> user_id<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>user_connections<span class="token punctuation">[</span>user_id<span class="token punctuation">]</span> <span class="token operator">=</span> websocket
    
    <span class="token keyword">def</span> <span class="token function">disconnect</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> websocket<span class="token punctuation">:</span> WebSocket<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>active_connections<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>websocket<span class="token punctuation">)</span>
        <span class="token keyword">if</span> user_id <span class="token keyword">and</span> user_id <span class="token keyword">in</span> self<span class="token punctuation">.</span>user_connections<span class="token punctuation">:</span>
            <span class="token keyword">del</span> self<span class="token punctuation">.</span>user_connections<span class="token punctuation">[</span>user_id<span class="token punctuation">]</span>
    
    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">send_personal_message</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> message<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> websocket<span class="token punctuation">:</span> WebSocket<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">await</span> websocket<span class="token punctuation">.</span>send_text<span class="token punctuation">(</span>message<span class="token punctuation">)</span>
    
    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">send_to_user</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> message<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> user_id <span class="token keyword">in</span> self<span class="token punctuation">.</span>user_connections<span class="token punctuation">:</span>
            websocket <span class="token operator">=</span> self<span class="token punctuation">.</span>user_connections<span class="token punctuation">[</span>user_id<span class="token punctuation">]</span>
            <span class="token keyword">await</span> websocket<span class="token punctuation">.</span>send_text<span class="token punctuation">(</span>message<span class="token punctuation">)</span>
    
    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">broadcast</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> message<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> connection <span class="token keyword">in</span> self<span class="token punctuation">.</span>active_connections<span class="token punctuation">:</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                <span class="token keyword">await</span> connection<span class="token punctuation">.</span>send_text<span class="token punctuation">(</span>message<span class="token punctuation">)</span>
            <span class="token keyword">except</span><span class="token punctuation">:</span>
                <span class="token comment"># 连接已断开，移除它</span>
                self<span class="token punctuation">.</span>active_connections<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>connection<span class="token punctuation">)</span>

manager <span class="token operator">=</span> ConnectionManager<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@router<span class="token punctuation">.</span>websocket</span><span class="token punctuation">(</span><span class="token string">"/ws/&#123;client_id&#125;"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">websocket_endpoint</span><span class="token punctuation">(</span>websocket<span class="token punctuation">:</span> WebSocket<span class="token punctuation">,</span> client_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">await</span> manager<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>websocket<span class="token punctuation">,</span> client_id<span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            data <span class="token operator">=</span> <span class="token keyword">await</span> websocket<span class="token punctuation">.</span>receive_text<span class="token punctuation">(</span><span class="token punctuation">)</span>
            message_data <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
            
            <span class="token comment"># 处理不同类型的消息</span>
            <span class="token keyword">if</span> message_data<span class="token punctuation">[</span><span class="token string">"type"</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"chat"</span><span class="token punctuation">:</span>
                <span class="token comment"># 聊天消息</span>
                chat_message <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
                    <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"chat"</span><span class="token punctuation">,</span>
                    <span class="token string">"user_id"</span><span class="token punctuation">:</span> client_id<span class="token punctuation">,</span>
                    <span class="token string">"message"</span><span class="token punctuation">:</span> message_data<span class="token punctuation">[</span><span class="token string">"message"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    <span class="token string">"timestamp"</span><span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>isoformat<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">await</span> manager<span class="token punctuation">.</span>broadcast<span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>chat_message<span class="token punctuation">)</span><span class="token punctuation">)</span>
            
            <span class="token keyword">elif</span> message_data<span class="token punctuation">[</span><span class="token string">"type"</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"private"</span><span class="token punctuation">:</span>
                <span class="token comment"># 私人消息</span>
                target_user <span class="token operator">=</span> message_data<span class="token punctuation">[</span><span class="token string">"target_user"</span><span class="token punctuation">]</span>
                private_message <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
                    <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"private"</span><span class="token punctuation">,</span>
                    <span class="token string">"from_user"</span><span class="token punctuation">:</span> client_id<span class="token punctuation">,</span>
                    <span class="token string">"message"</span><span class="token punctuation">:</span> message_data<span class="token punctuation">[</span><span class="token string">"message"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    <span class="token string">"timestamp"</span><span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>isoformat<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">await</span> manager<span class="token punctuation">.</span>send_to_user<span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>private_message<span class="token punctuation">)</span><span class="token punctuation">,</span> target_user<span class="token punctuation">)</span>
            
            <span class="token keyword">elif</span> message_data<span class="token punctuation">[</span><span class="token string">"type"</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"ping"</span><span class="token punctuation">:</span>
                <span class="token comment"># 心跳检测</span>
                pong_message <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
                    <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"pong"</span><span class="token punctuation">,</span>
                    <span class="token string">"timestamp"</span><span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>isoformat<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">await</span> manager<span class="token punctuation">.</span>send_personal_message<span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>pong_message<span class="token punctuation">)</span><span class="token punctuation">,</span> websocket<span class="token punctuation">)</span>
    
    <span class="token keyword">except</span> WebSocketDisconnect<span class="token punctuation">:</span>
        manager<span class="token punctuation">.</span>disconnect<span class="token punctuation">(</span>websocket<span class="token punctuation">,</span> client_id<span class="token punctuation">)</span>
        disconnect_message <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"user_disconnect"</span><span class="token punctuation">,</span>
            <span class="token string">"user_id"</span><span class="token punctuation">:</span> client_id<span class="token punctuation">,</span>
            <span class="token string">"timestamp"</span><span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>isoformat<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">await</span> manager<span class="token punctuation">.</span>broadcast<span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>disconnect_message<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># 聊天室示例</span>
<span class="token keyword">class</span> <span class="token class-name">ChatRoom</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> room_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>room_id <span class="token operator">=</span> room_id
        self<span class="token punctuation">.</span>connections<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> WebSocket<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        self<span class="token punctuation">.</span>messages<span class="token punctuation">:</span> List<span class="token punctuation">[</span>Dict<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    
    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">add_user</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> websocket<span class="token punctuation">:</span> WebSocket<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">await</span> websocket<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>connections<span class="token punctuation">[</span>user_id<span class="token punctuation">]</span> <span class="token operator">=</span> websocket
        
        <span class="token comment"># 发送历史消息</span>
        <span class="token keyword">for</span> message <span class="token keyword">in</span> self<span class="token punctuation">.</span>messages<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">50</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">:</span>  <span class="token comment"># 最近50条消息</span>
            <span class="token keyword">await</span> websocket<span class="token punctuation">.</span>send_text<span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span>
        
        <span class="token comment"># 通知其他用户</span>
        join_message <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"user_join"</span><span class="token punctuation">,</span>
            <span class="token string">"user_id"</span><span class="token punctuation">:</span> user_id<span class="token punctuation">,</span>
            <span class="token string">"timestamp"</span><span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>isoformat<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">await</span> self<span class="token punctuation">.</span>broadcast<span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>join_message<span class="token punctuation">)</span><span class="token punctuation">,</span> exclude_user<span class="token operator">=</span>user_id<span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">remove_user</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> user_id <span class="token keyword">in</span> self<span class="token punctuation">.</span>connections<span class="token punctuation">:</span>
            <span class="token keyword">del</span> self<span class="token punctuation">.</span>connections<span class="token punctuation">[</span>user_id<span class="token punctuation">]</span>
    
    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">broadcast</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> message<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> exclude_user<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> user_id<span class="token punctuation">,</span> websocket <span class="token keyword">in</span> self<span class="token punctuation">.</span>connections<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> user_id <span class="token operator">!=</span> exclude_user<span class="token punctuation">:</span>
                <span class="token keyword">try</span><span class="token punctuation">:</span>
                    <span class="token keyword">await</span> websocket<span class="token punctuation">.</span>send_text<span class="token punctuation">(</span>message<span class="token punctuation">)</span>
                <span class="token keyword">except</span><span class="token punctuation">:</span>
                    <span class="token comment"># 连接已断开</span>
                    <span class="token keyword">pass</span>
    
    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">add_message</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> message<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        message_data <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"message"</span><span class="token punctuation">,</span>
            <span class="token string">"user_id"</span><span class="token punctuation">:</span> user_id<span class="token punctuation">,</span>
            <span class="token string">"message"</span><span class="token punctuation">:</span> message<span class="token punctuation">,</span>
            <span class="token string">"timestamp"</span><span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>isoformat<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
        self<span class="token punctuation">.</span>messages<span class="token punctuation">.</span>append<span class="token punctuation">(</span>message_data<span class="token punctuation">)</span>
        <span class="token keyword">await</span> self<span class="token punctuation">.</span>broadcast<span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>message_data<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># 聊天室管理</span>
chat_rooms<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> ChatRoom<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

<span class="token decorator annotation punctuation">@router<span class="token punctuation">.</span>websocket</span><span class="token punctuation">(</span><span class="token string">"/chat/&#123;room_id&#125;/&#123;user_id&#125;"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">chat_websocket</span><span class="token punctuation">(</span>websocket<span class="token punctuation">:</span> WebSocket<span class="token punctuation">,</span> room_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 创建或获取聊天室</span>
    <span class="token keyword">if</span> room_id <span class="token keyword">not</span> <span class="token keyword">in</span> chat_rooms<span class="token punctuation">:</span>
        chat_rooms<span class="token punctuation">[</span>room_id<span class="token punctuation">]</span> <span class="token operator">=</span> ChatRoom<span class="token punctuation">(</span>room_id<span class="token punctuation">)</span>
    
    room <span class="token operator">=</span> chat_rooms<span class="token punctuation">[</span>room_id<span class="token punctuation">]</span>
    <span class="token keyword">await</span> room<span class="token punctuation">.</span>add_user<span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> websocket<span class="token punctuation">)</span>
    
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            data <span class="token operator">=</span> <span class="token keyword">await</span> websocket<span class="token punctuation">.</span>receive_text<span class="token punctuation">(</span><span class="token punctuation">)</span>
            message_data <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
            
            <span class="token keyword">if</span> message_data<span class="token punctuation">[</span><span class="token string">"type"</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"message"</span><span class="token punctuation">:</span>
                <span class="token keyword">await</span> room<span class="token punctuation">.</span>add_message<span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> message_data<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    
    <span class="token keyword">except</span> WebSocketDisconnect<span class="token punctuation">:</span>
        room<span class="token punctuation">.</span>remove_user<span class="token punctuation">(</span>user_id<span class="token punctuation">)</span>
        leave_message <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"user_leave"</span><span class="token punctuation">,</span>
            <span class="token string">"user_id"</span><span class="token punctuation">:</span> user_id<span class="token punctuation">,</span>
            <span class="token string">"timestamp"</span><span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>isoformat<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">await</span> room<span class="token punctuation">.</span>broadcast<span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>leave_message<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># 实时通知系统</span>
<span class="token decorator annotation punctuation">@router<span class="token punctuation">.</span>websocket</span><span class="token punctuation">(</span><span class="token string">"/notifications/&#123;user_id&#125;"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">notification_websocket</span><span class="token punctuation">(</span>websocket<span class="token punctuation">:</span> WebSocket<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">await</span> manager<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>websocket<span class="token punctuation">,</span> user_id<span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            <span class="token comment"># 保持连接活跃</span>
            <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span>
            ping_message <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
                <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"ping"</span><span class="token punctuation">,</span>
                <span class="token string">"timestamp"</span><span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>isoformat<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">await</span> websocket<span class="token punctuation">.</span>send_text<span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>ping_message<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> WebSocketDisconnect<span class="token punctuation">:</span>
        manager<span class="token punctuation">.</span>disconnect<span class="token punctuation">(</span>websocket<span class="token punctuation">,</span> user_id<span class="token punctuation">)</span>

<span class="token comment"># 发送通知的API端点</span>
<span class="token decorator annotation punctuation">@router<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">"/send-notification"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">send_notification</span><span class="token punctuation">(</span>user_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> message<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> notification_type<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">"info"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    notification <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"notification"</span><span class="token punctuation">,</span>
        <span class="token string">"notification_type"</span><span class="token punctuation">:</span> notification_type<span class="token punctuation">,</span>
        <span class="token string">"message"</span><span class="token punctuation">:</span> message<span class="token punctuation">,</span>
        <span class="token string">"timestamp"</span><span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>isoformat<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">await</span> manager<span class="token punctuation">.</span>send_to_user<span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>notification<span class="token punctuation">)</span><span class="token punctuation">,</span> user_id<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"通知发送成功"</span><span class="token punctuation">&#125;</span>

<span class="token comment"># 六、缓存与性能优化</span>

<span class="token comment">## （一）Redis缓存</span>

<span class="token comment">### 1. Redis配置</span>
```python
<span class="token comment"># cache.py</span>
<span class="token keyword">import</span> redis<span class="token punctuation">.</span>asyncio <span class="token keyword">as</span> redis
<span class="token keyword">import</span> json
<span class="token keyword">from</span> typing <span class="token keyword">import</span> Optional<span class="token punctuation">,</span> Any
<span class="token keyword">from</span> datetime <span class="token keyword">import</span> timedelta
<span class="token keyword">import</span> pickle

<span class="token keyword">class</span> <span class="token class-name">RedisCache</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> redis_url<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">"redis://localhost:6379"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>redis <span class="token operator">=</span> redis<span class="token punctuation">.</span>from_url<span class="token punctuation">(</span>redis_url<span class="token punctuation">,</span> decode_responses<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    
    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Optional<span class="token punctuation">[</span>Any<span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""获取缓存值"""</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            value <span class="token operator">=</span> <span class="token keyword">await</span> self<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>get<span class="token punctuation">(</span>key<span class="token punctuation">)</span>
            <span class="token keyword">if</span> value<span class="token punctuation">:</span>
                <span class="token keyword">return</span> pickle<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>value<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">None</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"缓存获取失败: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>e<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">None</span>
    
    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">set</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> Any<span class="token punctuation">,</span> expire<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">3600</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""设置缓存值"""</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            serialized_value <span class="token operator">=</span> pickle<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>value<span class="token punctuation">)</span>
            <span class="token keyword">await</span> self<span class="token punctuation">.</span>redis<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> serialized_value<span class="token punctuation">,</span> ex<span class="token operator">=</span>expire<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">True</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"缓存设置失败: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>e<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">False</span>
    
    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">delete</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""删除缓存"""</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token keyword">await</span> self<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>delete<span class="token punctuation">(</span>key<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">True</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"缓存删除失败: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>e<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">False</span>
    
    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">exists</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""检查键是否存在"""</span>
        <span class="token keyword">return</span> <span class="token keyword">await</span> self<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>key<span class="token punctuation">)</span>
    
    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">expire</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> seconds<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""设置过期时间"""</span>
        <span class="token keyword">return</span> <span class="token keyword">await</span> self<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>expire<span class="token punctuation">(</span>key<span class="token punctuation">,</span> seconds<span class="token punctuation">)</span>
    
    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">clear_pattern</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> pattern<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">int</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""清除匹配模式的键"""</span>
        keys <span class="token operator">=</span> <span class="token keyword">await</span> self<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>keys<span class="token punctuation">(</span>pattern<span class="token punctuation">)</span>
        <span class="token keyword">if</span> keys<span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token keyword">await</span> self<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>delete<span class="token punctuation">(</span><span class="token operator">*</span>keys<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">0</span>

<span class="token comment"># 全局缓存实例</span>
cache <span class="token operator">=</span> RedisCache<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 缓存装饰器</span>
<span class="token keyword">from</span> functools <span class="token keyword">import</span> wraps
<span class="token keyword">import</span> hashlib

<span class="token keyword">def</span> <span class="token function">cache_result</span><span class="token punctuation">(</span>expire<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">3600</span><span class="token punctuation">,</span> key_prefix<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""缓存函数结果的装饰器"""</span>
    <span class="token keyword">def</span> <span class="token function">decorator</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token decorator annotation punctuation">@wraps</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span>
        <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">wrapper</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># 生成缓存键</span>
            cache_key <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>key_prefix<span class="token punctuation">&#125;</span></span><span class="token string">:</span><span class="token interpolation"><span class="token punctuation">&#123;</span>func<span class="token punctuation">.</span>__name__<span class="token punctuation">&#125;</span></span><span class="token string">:"</span></span>
            key_data <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">sorted</span><span class="token punctuation">(</span>kwargs<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            cache_key <span class="token operator">+=</span> hashlib<span class="token punctuation">.</span>md5<span class="token punctuation">(</span>key_data<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span>
            
            <span class="token comment"># 尝试从缓存获取</span>
            cached_result <span class="token operator">=</span> <span class="token keyword">await</span> cache<span class="token punctuation">.</span>get<span class="token punctuation">(</span>cache_key<span class="token punctuation">)</span>
            <span class="token keyword">if</span> cached_result <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                <span class="token keyword">return</span> cached_result
            
            <span class="token comment"># 执行函数并缓存结果</span>
            result <span class="token operator">=</span> <span class="token keyword">await</span> func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
            <span class="token keyword">await</span> cache<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>cache_key<span class="token punctuation">,</span> result<span class="token punctuation">,</span> expire<span class="token punctuation">)</span>
            <span class="token keyword">return</span> result
        
        <span class="token keyword">return</span> wrapper
    <span class="token keyword">return</span> decorator<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h3 id="2-缓存使用示例"><a href="#2-缓存使用示例" class="headerlink" title="2. 缓存使用示例"></a>2. 缓存使用示例</h3><figure><div class="code-wrapper"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 在路由中使用缓存</span>
<span class="token keyword">from</span> cache <span class="token keyword">import</span> cache<span class="token punctuation">,</span> cache_result

<span class="token decorator annotation punctuation">@router<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/items/"</span><span class="token punctuation">,</span> response_model<span class="token operator">=</span>List<span class="token punctuation">[</span>schemas<span class="token punctuation">.</span>Item<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token decorator annotation punctuation">@cache_result</span><span class="token punctuation">(</span>expire<span class="token operator">=</span><span class="token number">300</span><span class="token punctuation">,</span> key_prefix<span class="token operator">=</span><span class="token string">"items"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get_cached_items</span><span class="token punctuation">(</span>
    skip<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> 
    limit<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">,</span> 
    db<span class="token punctuation">:</span> Session <span class="token operator">=</span> Depends<span class="token punctuation">(</span>get_db<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> crud<span class="token punctuation">.</span>ItemCRUD<span class="token punctuation">.</span>get_items<span class="token punctuation">(</span>db<span class="token punctuation">,</span> skip<span class="token operator">=</span>skip<span class="token punctuation">,</span> limit<span class="token operator">=</span>limit<span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@router<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/users/&#123;user_id&#125;"</span><span class="token punctuation">,</span> response_model<span class="token operator">=</span>schemas<span class="token punctuation">.</span>User<span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get_user_with_cache</span><span class="token punctuation">(</span>
    user_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> 
    db<span class="token punctuation">:</span> Session <span class="token operator">=</span> Depends<span class="token punctuation">(</span>get_db<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 手动缓存控制</span>
    cache_key <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"user:</span><span class="token interpolation"><span class="token punctuation">&#123;</span>user_id<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span>
    
    <span class="token comment"># 尝试从缓存获取</span>
    cached_user <span class="token operator">=</span> <span class="token keyword">await</span> cache<span class="token punctuation">.</span>get<span class="token punctuation">(</span>cache_key<span class="token punctuation">)</span>
    <span class="token keyword">if</span> cached_user<span class="token punctuation">:</span>
        <span class="token keyword">return</span> cached_user
    
    <span class="token comment"># 从数据库获取</span>
    db_user <span class="token operator">=</span> crud<span class="token punctuation">.</span>UserCRUD<span class="token punctuation">.</span>get_user<span class="token punctuation">(</span>db<span class="token punctuation">,</span> user_id<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> db_user<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> HTTPException<span class="token punctuation">(</span>status_code<span class="token operator">=</span><span class="token number">404</span><span class="token punctuation">,</span> detail<span class="token operator">=</span><span class="token string">"用户不存在"</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 缓存用户数据</span>
    user_data <span class="token operator">=</span> schemas<span class="token punctuation">.</span>User<span class="token punctuation">.</span>from_orm<span class="token punctuation">(</span>db_user<span class="token punctuation">)</span>
    <span class="token keyword">await</span> cache<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>cache_key<span class="token punctuation">,</span> user_data<span class="token punctuation">.</span><span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> expire<span class="token operator">=</span><span class="token number">1800</span><span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> user_data

<span class="token comment"># 缓存失效</span>
<span class="token decorator annotation punctuation">@router<span class="token punctuation">.</span>put</span><span class="token punctuation">(</span><span class="token string">"/users/&#123;user_id&#125;"</span><span class="token punctuation">,</span> response_model<span class="token operator">=</span>schemas<span class="token punctuation">.</span>User<span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">update_user_with_cache_invalidation</span><span class="token punctuation">(</span>
    user_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
    user_update<span class="token punctuation">:</span> schemas<span class="token punctuation">.</span>UserUpdate<span class="token punctuation">,</span>
    db<span class="token punctuation">:</span> Session <span class="token operator">=</span> Depends<span class="token punctuation">(</span>get_db<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 更新用户</span>
    updated_user <span class="token operator">=</span> crud<span class="token punctuation">.</span>UserCRUD<span class="token punctuation">.</span>update_user<span class="token punctuation">(</span>db<span class="token punctuation">,</span> user_id<span class="token punctuation">,</span> user_update<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> updated_user<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> HTTPException<span class="token punctuation">(</span>status_code<span class="token operator">=</span><span class="token number">404</span><span class="token punctuation">,</span> detail<span class="token operator">=</span><span class="token string">"用户不存在"</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 清除相关缓存</span>
    <span class="token keyword">await</span> cache<span class="token punctuation">.</span>delete<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"user:</span><span class="token interpolation"><span class="token punctuation">&#123;</span>user_id<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> cache<span class="token punctuation">.</span>clear_pattern<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"users:*"</span></span><span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> updated_user<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h2 id="（二）数据库优化"><a href="#（二）数据库优化" class="headerlink" title="（二）数据库优化"></a>（二）数据库优化</h2><h3 id="1-连接池配置"><a href="#1-连接池配置" class="headerlink" title="1. 连接池配置"></a>1. 连接池配置</h3><figure><div class="code-wrapper"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># database.py (优化版)</span>
<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> create_engine<span class="token punctuation">,</span> event
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>pool <span class="token keyword">import</span> QueuePool
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>ext<span class="token punctuation">.</span>asyncio <span class="token keyword">import</span> create_async_engine

<span class="token comment"># 同步引擎配置</span>
engine <span class="token operator">=</span> create_engine<span class="token punctuation">(</span>
    SQLALCHEMY_DATABASE_URL<span class="token punctuation">,</span>
    poolclass<span class="token operator">=</span>QueuePool<span class="token punctuation">,</span>
    pool_size<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span>          <span class="token comment"># 连接池大小</span>
    max_overflow<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">,</span>       <span class="token comment"># 最大溢出连接数</span>
    pool_pre_ping<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>    <span class="token comment"># 连接前检查</span>
    pool_recycle<span class="token operator">=</span><span class="token number">3600</span><span class="token punctuation">,</span>     <span class="token comment"># 连接回收时间</span>
    echo<span class="token operator">=</span><span class="token boolean">False</span>             <span class="token comment"># 生产环境关闭SQL日志</span>
<span class="token punctuation">)</span>

<span class="token comment"># 异步引擎配置</span>
async_engine <span class="token operator">=</span> create_async_engine<span class="token punctuation">(</span>
    ASYNC_SQLALCHEMY_DATABASE_URL<span class="token punctuation">,</span>
    pool_size<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span>
    max_overflow<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">,</span>
    pool_pre_ping<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    pool_recycle<span class="token operator">=</span><span class="token number">3600</span>
<span class="token punctuation">)</span>

<span class="token comment"># 数据库事件监听</span>
<span class="token decorator annotation punctuation">@event<span class="token punctuation">.</span>listens_for</span><span class="token punctuation">(</span>engine<span class="token punctuation">,</span> <span class="token string">"connect"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">set_sqlite_pragma</span><span class="token punctuation">(</span>dbapi_connection<span class="token punctuation">,</span> connection_record<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token string">'sqlite'</span> <span class="token keyword">in</span> SQLALCHEMY_DATABASE_URL<span class="token punctuation">:</span>
        cursor <span class="token operator">=</span> dbapi_connection<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span><span class="token punctuation">)</span>
        cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">"PRAGMA foreign_keys=ON"</span><span class="token punctuation">)</span>
        cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">"PRAGMA journal_mode=WAL"</span><span class="token punctuation">)</span>
        cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">"PRAGMA synchronous=NORMAL"</span><span class="token punctuation">)</span>
        cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">"PRAGMA cache_size=10000"</span><span class="token punctuation">)</span>
        cursor<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h3 id="2-查询优化"><a href="#2-查询优化" class="headerlink" title="2. 查询优化"></a>2. 查询优化</h3><figure><div class="code-wrapper"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># crud.py (优化版)</span>
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> selectinload<span class="token punctuation">,</span> joinedload
<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> func<span class="token punctuation">,</span> and_<span class="token punctuation">,</span> or_

<span class="token keyword">class</span> <span class="token class-name">OptimizedUserCRUD</span><span class="token punctuation">:</span>
    <span class="token decorator annotation punctuation">@staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">get_user_with_items</span><span class="token punctuation">(</span>db<span class="token punctuation">:</span> Session<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""使用预加载获取用户及其商品"""</span>
        <span class="token keyword">return</span> db<span class="token punctuation">.</span>query<span class="token punctuation">(</span>models<span class="token punctuation">.</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span>options<span class="token punctuation">(</span>
            selectinload<span class="token punctuation">(</span>models<span class="token punctuation">.</span>User<span class="token punctuation">.</span>items<span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token builtin">id</span> <span class="token operator">==</span> user_id<span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token decorator annotation punctuation">@staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">get_users_with_pagination</span><span class="token punctuation">(</span>db<span class="token punctuation">:</span> Session<span class="token punctuation">,</span> page<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> per_page<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""分页查询用户"""</span>
        offset <span class="token operator">=</span> <span class="token punctuation">(</span>page <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> per_page
        
        users <span class="token operator">=</span> db<span class="token punctuation">.</span>query<span class="token punctuation">(</span>models<span class="token punctuation">.</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span>offset<span class="token punctuation">(</span>offset<span class="token punctuation">)</span><span class="token punctuation">.</span>limit<span class="token punctuation">(</span>per_page<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        total <span class="token operator">=</span> db<span class="token punctuation">.</span>query<span class="token punctuation">(</span>func<span class="token punctuation">.</span>count<span class="token punctuation">(</span>models<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>scalar<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"users"</span><span class="token punctuation">:</span> users<span class="token punctuation">,</span>
            <span class="token string">"total"</span><span class="token punctuation">:</span> total<span class="token punctuation">,</span>
            <span class="token string">"page"</span><span class="token punctuation">:</span> page<span class="token punctuation">,</span>
            <span class="token string">"per_page"</span><span class="token punctuation">:</span> per_page<span class="token punctuation">,</span>
            <span class="token string">"pages"</span><span class="token punctuation">:</span> <span class="token punctuation">(</span>total <span class="token operator">+</span> per_page <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">//</span> per_page
        <span class="token punctuation">&#125;</span>
    
    <span class="token decorator annotation punctuation">@staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">search_users</span><span class="token punctuation">(</span>db<span class="token punctuation">:</span> Session<span class="token punctuation">,</span> search_term<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> skip<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> limit<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""搜索用户"""</span>
        <span class="token keyword">return</span> db<span class="token punctuation">.</span>query<span class="token punctuation">(</span>models<span class="token punctuation">.</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>
            or_<span class="token punctuation">(</span>
                models<span class="token punctuation">.</span>User<span class="token punctuation">.</span>username<span class="token punctuation">.</span>ilike<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"%</span><span class="token interpolation"><span class="token punctuation">&#123;</span>search_term<span class="token punctuation">&#125;</span></span><span class="token string">%"</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                models<span class="token punctuation">.</span>User<span class="token punctuation">.</span>email<span class="token punctuation">.</span>ilike<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"%</span><span class="token interpolation"><span class="token punctuation">&#123;</span>search_term<span class="token punctuation">&#125;</span></span><span class="token string">%"</span></span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">.</span>offset<span class="token punctuation">(</span>skip<span class="token punctuation">)</span><span class="token punctuation">.</span>limit<span class="token punctuation">(</span>limit<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token decorator annotation punctuation">@staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">get_active_users_count</span><span class="token punctuation">(</span>db<span class="token punctuation">:</span> Session<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""获取活跃用户数量"""</span>
        <span class="token keyword">return</span> db<span class="token punctuation">.</span>query<span class="token punctuation">(</span>func<span class="token punctuation">.</span>count<span class="token punctuation">(</span>models<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>
            models<span class="token punctuation">.</span>User<span class="token punctuation">.</span>is_active <span class="token operator">==</span> <span class="token boolean">True</span>
        <span class="token punctuation">)</span><span class="token punctuation">.</span>scalar<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 批量操作</span>
<span class="token keyword">class</span> <span class="token class-name">BatchOperations</span><span class="token punctuation">:</span>
    <span class="token decorator annotation punctuation">@staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">bulk_create_items</span><span class="token punctuation">(</span>db<span class="token punctuation">:</span> Session<span class="token punctuation">,</span> items_data<span class="token punctuation">:</span> List<span class="token punctuation">[</span><span class="token builtin">dict</span><span class="token punctuation">]</span><span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""批量创建商品"""</span>
        items <span class="token operator">=</span> <span class="token punctuation">[</span>models<span class="token punctuation">.</span>Item<span class="token punctuation">(</span><span class="token operator">**</span>item_data<span class="token punctuation">,</span> owner_id<span class="token operator">=</span>user_id<span class="token punctuation">)</span> <span class="token keyword">for</span> item_data <span class="token keyword">in</span> items_data<span class="token punctuation">]</span>
        db<span class="token punctuation">.</span>bulk_save_objects<span class="token punctuation">(</span>items<span class="token punctuation">)</span>
        db<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token builtin">len</span><span class="token punctuation">(</span>items<span class="token punctuation">)</span>
    
    <span class="token decorator annotation punctuation">@staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">bulk_update_items</span><span class="token punctuation">(</span>db<span class="token punctuation">:</span> Session<span class="token punctuation">,</span> updates<span class="token punctuation">:</span> List<span class="token punctuation">[</span><span class="token builtin">dict</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""批量更新商品"""</span>
        db<span class="token punctuation">.</span>bulk_update_mappings<span class="token punctuation">(</span>models<span class="token punctuation">.</span>Item<span class="token punctuation">,</span> updates<span class="token punctuation">)</span>
        db<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h1 id="七、测试"><a href="#七、测试" class="headerlink" title="七、测试"></a>七、测试</h1><h2 id="（一）单元测试"><a href="#（一）单元测试" class="headerlink" title="（一）单元测试"></a>（一）单元测试</h2><h3 id="1-测试配置"><a href="#1-测试配置" class="headerlink" title="1. 测试配置"></a>1. 测试配置</h3><figure><div class="code-wrapper"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># tests/conftest.py</span>
<span class="token keyword">import</span> pytest
<span class="token keyword">from</span> fastapi<span class="token punctuation">.</span>testclient <span class="token keyword">import</span> TestClient
<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> create_engine
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> sessionmaker
<span class="token keyword">from</span> main <span class="token keyword">import</span> app
<span class="token keyword">from</span> database <span class="token keyword">import</span> get_db<span class="token punctuation">,</span> Base
<span class="token keyword">import</span> models

<span class="token comment"># 测试数据库</span>
SQLALCHEMY_DATABASE_URL <span class="token operator">=</span> <span class="token string">"sqlite:///./test.db"</span>
engine <span class="token operator">=</span> create_engine<span class="token punctuation">(</span>
    SQLALCHEMY_DATABASE_URL<span class="token punctuation">,</span> 
    connect_args<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">"check_same_thread"</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">)</span>
TestingSessionLocal <span class="token operator">=</span> sessionmaker<span class="token punctuation">(</span>autocommit<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> autoflush<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> bind<span class="token operator">=</span>engine<span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@pytest<span class="token punctuation">.</span>fixture</span><span class="token punctuation">(</span>scope<span class="token operator">=</span><span class="token string">"session"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">db_engine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    Base<span class="token punctuation">.</span>metadata<span class="token punctuation">.</span>create_all<span class="token punctuation">(</span>bind<span class="token operator">=</span>engine<span class="token punctuation">)</span>
    <span class="token keyword">yield</span> engine
    Base<span class="token punctuation">.</span>metadata<span class="token punctuation">.</span>drop_all<span class="token punctuation">(</span>bind<span class="token operator">=</span>engine<span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@pytest<span class="token punctuation">.</span>fixture</span><span class="token punctuation">(</span>scope<span class="token operator">=</span><span class="token string">"function"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">db_session</span><span class="token punctuation">(</span>db_engine<span class="token punctuation">)</span><span class="token punctuation">:</span>
    connection <span class="token operator">=</span> db_engine<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">)</span>
    transaction <span class="token operator">=</span> connection<span class="token punctuation">.</span>begin<span class="token punctuation">(</span><span class="token punctuation">)</span>
    session <span class="token operator">=</span> TestingSessionLocal<span class="token punctuation">(</span>bind<span class="token operator">=</span>connection<span class="token punctuation">)</span>
    <span class="token keyword">yield</span> session
    session<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    transaction<span class="token punctuation">.</span>rollback<span class="token punctuation">(</span><span class="token punctuation">)</span>
    connection<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@pytest<span class="token punctuation">.</span>fixture</span><span class="token punctuation">(</span>scope<span class="token operator">=</span><span class="token string">"function"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">client</span><span class="token punctuation">(</span>db_session<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">override_get_db</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">yield</span> db_session
    
    app<span class="token punctuation">.</span>dependency_overrides<span class="token punctuation">[</span>get_db<span class="token punctuation">]</span> <span class="token operator">=</span> override_get_db
    <span class="token keyword">with</span> TestClient<span class="token punctuation">(</span>app<span class="token punctuation">)</span> <span class="token keyword">as</span> test_client<span class="token punctuation">:</span>
        <span class="token keyword">yield</span> test_client
    app<span class="token punctuation">.</span>dependency_overrides<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@pytest<span class="token punctuation">.</span>fixture</span>
<span class="token keyword">def</span> <span class="token function">test_user</span><span class="token punctuation">(</span>db_session<span class="token punctuation">)</span><span class="token punctuation">:</span>
    user_data <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"username"</span><span class="token punctuation">:</span> <span class="token string">"testuser"</span><span class="token punctuation">,</span>
        <span class="token string">"email"</span><span class="token punctuation">:</span> <span class="token string">"test@example.com"</span><span class="token punctuation">,</span>
        <span class="token string">"hashed_password"</span><span class="token punctuation">:</span> <span class="token string">"hashedpassword"</span><span class="token punctuation">,</span>
        <span class="token string">"is_active"</span><span class="token punctuation">:</span> <span class="token boolean">True</span>
    <span class="token punctuation">&#125;</span>
    user <span class="token operator">=</span> models<span class="token punctuation">.</span>User<span class="token punctuation">(</span><span class="token operator">**</span>user_data<span class="token punctuation">)</span>
    db_session<span class="token punctuation">.</span>add<span class="token punctuation">(</span>user<span class="token punctuation">)</span>
    db_session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
    db_session<span class="token punctuation">.</span>refresh<span class="token punctuation">(</span>user<span class="token punctuation">)</span>
    <span class="token keyword">return</span> user<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h3 id="2-API测试"><a href="#2-API测试" class="headerlink" title="2. API测试"></a>2. API测试</h3><figure><div class="code-wrapper"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># tests/test_api.py</span>
<span class="token keyword">import</span> pytest
<span class="token keyword">from</span> fastapi<span class="token punctuation">.</span>testclient <span class="token keyword">import</span> TestClient

<span class="token keyword">def</span> <span class="token function">test_read_root</span><span class="token punctuation">(</span>client<span class="token punctuation">:</span> TestClient<span class="token punctuation">)</span><span class="token punctuation">:</span>
    response <span class="token operator">=</span> client<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span>
    <span class="token keyword">assert</span> response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">200</span>
    <span class="token keyword">assert</span> <span class="token string">"message"</span> <span class="token keyword">in</span> response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">test_create_user</span><span class="token punctuation">(</span>client<span class="token punctuation">:</span> TestClient<span class="token punctuation">)</span><span class="token punctuation">:</span>
    user_data <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"username"</span><span class="token punctuation">:</span> <span class="token string">"newuser"</span><span class="token punctuation">,</span>
        <span class="token string">"email"</span><span class="token punctuation">:</span> <span class="token string">"newuser@example.com"</span><span class="token punctuation">,</span>
        <span class="token string">"password"</span><span class="token punctuation">:</span> <span class="token string">"password123"</span><span class="token punctuation">,</span>
        <span class="token string">"is_active"</span><span class="token punctuation">:</span> <span class="token boolean">True</span>
    <span class="token punctuation">&#125;</span>
    response <span class="token operator">=</span> client<span class="token punctuation">.</span>post<span class="token punctuation">(</span><span class="token string">"/auth/register"</span><span class="token punctuation">,</span> json<span class="token operator">=</span>user_data<span class="token punctuation">)</span>
    <span class="token keyword">assert</span> response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">200</span>
    data <span class="token operator">=</span> response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">assert</span> data<span class="token punctuation">[</span><span class="token string">"username"</span><span class="token punctuation">]</span> <span class="token operator">==</span> user_data<span class="token punctuation">[</span><span class="token string">"username"</span><span class="token punctuation">]</span>
    <span class="token keyword">assert</span> data<span class="token punctuation">[</span><span class="token string">"email"</span><span class="token punctuation">]</span> <span class="token operator">==</span> user_data<span class="token punctuation">[</span><span class="token string">"email"</span><span class="token punctuation">]</span>
    <span class="token keyword">assert</span> <span class="token string">"id"</span> <span class="token keyword">in</span> data

<span class="token keyword">def</span> <span class="token function">test_login</span><span class="token punctuation">(</span>client<span class="token punctuation">:</span> TestClient<span class="token punctuation">,</span> test_user<span class="token punctuation">)</span><span class="token punctuation">:</span>
    login_data <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"username"</span><span class="token punctuation">:</span> <span class="token string">"testuser"</span><span class="token punctuation">,</span>
        <span class="token string">"password"</span><span class="token punctuation">:</span> <span class="token string">"password123"</span>
    <span class="token punctuation">&#125;</span>
    response <span class="token operator">=</span> client<span class="token punctuation">.</span>post<span class="token punctuation">(</span><span class="token string">"/auth/token"</span><span class="token punctuation">,</span> data<span class="token operator">=</span>login_data<span class="token punctuation">)</span>
    <span class="token keyword">assert</span> response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">200</span>
    data <span class="token operator">=</span> response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">assert</span> <span class="token string">"access_token"</span> <span class="token keyword">in</span> data
    <span class="token keyword">assert</span> data<span class="token punctuation">[</span><span class="token string">"token_type"</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"bearer"</span>

<span class="token keyword">def</span> <span class="token function">test_protected_route</span><span class="token punctuation">(</span>client<span class="token punctuation">:</span> TestClient<span class="token punctuation">,</span> test_user<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 先登录获取token</span>
    login_data <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"username"</span><span class="token punctuation">:</span> <span class="token string">"testuser"</span><span class="token punctuation">,</span>
        <span class="token string">"password"</span><span class="token punctuation">:</span> <span class="token string">"password123"</span>
    <span class="token punctuation">&#125;</span>
    login_response <span class="token operator">=</span> client<span class="token punctuation">.</span>post<span class="token punctuation">(</span><span class="token string">"/auth/token"</span><span class="token punctuation">,</span> data<span class="token operator">=</span>login_data<span class="token punctuation">)</span>
    token <span class="token operator">=</span> login_response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">"access_token"</span><span class="token punctuation">]</span>
    
    <span class="token comment"># 使用token访问受保护的路由</span>
    headers <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"Authorization"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"Bearer </span><span class="token interpolation"><span class="token punctuation">&#123;</span>token<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">&#125;</span>
    response <span class="token operator">=</span> client<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"/auth/me"</span><span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">)</span>
    <span class="token keyword">assert</span> response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">200</span>
    data <span class="token operator">=</span> response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">assert</span> data<span class="token punctuation">[</span><span class="token string">"username"</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"testuser"</span>

<span class="token keyword">def</span> <span class="token function">test_create_item</span><span class="token punctuation">(</span>client<span class="token punctuation">:</span> TestClient<span class="token punctuation">,</span> test_user<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 登录获取token</span>
    login_data <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"username"</span><span class="token punctuation">:</span> <span class="token string">"testuser"</span><span class="token punctuation">,</span>
        <span class="token string">"password"</span><span class="token punctuation">:</span> <span class="token string">"password123"</span>
    <span class="token punctuation">&#125;</span>
    login_response <span class="token operator">=</span> client<span class="token punctuation">.</span>post<span class="token punctuation">(</span><span class="token string">"/auth/token"</span><span class="token punctuation">,</span> data<span class="token operator">=</span>login_data<span class="token punctuation">)</span>
    token <span class="token operator">=</span> login_response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">"access_token"</span><span class="token punctuation">]</span>
    headers <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"Authorization"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"Bearer </span><span class="token interpolation"><span class="token punctuation">&#123;</span>token<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">&#125;</span>
    
    <span class="token comment"># 创建商品</span>
    item_data <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"title"</span><span class="token punctuation">:</span> <span class="token string">"测试商品"</span><span class="token punctuation">,</span>
        <span class="token string">"description"</span><span class="token punctuation">:</span> <span class="token string">"这是一个测试商品"</span><span class="token punctuation">,</span>
        <span class="token string">"price"</span><span class="token punctuation">:</span> <span class="token number">99.99</span><span class="token punctuation">,</span>
        <span class="token string">"is_available"</span><span class="token punctuation">:</span> <span class="token boolean">True</span>
    <span class="token punctuation">&#125;</span>
    response <span class="token operator">=</span> client<span class="token punctuation">.</span>post<span class="token punctuation">(</span><span class="token string">"/items/"</span><span class="token punctuation">,</span> json<span class="token operator">=</span>item_data<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">)</span>
    <span class="token keyword">assert</span> response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">201</span>
    data <span class="token operator">=</span> response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">assert</span> data<span class="token punctuation">[</span><span class="token string">"title"</span><span class="token punctuation">]</span> <span class="token operator">==</span> item_data<span class="token punctuation">[</span><span class="token string">"title"</span><span class="token punctuation">]</span>
    <span class="token keyword">assert</span> data<span class="token punctuation">[</span><span class="token string">"price"</span><span class="token punctuation">]</span> <span class="token operator">==</span> item_data<span class="token punctuation">[</span><span class="token string">"price"</span><span class="token punctuation">]</span>

<span class="token keyword">def</span> <span class="token function">test_validation_error</span><span class="token punctuation">(</span>client<span class="token punctuation">:</span> TestClient<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 测试数据验证错误</span>
    invalid_user_data <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"username"</span><span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">,</span>  <span class="token comment"># 空用户名</span>
        <span class="token string">"email"</span><span class="token punctuation">:</span> <span class="token string">"invalid-email"</span><span class="token punctuation">,</span>  <span class="token comment"># 无效邮箱</span>
        <span class="token string">"password"</span><span class="token punctuation">:</span> <span class="token string">"123"</span>  <span class="token comment"># 密码太短</span>
    <span class="token punctuation">&#125;</span>
    response <span class="token operator">=</span> client<span class="token punctuation">.</span>post<span class="token punctuation">(</span><span class="token string">"/auth/register"</span><span class="token punctuation">,</span> json<span class="token operator">=</span>invalid_user_data<span class="token punctuation">)</span>
    <span class="token keyword">assert</span> response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">422</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h2 id="（二）异步测试"><a href="#（二）异步测试" class="headerlink" title="（二）异步测试"></a>（二）异步测试</h2><h3 id="1-异步测试配置"><a href="#1-异步测试配置" class="headerlink" title="1. 异步测试配置"></a>1. 异步测试配置</h3><figure><div class="code-wrapper"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># tests/test_async.py</span>
<span class="token keyword">import</span> pytest
<span class="token keyword">import</span> asyncio
<span class="token keyword">from</span> httpx <span class="token keyword">import</span> AsyncClient
<span class="token keyword">from</span> main <span class="token keyword">import</span> app

<span class="token decorator annotation punctuation">@pytest<span class="token punctuation">.</span>mark<span class="token punctuation">.</span>asyncio</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">test_async_endpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">async</span> <span class="token keyword">with</span> AsyncClient<span class="token punctuation">(</span>app<span class="token operator">=</span>app<span class="token punctuation">,</span> base_url<span class="token operator">=</span><span class="token string">"http://test"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> ac<span class="token punctuation">:</span>
        response <span class="token operator">=</span> <span class="token keyword">await</span> ac<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span>
    <span class="token keyword">assert</span> response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">200</span>

<span class="token decorator annotation punctuation">@pytest<span class="token punctuation">.</span>mark<span class="token punctuation">.</span>asyncio</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">test_websocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">from</span> fastapi<span class="token punctuation">.</span>testclient <span class="token keyword">import</span> TestClient
    
    client <span class="token operator">=</span> TestClient<span class="token punctuation">(</span>app<span class="token punctuation">)</span>
    <span class="token keyword">with</span> client<span class="token punctuation">.</span>websocket_connect<span class="token punctuation">(</span><span class="token string">"/ws/test_client"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> websocket<span class="token punctuation">:</span>
        <span class="token comment"># 发送消息</span>
        test_message <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"chat"</span><span class="token punctuation">,</span>
            <span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"Hello WebSocket!"</span>
        <span class="token punctuation">&#125;</span>
        websocket<span class="token punctuation">.</span>send_json<span class="token punctuation">(</span>test_message<span class="token punctuation">)</span>
        
        <span class="token comment"># 接收响应</span>
        data <span class="token operator">=</span> websocket<span class="token punctuation">.</span>receive_json<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">assert</span> data<span class="token punctuation">[</span><span class="token string">"type"</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"chat"</span>
        <span class="token keyword">assert</span> data<span class="token punctuation">[</span><span class="token string">"user_id"</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"test_client"</span>
        <span class="token keyword">assert</span> data<span class="token punctuation">[</span><span class="token string">"message"</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"Hello WebSocket!"</span>

<span class="token decorator annotation punctuation">@pytest<span class="token punctuation">.</span>mark<span class="token punctuation">.</span>asyncio</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">test_background_task</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">async</span> <span class="token keyword">with</span> AsyncClient<span class="token punctuation">(</span>app<span class="token operator">=</span>app<span class="token punctuation">,</span> base_url<span class="token operator">=</span><span class="token string">"http://test"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> ac<span class="token punctuation">:</span>
        response <span class="token operator">=</span> <span class="token keyword">await</span> ac<span class="token punctuation">.</span>post<span class="token punctuation">(</span><span class="token string">"/send-notification/"</span><span class="token punctuation">,</span> params<span class="token operator">=</span><span class="token punctuation">&#123;</span>
            <span class="token string">"email"</span><span class="token punctuation">:</span> <span class="token string">"test@example.com"</span><span class="token punctuation">,</span>
            <span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"Test notification"</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token keyword">assert</span> response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">200</span>
    <span class="token keyword">assert</span> <span class="token string">"邮件将在后台发送"</span> <span class="token keyword">in</span> response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">"message"</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h1 id="八、部署与配置"><a href="#八、部署与配置" class="headerlink" title="八、部署与配置"></a>八、部署与配置</h1><h2 id="（一）Docker部署"><a href="#（一）Docker部署" class="headerlink" title="（一）Docker部署"></a>（一）Docker部署</h2><h3 id="1-Dockerfile"><a href="#1-Dockerfile" class="headerlink" title="1. Dockerfile"></a>1. Dockerfile</h3><figure><div class="code-wrapper"><pre class="line-numbers language-docker" data-language="docker"><code class="language-docker"><span class="token comment"># Dockerfile</span>
<span class="token instruction"><span class="token keyword">FROM</span> python:3.11-slim</span>

<span class="token comment"># 设置工作目录</span>
<span class="token instruction"><span class="token keyword">WORKDIR</span> /app</span>

<span class="token comment"># 安装系统依赖</span>
<span class="token instruction"><span class="token keyword">RUN</span> apt-get update &amp;&amp; apt-get install -y <span class="token operator">\</span>
    gcc <span class="token operator">\</span>
    &amp;&amp; rm -rf /var/lib/apt/lists/*</span>

<span class="token comment"># 复制依赖文件</span>
<span class="token instruction"><span class="token keyword">COPY</span> requirements.txt .</span>

<span class="token comment"># 安装Python依赖</span>
<span class="token instruction"><span class="token keyword">RUN</span> pip install --no-cache-dir -r requirements.txt</span>

<span class="token comment"># 复制应用代码</span>
<span class="token instruction"><span class="token keyword">COPY</span> . .</span>

<span class="token comment"># 创建非root用户</span>
<span class="token instruction"><span class="token keyword">RUN</span> useradd --create-home --shell /bin/bash app <span class="token operator">\</span>
    &amp;&amp; chown -R app:app /app</span>
<span class="token instruction"><span class="token keyword">USER</span> app</span>

<span class="token comment"># 暴露端口</span>
<span class="token instruction"><span class="token keyword">EXPOSE</span> 8000</span>

<span class="token comment"># 启动命令</span>
<span class="token instruction"><span class="token keyword">CMD</span> [<span class="token string">"uvicorn"</span>, <span class="token string">"main:app"</span>, <span class="token string">"--host"</span>, <span class="token string">"0.0.0.0"</span>, <span class="token string">"--port"</span>, <span class="token string">"8000"</span>]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h3 id="2-docker-compose-yml"><a href="#2-docker-compose-yml" class="headerlink" title="2. docker-compose.yml"></a>2. docker-compose.yml</h3><figure><div class="code-wrapper"><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># docker-compose.yml</span>
<span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'3.8'</span>

<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">web</span><span class="token punctuation">:</span>
    <span class="token key atrule">build</span><span class="token punctuation">:</span> .
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"8000:8000"</span>
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> DATABASE_URL=postgresql<span class="token punctuation">:</span>//user<span class="token punctuation">:</span>password@db<span class="token punctuation">:</span>5432/fastapi_db
      <span class="token punctuation">-</span> REDIS_URL=redis<span class="token punctuation">:</span>//redis<span class="token punctuation">:</span><span class="token number">6379</span>
    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> db
      <span class="token punctuation">-</span> redis
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> ./uploads<span class="token punctuation">:</span>/app/uploads
  
  <span class="token key atrule">db</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> postgres<span class="token punctuation">:</span><span class="token number">15</span>
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> POSTGRES_USER=user
      <span class="token punctuation">-</span> POSTGRES_PASSWORD=password
      <span class="token punctuation">-</span> POSTGRES_DB=fastapi_db
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> postgres_data<span class="token punctuation">:</span>/var/lib/postgresql/data
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"5432:5432"</span>
  
  <span class="token key atrule">redis</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> redis<span class="token punctuation">:</span>7<span class="token punctuation">-</span>alpine
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"6379:6379"</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> redis_data<span class="token punctuation">:</span>/data
  
  <span class="token key atrule">nginx</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>alpine
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"80:80"</span>
      <span class="token punctuation">-</span> <span class="token string">"443:443"</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> ./nginx.conf<span class="token punctuation">:</span>/etc/nginx/nginx.conf
      <span class="token punctuation">-</span> ./ssl<span class="token punctuation">:</span>/etc/nginx/ssl
    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> web

<span class="token key atrule">volumes</span><span class="token punctuation">:</span>
  <span class="token key atrule">postgres_data</span><span class="token punctuation">:</span>
  redis_data<span class="token punctuation">:</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h3 id="3-生产环境配置"><a href="#3-生产环境配置" class="headerlink" title="3. 生产环境配置"></a>3. 生产环境配置</h3><figure><div class="code-wrapper"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># config.py</span>
<span class="token keyword">from</span> pydantic <span class="token keyword">import</span> BaseSettings
<span class="token keyword">from</span> typing <span class="token keyword">import</span> Optional

<span class="token keyword">class</span> <span class="token class-name">Settings</span><span class="token punctuation">(</span>BaseSettings<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 应用配置</span>
    app_name<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">"FastAPI应用"</span>
    debug<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">False</span>
    version<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">"1.0.0"</span>
    
    <span class="token comment"># 数据库配置</span>
    database_url<span class="token punctuation">:</span> <span class="token builtin">str</span>
    async_database_url<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
    
    <span class="token comment"># Redis配置</span>
    redis_url<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">"redis://localhost:6379"</span>
    
    <span class="token comment"># JWT配置</span>
    secret_key<span class="token punctuation">:</span> <span class="token builtin">str</span>
    algorithm<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">"HS256"</span>
    access_token_expire_minutes<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">30</span>
    
    <span class="token comment"># 邮件配置</span>
    smtp_server<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
    smtp_port<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">587</span>
    smtp_username<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
    smtp_password<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
    
    <span class="token comment"># 文件上传配置</span>
    upload_dir<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">"uploads"</span>
    max_file_size<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">10</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span>  <span class="token comment"># 10MB</span>
    
    <span class="token comment"># CORS配置</span>
    allowed_origins<span class="token punctuation">:</span> <span class="token builtin">list</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"http://localhost:3000"</span><span class="token punctuation">]</span>
    
    <span class="token keyword">class</span> <span class="token class-name">Config</span><span class="token punctuation">:</span>
        env_file <span class="token operator">=</span> <span class="token string">".env"</span>

settings <span class="token operator">=</span> Settings<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h2 id="（二）性能监控"><a href="#（二）性能监控" class="headerlink" title="（二）性能监控"></a>（二）性能监控</h2><h3 id="1-监控中间件"><a href="#1-监控中间件" class="headerlink" title="1. 监控中间件"></a>1. 监控中间件</h3><figure><div class="code-wrapper"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># monitoring.py</span>
<span class="token keyword">import</span> time
<span class="token keyword">import</span> psutil
<span class="token keyword">from</span> fastapi <span class="token keyword">import</span> Request
<span class="token keyword">from</span> starlette<span class="token punctuation">.</span>middleware<span class="token punctuation">.</span>base <span class="token keyword">import</span> BaseHTTPMiddleware
<span class="token keyword">from</span> prometheus_client <span class="token keyword">import</span> Counter<span class="token punctuation">,</span> Histogram<span class="token punctuation">,</span> Gauge<span class="token punctuation">,</span> generate_latest
<span class="token keyword">import</span> logging

<span class="token comment"># Prometheus指标</span>
REQUEST_COUNT <span class="token operator">=</span> Counter<span class="token punctuation">(</span><span class="token string">'http_requests_total'</span><span class="token punctuation">,</span> <span class="token string">'Total HTTP requests'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'method'</span><span class="token punctuation">,</span> <span class="token string">'endpoint'</span><span class="token punctuation">,</span> <span class="token string">'status'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
REQUEST_DURATION <span class="token operator">=</span> Histogram<span class="token punctuation">(</span><span class="token string">'http_request_duration_seconds'</span><span class="token punctuation">,</span> <span class="token string">'HTTP request duration'</span><span class="token punctuation">)</span>
ACTIVE_CONNECTIONS <span class="token operator">=</span> Gauge<span class="token punctuation">(</span><span class="token string">'active_connections'</span><span class="token punctuation">,</span> <span class="token string">'Active connections'</span><span class="token punctuation">)</span>
MEMORY_USAGE <span class="token operator">=</span> Gauge<span class="token punctuation">(</span><span class="token string">'memory_usage_bytes'</span><span class="token punctuation">,</span> <span class="token string">'Memory usage in bytes'</span><span class="token punctuation">)</span>
CPU_USAGE <span class="token operator">=</span> Gauge<span class="token punctuation">(</span><span class="token string">'cpu_usage_percent'</span><span class="token punctuation">,</span> <span class="token string">'CPU usage percentage'</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">MonitoringMiddleware</span><span class="token punctuation">(</span>BaseHTTPMiddleware<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">dispatch</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">:</span> Request<span class="token punctuation">,</span> call_next<span class="token punctuation">)</span><span class="token punctuation">:</span>
        start_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        <span class="token comment"># 增加活跃连接数</span>
        ACTIVE_CONNECTIONS<span class="token punctuation">.</span>inc<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            response <span class="token operator">=</span> <span class="token keyword">await</span> call_next<span class="token punctuation">(</span>request<span class="token punctuation">)</span>
            
            <span class="token comment"># 记录指标</span>
            duration <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start_time
            REQUEST_DURATION<span class="token punctuation">.</span>observe<span class="token punctuation">(</span>duration<span class="token punctuation">)</span>
            REQUEST_COUNT<span class="token punctuation">.</span>labels<span class="token punctuation">(</span>
                method<span class="token operator">=</span>request<span class="token punctuation">.</span>method<span class="token punctuation">,</span>
                endpoint<span class="token operator">=</span>request<span class="token punctuation">.</span>url<span class="token punctuation">.</span>path<span class="token punctuation">,</span>
                status<span class="token operator">=</span>response<span class="token punctuation">.</span>status_code
            <span class="token punctuation">)</span><span class="token punctuation">.</span>inc<span class="token punctuation">(</span><span class="token punctuation">)</span>
            
            <span class="token keyword">return</span> response
        
        <span class="token keyword">finally</span><span class="token punctuation">:</span>
            <span class="token comment"># 减少活跃连接数</span>
            ACTIVE_CONNECTIONS<span class="token punctuation">.</span>dec<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 系统指标收集</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">collect_system_metrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        <span class="token comment"># 内存使用</span>
        memory <span class="token operator">=</span> psutil<span class="token punctuation">.</span>virtual_memory<span class="token punctuation">(</span><span class="token punctuation">)</span>
        MEMORY_USAGE<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>memory<span class="token punctuation">.</span>used<span class="token punctuation">)</span>
        
        <span class="token comment"># CPU使用</span>
        cpu_percent <span class="token operator">=</span> psutil<span class="token punctuation">.</span>cpu_percent<span class="token punctuation">(</span>interval<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        CPU_USAGE<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>cpu_percent<span class="token punctuation">)</span>
        
        <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>

<span class="token comment"># 指标端点</span>
<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/metrics"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">get_metrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> Response<span class="token punctuation">(</span>generate_latest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> media_type<span class="token operator">=</span><span class="token string">"text/plain"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h1 id="九、最佳实践与总结"><a href="#九、最佳实践与总结" class="headerlink" title="九、最佳实践与总结"></a>九、最佳实践与总结</h1><h2 id="（一）最佳实践"><a href="#（一）最佳实践" class="headerlink" title="（一）最佳实践"></a>（一）最佳实践</h2><h3 id="1-项目结构"><a href="#1-项目结构" class="headerlink" title="1. 项目结构"></a>1. 项目结构</h3><figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">fastapi_project&#x2F;
├── app&#x2F;
│   ├── __init__.py
│   ├── main.py              # 应用入口
│   ├── config.py            # 配置文件
│   ├── database.py          # 数据库配置
│   ├── models&#x2F;              # 数据模型
│   │   ├── __init__.py
│   │   ├── user.py
│   │   └── item.py
│   ├── schemas&#x2F;             # Pydantic模式
│   │   ├── __init__.py
│   │   ├── user.py
│   │   └── item.py
│   ├── crud&#x2F;                # CRUD操作
│   │   ├── __init__.py
│   │   ├── user.py
│   │   └── item.py
│   ├── routers&#x2F;             # 路由模块
│   │   ├── __init__.py
│   │   ├── auth.py
│   │   ├── users.py
│   │   └── items.py
│   ├── middleware&#x2F;          # 中间件
│   │   ├── __init__.py
│   │   └── auth.py
│   ├── utils&#x2F;               # 工具函数
│   │   ├── __init__.py
│   │   ├── security.py
│   │   └── email.py
│   └── tests&#x2F;               # 测试文件
│       ├── __init__.py
│       ├── conftest.py
│       └── test_api.py
├── requirements.txt         # 依赖文件
├── Dockerfile              # Docker配置
├── docker-compose.yml      # Docker Compose配置
├── .env                    # 环境变量
├── .gitignore             # Git忽略文件
└── README.md              # 项目说明<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h3 id="2-代码质量"><a href="#2-代码质量" class="headerlink" title="2. 代码质量"></a>2. 代码质量</h3><figure><div class="code-wrapper"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 使用类型提示</span>
<span class="token keyword">from</span> typing <span class="token keyword">import</span> List<span class="token punctuation">,</span> Optional<span class="token punctuation">,</span> Union

<span class="token keyword">def</span> <span class="token function">get_users</span><span class="token punctuation">(</span>skip<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> limit<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> List<span class="token punctuation">[</span>User<span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token keyword">pass</span>

<span class="token comment"># 使用Pydantic进行数据验证</span>
<span class="token keyword">class</span> <span class="token class-name">UserCreate</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    username<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> min_length<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> max_length<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">)</span>
    email<span class="token punctuation">:</span> EmailStr
    password<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> min_length<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">)</span>

<span class="token comment"># 错误处理</span>
<span class="token keyword">try</span><span class="token punctuation">:</span>
    result <span class="token operator">=</span> <span class="token keyword">await</span> some_async_operation<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">except</span> SpecificException <span class="token keyword">as</span> e<span class="token punctuation">:</span>
    logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"操作失败: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>e<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">raise</span> HTTPException<span class="token punctuation">(</span>status_code<span class="token operator">=</span><span class="token number">500</span><span class="token punctuation">,</span> detail<span class="token operator">=</span><span class="token string">"内部服务器错误"</span><span class="token punctuation">)</span>

<span class="token comment"># 使用依赖注入</span>
<span class="token keyword">def</span> <span class="token function">get_current_user</span><span class="token punctuation">(</span>token<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> Depends<span class="token punctuation">(</span>oauth2_scheme<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 验证逻辑</span>
    <span class="token keyword">pass</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/protected"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">protected_route</span><span class="token punctuation">(</span>current_user<span class="token punctuation">:</span> User <span class="token operator">=</span> Depends<span class="token punctuation">(</span>get_current_user<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">"user"</span><span class="token punctuation">:</span> current_user<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h3 id="3-安全实践"><a href="#3-安全实践" class="headerlink" title="3. 安全实践"></a>3. 安全实践</h3><figure><div class="code-wrapper"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 环境变量管理</span>
<span class="token keyword">import</span> os
<span class="token keyword">from</span> dotenv <span class="token keyword">import</span> load_dotenv

load_dotenv<span class="token punctuation">(</span><span class="token punctuation">)</span>

SECRET_KEY <span class="token operator">=</span> os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">"SECRET_KEY"</span><span class="token punctuation">)</span>
DATABASE_URL <span class="token operator">=</span> os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">"DATABASE_URL"</span><span class="token punctuation">)</span>

<span class="token comment"># 输入验证</span>
<span class="token keyword">from</span> pydantic <span class="token keyword">import</span> validator

<span class="token keyword">class</span> <span class="token class-name">UserInput</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    username<span class="token punctuation">:</span> <span class="token builtin">str</span>
    
    <span class="token decorator annotation punctuation">@validator</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">validate_username</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> v<span class="token punctuation">.</span>isalnum<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">'用户名只能包含字母和数字'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> v

<span class="token comment"># SQL注入防护（使用ORM）</span>
<span class="token comment"># 好的做法</span>
user <span class="token operator">=</span> db<span class="token punctuation">.</span>query<span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>User<span class="token punctuation">.</span><span class="token builtin">id</span> <span class="token operator">==</span> user_id<span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 避免的做法</span>
<span class="token comment"># query = f"SELECT * FROM users WHERE id = &#123;user_id&#125;"  # 危险！</span>

<span class="token comment"># CORS配置</span>
app<span class="token punctuation">.</span>add_middleware<span class="token punctuation">(</span>
    CORSMiddleware<span class="token punctuation">,</span>
    allow_origins<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"https://yourdomain.com"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># 具体域名</span>
    allow_credentials<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    allow_methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"GET"</span><span class="token punctuation">,</span> <span class="token string">"POST"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># 具体方法</span>
    allow_headers<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"*"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h2 id="（二）总结"><a href="#（二）总结" class="headerlink" title="（二）总结"></a>（二）总结</h2><p>FastAPI是一个功能强大、性能优异的现代Python Web框架，具有以下优势：</p>
<h3 id="主要特点"><a href="#主要特点" class="headerlink" title="主要特点"></a>主要特点</h3><ol>
<li><strong>高性能</strong>：基于Starlette和Pydantic，性能接近NodeJS和Go</li>
<li><strong>快速开发</strong>：自动API文档生成，减少开发时间</li>
<li><strong>类型安全</strong>：基于Python类型提示，提供完整的IDE支持</li>
<li><strong>异步支持</strong>：原生支持async&#x2F;await，适合高并发场景</li>
<li><strong>标准化</strong>：遵循OpenAPI和JSON Schema标准</li>
</ol>
<h3 id="适用场景-1"><a href="#适用场景-1" class="headerlink" title="适用场景"></a>适用场景</h3><ul>
<li><strong>API开发</strong>：RESTful API、GraphQL API</li>
<li><strong>微服务</strong>：轻量级、高性能的微服务架构</li>
<li><strong>实时应用</strong>：WebSocket支持，适合聊天、通知等实时功能</li>
<li><strong>数据处理</strong>：异步处理大量数据请求</li>
<li><strong>原型开发</strong>：快速构建MVP和原型</li>
</ul>
<h3 id="学习建议"><a href="#学习建议" class="headerlink" title="学习建议"></a>学习建议</h3><ol>
<li><strong>基础知识</strong>：掌握Python异步编程、HTTP协议、REST API设计</li>
<li><strong>实践项目</strong>：从简单的CRUD应用开始，逐步增加复杂功能</li>
<li><strong>生态系统</strong>：学习SQLAlchemy、Pydantic、Starlette等相关技术</li>
<li><strong>部署运维</strong>：掌握Docker、Nginx、监控等部署技术</li>
<li><strong>最佳实践</strong>：关注代码质量、安全性、性能优化</li>
</ol>
<p>FastAPI为Python Web开发带来了新的可能性，其现代化的设计理念和优秀的性能表现，使其成为构建现代Web应用的理想选择。通过合理的架构设计和最佳实践，可以构建出高质量、可维护的Web应用。</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E5%90%8E%E7%AB%AF/" class="category-chain-item">后端</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Python/" class="print-no-link">#Python</a>
      
        <a href="/tags/%E6%A1%86%E6%9E%B6/" class="print-no-link">#框架</a>
      
        <a href="/tags/%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B/" class="print-no-link">#异步编程</a>
      
        <a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" class="print-no-link">#微服务</a>
      
        <a href="/tags/REST-API/" class="print-no-link">#REST API</a>
      
        <a href="/tags/FastAPI/" class="print-no-link">#FastAPI</a>
      
    </div>
  
</div>


              

              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2025/07/05/%E3%80%90%E5%90%8E%E7%AB%AF%E3%80%91Django%E8%AF%A6%E8%A7%A3%EF%BC%9APython%20Web%E5%BC%80%E5%8F%91%E6%A1%86%E6%9E%B6/" title="【后端】Django详解：Python Web开发框架">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">【后端】Django详解：Python Web开发框架</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2025/07/05/%E3%80%90%E5%90%8E%E7%AB%AF%E3%80%91Spring%20Boot%E8%AF%A6%E8%A7%A3%EF%BC%9A%E4%BC%81%E4%B8%9A%E7%BA%A7Java%E5%BC%80%E5%8F%91%E6%A1%86%E6%9E%B6/" title="【后端】Spring Boot详解：企业级Java开发框架">
                        <span class="hidden-mobile">【后端】Spring Boot详解：企业级Java开发框架</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    

  

</div>

  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script  src="https://lib.baomitu.com/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js" ></script>

  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>




  
<script src="/js/custom.js"></script>
<script src="/js/ai-assistant.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mermaid@9.4.0/dist/mermaid.min.js"></script>



<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
